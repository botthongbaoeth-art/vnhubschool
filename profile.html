<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªì S∆° | HubSchool Pro</title>
    
    <!-- 1. TAILWIND CSS & CONFIG -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { main: '#0f0f1a', sidebar: '#151521', card: '#1e1e2d', hover: '#2a2a3c', border: '#323248' },
                        brand: { primary: '#3699ff', secondary: '#00d2ff', purple: '#8950fc', gold: '#ffa800', danger: '#f64e60', success: '#1bc5bd' }
                    },
                    boxShadow: {
                        'glow-blue': '0 0 20px rgba(54, 153, 255, 0.15)',
                        'glow-gold': '0 0 20px rgba(255, 168, 0, 0.15)',
                    },
                    fontFamily: { sans: ['Montserrat', 'ui-sans-serif', 'system-ui'] }
                }
            }
        }
    </script>

    <!-- 2. ICONS & FONTS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; }
        /* Animation cho Modal */
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #323248; border-radius: 3px; }
    </style>
</head>
<body class="bg-dark-main text-gray-300 min-h-screen pb-20 selection:bg-brand-primary selection:text-white">

    <!-- NAVIGATION (Transparent Absolute) -->
    <nav class="absolute top-0 left-0 w-full z-50 p-6 flex items-center justify-between">
        <button onclick="window.location.href='index.html'" class="bg-black/30 backdrop-blur-md hover:bg-black/50 text-white px-5 py-2.5 rounded-full font-bold transition flex items-center gap-2 border border-white/10">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
        </button>
        <div class="hidden md:flex items-center gap-2 bg-black/30 backdrop-blur-md px-4 py-2 rounded-full border border-white/10">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            <span class="text-xs font-bold text-white">ƒêang ho·∫°t ƒë·ªông</span>
        </div>
    </nav>

    <!-- HEADER & COVER -->
    <div class="relative">
        <!-- Cover Photo -->
        <div class="h-64 md:h-80 w-full bg-gradient-to-r from-brand-purple via-brand-primary to-brand-secondary relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
            <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-dark-main to-transparent"></div>
        </div>

        <!-- Profile Info Container -->
        <div class="max-w-6xl mx-auto px-6 relative -mt-24 z-10 flex flex-col md:flex-row items-end md:items-end gap-6 mb-8">
            <!-- Avatar -->
            <div class="relative group">
                <div class="w-36 h-36 md:w-44 md:h-44 rounded-full p-1.5 bg-dark-main">
                    <div id="currentAvatar" class="w-full h-full rounded-full bg-dark-card flex items-center justify-center text-6xl shadow-2xl border-4 border-dark-card">U</div>
                </div>
                <!-- VIP Badge -->
                <div id="verifiedBadge" class="hidden absolute bottom-2 right-2 bg-brand-secondary text-white w-10 h-10 rounded-full items-center justify-center border-4 border-dark-main shadow-lg" title="ƒê√£ x√°c minh">
                    <i class="fas fa-check"></i>
                </div>
            </div>

            <!-- Name & Bio -->
            <div class="flex-1 pb-4 text-center md:text-left">
                <div class="flex flex-col md:flex-row items-center md:items-end gap-3 mb-2">
                    <h1 id="fullnameDisplay" class="text-3xl md:text-4xl font-bold text-white">ƒêang t·∫£i...</h1>
                    <span id="roleBadge" class="hidden px-3 py-1 bg-brand-primary/20 text-brand-primary border border-brand-primary/30 rounded-full text-xs font-bold uppercase tracking-wider mb-1">Creator</span>
                </div>
                <p id="usernameDisplay" class="text-gray-400 font-medium mb-2">@username</p>
                <p id="bioDisplay" class="text-gray-300 max-w-xl text-sm md:text-base bg-dark-card/50 backdrop-blur-sm p-3 rounded-xl border border-white/5 inline-block text-left">
                    Ch∆∞a c√≥ gi·ªõi thi·ªáu.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pb-4 w-full md:w-auto">
                <button onclick="openEditModal()" class="flex-1 md:flex-none py-3 px-6 bg-brand-primary text-white font-bold rounded-xl shadow-glow-blue hover:bg-blue-600 transition flex items-center justify-center gap-2">
                    <i class="fas fa-pen"></i> <span class="hidden md:inline">Ch·ªânh s·ª≠a</span>
                </button>
                <button onclick="openPasswordModal()" class="py-3 px-4 bg-dark-card text-gray-300 border border-dark-border rounded-xl hover:bg-dark-hover hover:text-white transition">
                    <i class="fas fa-key"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN GRID CONTENT -->
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-8 pb-10">
        
        <!-- LEFT COLUMN: Personal Info -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-dark-card rounded-2xl p-6 border border-dark-border">
                <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-user-circle text-brand-purple"></i> Th√¥ng tin c√° nh√¢n
                </h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-dark-main/50 border border-dark-border/50">
                        <div class="w-10 h-10 rounded-full bg-brand-secondary/10 text-brand-secondary flex items-center justify-center"><i class="fas fa-envelope"></i></div>
                        <div class="overflow-hidden">
                            <p class="text-xs text-gray-500 font-bold uppercase">Email</p>
                            <p id="emailDisplay" class="text-sm text-white truncate">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-dark-main/50 border border-dark-border/50">
                        <div class="w-10 h-10 rounded-full bg-brand-gold/10 text-brand-gold flex items-center justify-center"><i class="fas fa-school"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase">Tr∆∞·ªùng h·ªçc</p>
                            <p id="schoolDisplay" class="text-sm text-white">Ch∆∞a c·∫≠p nh·∫≠t</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-dark-main/50 border border-dark-border/50">
                        <div class="w-10 h-10 rounded-full bg-brand-danger/10 text-brand-danger flex items-center justify-center"><i class="fas fa-users-class"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase">L·ªõp</p>
                            <p id="classDisplay" class="text-sm text-white">Ch∆∞a c·∫≠p nh·∫≠t</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 p-3 rounded-xl bg-dark-main/50 border border-dark-border/50">
                        <div class="w-10 h-10 rounded-full bg-brand-purple/10 text-brand-purple flex items-center justify-center"><i class="fas fa-heart"></i></div>
                        <div>
                            <p class="text-xs text-gray-500 font-bold uppercase">S·ªü th√≠ch</p>
                            <p id="interestsDisplay" class="text-sm text-white">Ch∆∞a c·∫≠p nh·∫≠t</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mini Banner (Optional) -->
            <div class="bg-gradient-to-br from-brand-primary to-blue-800 rounded-2xl p-6 text-center text-white relative overflow-hidden">
                <i class="fas fa-crown absolute -right-6 -bottom-6 text-9xl text-white/10"></i>
                <h3 class="font-bold text-xl relative z-10">N√¢ng c·∫•p VIP</h3>
                <p class="text-sm text-blue-100 mt-2 mb-4 relative z-10">M·ªü kh√≥a to√†n b·ªô t√≠nh nƒÉng v√† X2 XP m·ªói ng√†y.</p>
                <button class="bg-white text-brand-primary px-6 py-2 rounded-xl font-bold text-sm hover:bg-blue-50 transition relative z-10" onclick="window.location.href='index.html'">Xem C·ª≠a H√†ng</button>
            </div>
        </div>

        <!-- RIGHT COLUMN: Stats & Achievements -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Statistics Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-dark-card p-4 rounded-2xl border border-dark-border text-center hover:border-brand-danger transition group">
                    <i class="fas fa-fire text-3xl text-gray-600 group-hover:text-brand-danger transition mb-2"></i>
                    <h4 id="streakDisplay" class="text-2xl font-bold text-white">0</h4>
                    <p class="text-xs text-gray-500 uppercase font-bold">Ng√†y Streak</p>
                </div>
                <div class="bg-dark-card p-4 rounded-2xl border border-dark-border text-center hover:border-brand-gold transition group">
                    <i class="fas fa-bolt text-3xl text-gray-600 group-hover:text-brand-gold transition mb-2"></i>
                    <h4 id="xpDisplay" class="text-2xl font-bold text-white">0</h4>
                    <p class="text-xs text-gray-500 uppercase font-bold">T·ªïng XP</p>
                </div>
                <div class="bg-dark-card p-4 rounded-2xl border border-dark-border text-center hover:border-brand-secondary transition group">
                    <i class="fas fa-layer-group text-3xl text-gray-600 group-hover:text-brand-secondary transition mb-2"></i>
                    <h4 id="lvlDisplay" class="text-2xl font-bold text-white">1</h4>
                    <p class="text-xs text-gray-500 uppercase font-bold">Level</p>
                </div>
                <div class="bg-dark-card p-4 rounded-2xl border border-dark-border text-center hover:border-brand-purple transition group">
                    <i class="fas fa-trophy text-3xl text-gray-600 group-hover:text-brand-purple transition mb-2"></i>
                    <h4 class="text-2xl font-bold text-white">--</h4>
                    <p class="text-xs text-gray-500 uppercase font-bold">H·∫°ng</p>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="bg-dark-card rounded-2xl border border-dark-border p-6">
                <h3 class="text-white font-bold text-lg mb-6 flex items-center justify-between">
                    <span><i class="fas fa-medal text-brand-gold mr-2"></i> Th√†nh t√≠ch n·ªïi b·∫≠t</span>
                    <span class="text-xs bg-dark-main px-3 py-1 rounded-full border border-dark-border text-gray-400">ƒêang c·∫≠p nh·∫≠t</span>
                </h3>

                <div class="space-y-6">
                    <!-- Achievement 1 -->
                    <div class="flex gap-4 items-center">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-orange-400 to-red-500 flex flex-col items-center justify-center text-white shadow-lg shrink-0">
                            <i class="fas fa-fire text-xl mb-1"></i>
                            <span class="text-[10px] font-bold">C·∫§P 1</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <h4 class="font-bold text-white">L·ª≠a R·ª´ng</h4>
                                <span class="text-xs text-brand-danger font-bold">1/3 Ng√†y</span>
                            </div>
                            <p class="text-xs text-gray-400 mb-2">ƒê·∫°t chu·ªói 3 ng√†y h·ªçc li√™n ti·∫øp.</p>
                            <div class="h-2 w-full bg-dark-main rounded-full overflow-hidden">
                                <div class="h-full bg-brand-danger w-[33%]"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement 2 -->
                    <div class="flex gap-4 items-center">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-yellow-300 to-yellow-600 flex flex-col items-center justify-center text-white shadow-lg shrink-0">
                            <i class="fas fa-hat-wizard text-xl mb-1"></i>
                            <span class="text-[10px] font-bold">C·∫§P 1</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <h4 class="font-bold text-white">Cao Nh√¢n</h4>
                                <span class="text-xs text-brand-gold font-bold"><span id="xpDisplaySmall">0</span> XP</span>
                            </div>
                            <p class="text-xs text-gray-400 mb-2">T√≠ch l≈©y kinh nghi·ªám h·ªçc t·∫≠p.</p>
                            <div class="h-2 w-full bg-dark-main rounded-full overflow-hidden">
                                <div class="h-full bg-brand-gold w-[5%]"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement 3 -->
                    <div class="flex gap-4 items-center opacity-75">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-400 to-purple-700 flex flex-col items-center justify-center text-white shadow-lg shrink-0">
                            <i class="fas fa-feather-alt text-xl mb-1"></i>
                            <span class="text-[10px] font-bold">C·∫§P 1</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <h4 class="font-bold text-white">Qu√°n Qu√¢n</h4>
                                <span class="text-xs text-gray-500 font-bold">Ch∆∞a ƒë·∫°t</span>
                            </div>
                            <p class="text-xs text-gray-400 mb-2">L·ªçt v√†o Top 10 B·∫£ng x·∫øp h·∫°ng.</p>
                            <div class="h-2 w-full bg-dark-main rounded-full overflow-hidden">
                                <div class="h-full bg-brand-purple w-[0%]"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ==================== MODALS ==================== -->

    <!-- Edit Profile Modal -->
    <div id="editModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-dark-card w-full max-w-lg rounded-3xl p-6 border border-dark-border relative modal-animate shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-dark-border pb-4">
                <h3 class="text-xl font-bold text-white">Ch·ªânh s·ª≠a h·ªì s∆°</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <!-- Avatar Picker -->
            <label class="block text-sm font-bold text-gray-400 mb-3">Ch·ªçn Avatar</label>
            <div class="flex gap-3 overflow-x-auto pb-4 mb-4 scrollbar-hide">
                <button onclick="setAvatar('üë¶')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">üë¶</button>
                <button onclick="setAvatar('üëß')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">üëß</button>
                <button onclick="setAvatar('ü¶ä')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">ü¶ä</button>
                <button onclick="setAvatar('ü¶Å')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">ü¶Å</button>
                <button onclick="setAvatar('ü¶Ñ')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">ü¶Ñ</button>
                <button onclick="setAvatar('üî•')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">üî•</button>
                <button onclick="setAvatar('ü§ñ')" class="w-12 h-12 rounded-xl bg-dark-main border border-dark-border text-2xl flex items-center justify-center hover:bg-brand-primary hover:border-brand-primary transition shrink-0">ü§ñ</button>
            </div>
            <input type="hidden" id="avatarInput">

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">T√™n hi·ªÉn th·ªã</label>
                    <input type="text" id="editFullname" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username <span class="text-brand-danger text-[10px] normal-case ml-1">*Duy nh·∫•t</span></label>
                    <input type="text" id="editUsername" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ti·ªÉu s·ª≠</label>
                    <textarea id="editBio" rows="2" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tr∆∞·ªùng</label>
                        <input type="text" id="editSchool" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">L·ªõp</label>
                        <input type="text" id="editClass" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªü th√≠ch</label>
                    <input type="text" id="editInterests" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
            </div>

            <button class="btn-edit btn-primary w-full mt-6 py-3 rounded-xl bg-brand-primary text-white font-bold hover:bg-blue-600 transition shadow-lg" onclick="saveProfile()">L∆∞u Thay ƒê·ªïi</button>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-dark-card w-full max-w-md rounded-3xl p-6 border border-dark-border relative modal-animate shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-6 text-center">ƒê·ªïi M·∫≠t Kh·∫©u</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">M·∫≠t kh·∫©u c≈©</label>
                    <input type="password" id="oldPass" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPass" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirmPass" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary transition">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('passModal').style.display='none'" class="flex-1 py-3 bg-dark-main border border-dark-border text-gray-400 font-bold rounded-xl hover:bg-white hover:text-black transition">H·ªßy</button>
                <button onclick="changePassword()" class="flex-1 py-3 bg-brand-primary text-white font-bold rounded-xl hover:bg-blue-600 transition shadow-lg">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>


    <!-- ==================== LOGIC JAVASCRIPT ==================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let uid = null;
        let userEmail = "";
        let currentUser = null;
        let currentUsername = "";
        let lastUsernameChange = 0;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                uid = user.uid;
                userEmail = user.email;
                document.getElementById('emailDisplay').innerText = userEmail;

                const snap = await getDoc(doc(db, "users", uid));
                let data = {};
                if(snap.exists()) {
                    data = snap.data();
                }
                
                // Fill Display
                document.getElementById('fullnameDisplay').innerText = data.fullname || "Ng∆∞·ªùi d√πng";
                document.getElementById('usernameDisplay').innerText = "@" + (data.username || "chua_dat_ten");
                document.getElementById('schoolDisplay').innerText = data.school || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('classDisplay').innerText = data.class || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('interestsDisplay').innerText = data.interests || "Ch∆∞a c·∫≠p nh·∫≠t";
                document.getElementById('bioDisplay').innerText = data.bio || "H√£y vi·∫øt g√¨ ƒë√≥ v·ªÅ b·∫£n th√¢n...";
                
                const avatarChar = data.avatarEmoji || (data.fullname ? data.fullname.charAt(0) : "U");
                document.getElementById('currentAvatar').innerText = avatarChar;

                // Stats
                document.getElementById('xpDisplay').innerText = data.xp || 0;
                document.getElementById('xpDisplaySmall').innerText = data.xp || 0;
                document.getElementById('lvlDisplay').innerText = data.level || 1;

                // VERIFIED CHECK
                const verifiedEmails = ["lenhancute1@gmail.com", "bot.thongbaoeth@gmail.com"];
                if (verifiedEmails.includes(userEmail) || data.username === "adminisme" || data.username === "lenhanzxc") {
                    document.getElementById('verifiedBadge').classList.remove('hidden');
                    document.getElementById('verifiedBadge').classList.add('flex');
                    document.getElementById('roleBadge').classList.remove('hidden');
                    document.getElementById('roleBadge').classList.add('inline-block');
                }

                // Fill Edit Form
                document.getElementById('editFullname').value = data.fullname || "";
                document.getElementById('editUsername').value = data.username || "";
                currentUsername = data.username || "";
                lastUsernameChange = data.lastUsernameChange || 0;

                document.getElementById('editBio').value = data.bio || "";
                document.getElementById('editSchool').value = data.school || "";
                document.getElementById('editClass').value = data.class || "";
                document.getElementById('editInterests').value = data.interests || "";
                document.getElementById('avatarInput').value = avatarChar;

                // Streak Logic
                const today = new Date().toISOString().split('T')[0];
                let streak = data.streak || 0;
                const lastLogin = data.lastLoginDate || "";

                if (lastLogin !== today) {
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    if (lastLogin === yesterday) {
                        streak++;
                    } else if (lastLogin !== "") {
                         streak = 1; // Reset
                    } else {
                        streak = 1; // First time
                    }
                    await setDoc(doc(db, "users", uid), { streak: streak, lastLoginDate: today }, { merge: true });
                }
                document.getElementById('streakDisplay').innerText = streak;

            } else {
                window.location.href = 'login.html';
            }
        });

        // UI Handlers (Tailwind style display)
        window.openEditModal = () => {
            const m = document.getElementById('editModal');
            m.classList.remove('hidden'); m.classList.add('flex');
        }
        window.closeEditModal = () => {
            const m = document.getElementById('editModal');
            m.classList.add('hidden'); m.classList.remove('flex');
        }
        window.openPasswordModal = () => {
            const m = document.getElementById('passModal');
            m.classList.remove('hidden'); m.classList.add('flex');
        }

        window.setAvatar = (emoji) => {
            document.getElementById('avatarInput').value = emoji;
            // Visual feedback
            const current = document.getElementById('currentAvatar');
            current.innerText = emoji;
            // Animation nh·∫π
            current.classList.add('scale-110');
            setTimeout(() => current.classList.remove('scale-110'), 200);
        }

        window.saveProfile = async () => {
            const btn = document.querySelector('.btn-edit.btn-primary');
            const newUsername = document.getElementById('editUsername').value.trim();
            
            if(!newUsername) return alert("Username kh√¥ng ƒë∆∞·ª£c tr·ªëng!");
            if(!/^[a-z0-9_]+$/.test(newUsername)) return alert("Username ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi!");

            if(btn) {
                btn.innerText = "ƒêang x·ª≠ l√Ω...";
                btn.disabled = true;
                btn.classList.add('opacity-70');
            }

            const data = {
                fullname: document.getElementById('editFullname').value,
                bio: document.getElementById('editBio').value,
                school: document.getElementById('editSchool').value,
                class: document.getElementById('editClass').value,
                interests: document.getElementById('editInterests').value,
                avatarEmoji: document.getElementById('avatarInput').value
            };

            try {
                // Logic ƒë·ªïi Username
                if(newUsername !== currentUsername) {
                    const now = Date.now();
                    const oneWeek = 7 * 24 * 60 * 60 * 1000;
                    
                    if (now - lastUsernameChange < oneWeek) {
                        const daysLeft = Math.ceil((oneWeek - (now - lastUsernameChange)) / (24 * 60 * 60 * 1000));
                        throw new Error(`B·∫°n m·ªõi ƒë·ªïi t√™n g·∫ßn ƒë√¢y. Vui l√≤ng ch·ªù ${daysLeft} ng√†y n·ªØa.`);
                    }

                    // Check duplicate (best effort)
                    try {
                        const q = query(collection(db, "users"), where("username", "==", newUsername));
                        const snap = await getDocs(q);
                        if(!snap.empty) throw new Error("Username n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!");
                    } catch (permErr) {
                        console.warn("Skipped check duplicate due to permissions");
                    }

                    data.username = newUsername;
                    data.lastUsernameChange = now; 
                }

                await setDoc(doc(db, "users", uid), data, { merge: true });
                
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                window.location.reload();
            } catch(e) {
                console.error(e);
                alert("L·ªói: " + e.message);
                if(btn) {
                    btn.innerText = "L∆∞u Thay ƒê·ªïi";
                    btn.disabled = false;
                    btn.classList.remove('opacity-70');
                }
            }
        }

        window.changePassword = async () => {
            const oldP = document.getElementById('oldPass').value;
            const newP = document.getElementById('newPass').value;
            const confP = document.getElementById('confirmPass').value;

            if (!oldP || !newP) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            if (newP !== confP) return alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!");
            if (newP.length < 6) return alert("M·∫≠t kh·∫©u m·ªõi qu√° ng·∫Øn (min 6 k√Ω t·ª±)!");
            
            try {
                const cred = EmailAuthProvider.credential(currentUser.email, oldP);
                await reauthenticateWithCredential(currentUser, cred);
                await updatePassword(currentUser, newP);
                alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                auth.signOut().then(() => window.location.href='login.html');
            } catch(e) {
                alert("L·ªói: M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng.");
            }
        }
    </script>
</body>
</html>
