<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard | HighSchool Hub</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2997/2997320.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6C63FF; --secondary: #00D2FF; --accent: #FF2E63;
            --gold: #FFD700; --dark: #0f172a; --dark-light: #1e293b;
            --text: #f1f5f9; --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark); color: var(--text); overflow-x: hidden; padding-bottom: 80px; }

        /* LOADING */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* LAYOUT */
        .wrapper { display: flex; }
        .sidebar { width: 260px; height: 100vh; background: rgba(15, 23, 42, 0.95); border-right: 1px solid rgba(255,255,255,0.05); padding: 30px 20px; position: fixed; display: flex; flex-direction: column; z-index: 100; transition: 0.3s; }
        .brand { font-size: 1.8rem; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 50px; display: flex; gap: 10px; align-items: center; }
        .nav-item { padding: 16px 20px; margin-bottom: 8px; border-radius: 15px; cursor: pointer; color: var(--text-muted); transition: 0.3s; font-weight: 600; display: flex; align-items: center; gap: 15px; }
        .nav-item:hover, .nav-item.active { background: rgba(108,99,255,0.15); color: var(--primary); border: 1px solid rgba(108,99,255,0.2); }
        .nav-item i { font-size: 1.2rem; width: 25px; }

        .main-content { margin-left: 260px; padding: 40px 5%; flex: 1; padding-top: calc(40px + var(--safe-top)); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .currency-badge { background: rgba(255,215,0,0.1); border: 1px solid var(--gold); color: var(--gold); padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; }

        /* PROFILE CARD */
        .profile-card { background: linear-gradient(135deg, rgba(108,99,255,0.15), rgba(0,210,255,0.15)); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; padding: 30px; display: flex; align-items: center; gap: 30px; margin-bottom: 40px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .avatar { width: 90px; height: 90px; border-radius: 50%; background: var(--gradient); display: flex; justify-content: center; align-items: center; font-size: 2.5rem; color: white; border: 4px solid var(--dark); font-weight: 700; }
        .xp-bar-container { width: 100%; max-width: 400px; margin-top: 10px; }
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: var(--gradient); width: 0%; border-radius: 10px; transition: 1s ease; }

        /* EXAM STYLES */
        .exam-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .exam-card { background: var(--dark-light); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .exam-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .exam-tag { position: absolute; top: 15px; right: 15px; background: rgba(255,46,99,0.2); color: var(--accent); padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
        .exam-icon { font-size: 2.5rem; margin-bottom: 15px; color: var(--secondary); }
        .exam-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted); margin: 10px 0 20px 0; }
        .exam-meta i { color: var(--primary); margin-right: 5px; }
        .btn-start-exam { width: 100%; padding: 12px; background: var(--gradient); border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-start-exam:hover { box-shadow: 0 5px 15px rgba(108,99,255,0.4); }

        /* EXAM INTERFACE (Hidden by default) */
        #examInterface { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark); z-index: 2000; overflow-y: auto; padding: 20px; }
        .exam-header { 
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(15,23,42,0.95); backdrop-filter: blur(10px);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 2001; 
        }
        .timer-box { font-size: 1.5rem; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 10px; background: rgba(255,46,99,0.1); padding: 8px 20px; border-radius: 50px; }
        
        .question-container { max-width: 800px; margin: 100px auto 50px auto; }
        .question-card { background: var(--dark-light); padding: 25px; border-radius: 20px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .q-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
        .q-options { display: grid; gap: 10px; }
        .q-option { 
            display: flex; align-items: center; padding: 15px; border-radius: 12px; 
            background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .q-option:hover { background: rgba(255,255,255,0.08); }
        .q-option input { margin-right: 15px; accent-color: var(--primary); transform: scale(1.2); }
        .q-option.selected { border-color: var(--primary); background: rgba(108,99,255,0.1); }

        .btn-submit-exam { 
            position: fixed; bottom: 30px; right: 30px; padding: 15px 30px; 
            background: #00c853; color: white; border: none; border-radius: 50px; 
            font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 20px rgba(0,200,83,0.4); 
            z-index: 2002;
        }

        /* MOBILE NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); padding: 10px 20px; justify-content: space-between; z-index: 999; padding-bottom: calc(10px + var(--safe-bottom)); }
        .m-nav-item { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; padding: 10px; cursor: pointer; }
        .m-nav-item.active { color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; padding-bottom: 100px; }
            .mobile-nav { display: flex; }
            .exam-grid { grid-template-columns: 1fr; }
            .timer-box { font-size: 1.2rem; padding: 5px 15px; }
            .btn-submit-exam { bottom: 80px; right: 20px; width: calc(100% - 40px); text-align: center; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner"></div><p style="margin-top:20px;">Đang tải dữ liệu...</p></div>

    <div class="wrapper">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i> HubSchool</div>
            <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> Tổng Quan</div>
            <div class="nav-item" onclick="switchTab('exam')"><i class="fas fa-file-signature"></i> Thi Thử</div>
            <div class="nav-item" onclick="switchTab('shop')"><i class="fas fa-store"></i> Cửa Hàng</div>
            <div class="nav-item" onclick="window.location.href='news.html'"><i class="fas fa-newspaper"></i> Bảng Tin</div>
            <div class="nav-item" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i> Hồ Sơ</div>
            <div class="nav-item" onclick="logout()" style="margin-top: auto; color: var(--accent);"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</div>
        </nav>

        <!-- MAIN -->
        <div class="main-content">
            <div class="top-bar">
                <h2 id="pageTitle">Tổng Quan</h2>
                <div class="currency-badge">
                    <i class="fas fa-coins"></i> <span id="userXu">0</span>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content">
                <div class="profile-card" onclick="window.location.href='profile.html'">
                    <div class="avatar" id="userAvatar">U</div>
                    <div style="flex:1;">
                        <h2 id="userName">Đang tải...</h2>
                        <p id="userBio" style="color:var(--text-muted); font-size:0.9rem;">Chưa có tiểu sử</p>
                        <div class="xp-bar-container">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                                <span>LV.<span id="userLv">1</span></span>
                                <span><span id="userXp">0</span> XP</span>
                            </div>
                            <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar"></div></div>
                        </div>
                    </div>
                </div>
                <h3 style="margin-bottom: 20px;">Đề xuất hôm nay</h3>
                <div class="exam-grid">
                    <!-- Highligh New Exam -->
                    <div class="exam-card" style="border-color: var(--gold);">
                        <span class="exam-tag" style="background: rgba(255, 215, 0, 0.2); color: var(--gold);">HOT</span>
                        <i class="fas fa-graduation-cap exam-icon" style="color: var(--gold);"></i>
                        <h3>Toán 12 - Cuối Kỳ 1</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin: 10px 0;">Đề thi chuẩn 90 phút - 40 Câu.</p>
                        <button class="btn-start-exam" onclick="startExam('math_12_hk1')">Làm Bài Ngay</button>
                    </div>
                    
                    <div class="exam-card" style="border-color: var(--secondary);">
                        <i class="fas fa-bolt exam-icon"></i>
                        <h3>Thi Thử Nhanh</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin: 10px 0;">Bài kiểm tra ngẫu nhiên 15 phút.</p>
                        <button class="btn-start-exam" onclick="startExam('random')">Bắt Đầu</button>
                    </div>
                </div>
            </div>

            <!-- EXAM TAB -->
            <div id="tab-exam" class="tab-content" style="display:none;">
                <h3 style="margin-bottom: 20px;">Danh Sách Đề Thi THPTQG</h3>
                <div class="exam-grid" id="examListContainer">
                    <!-- Exam items rendered by JS -->
                </div>
            </div>

            <!-- SHOP TAB -->
            <div id="tab-shop" class="tab-content" style="display:none;">
                <h3>Cửa Hàng Vật Phẩm</h3>
                <p style="color:var(--text-muted); margin-bottom:20px;">Dùng Xu để đổi lấy lợi thế học tập!</p>
                <!-- Shop content preserved -->
                <div style="text-align:center; padding:50px; background:var(--dark-light); border-radius:20px;">
                    <i class="fas fa-store" style="font-size:3rem; color:var(--text-muted); margin-bottom:15px;"></i>
                    <p>Tính năng Cửa hàng đang được cập nhật thêm vật phẩm...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- MOBILE NAV -->
    <div class="mobile-nav">
        <button class="m-nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i></button>
        <button class="m-nav-item" onclick="switchTab('exam')"><i class="fas fa-file-signature"></i></button>
        <button class="m-nav-item" onclick="window.location.href='news.html'"><i class="fas fa-newspaper"></i></button>
        <button class="m-nav-item" onclick="window.location.href='profile.html'"><i class="fas fa-user"></i></button>
    </div>

    <!-- EXAM INTERFACE (Overlay) -->
    <div id="examInterface">
        <div class="exam-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="quitExam()" style="background:transparent; border:none; color:white; font-size:1.2rem;"><i class="fas fa-arrow-left"></i> Thoát</button>
                <span id="examSubjectName" style="font-weight:700; margin-left:10px; display:none;">Toán</span>
            </div>
            <div class="timer-box">
                <i class="fas fa-clock"></i> <span id="examTimer">00:00</span>
            </div>
        </div>

        <div class="question-container" id="questionsList">
            <!-- Questions rendered here -->
        </div>

        <button class="btn-submit-exam" onclick="submitExam()">Nộp Bài <i class="fas fa-paper-plane"></i></button>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // AUTH CHECK
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.replace('login.html');
            }
        });

        async function loadUserData(uid) {
            const docSnap = await getDoc(doc(db, "users", uid));
            if(docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('userName').innerText = data.fullname || "Học viên";
                document.getElementById('userAvatar').innerText = (data.fullname || "U").charAt(0).toUpperCase();
                document.getElementById('userXu').innerText = data.xu || 0;
                document.getElementById('userLv').innerText = data.level || 1;
                document.getElementById('userXp').innerText = data.xp || 0;
                document.getElementById('userBio').innerText = data.bio || "Chưa có tiểu sử";
                
                const nextLevel = (data.level || 1) * 1000;
                const percent = Math.min(((data.xp || 0) / nextLevel) * 100, 100);
                document.getElementById('xpBar').style.width = percent + "%";
            }
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(()=>document.getElementById('loadingOverlay').style.display='none', 500);
        }

        // --- EXAM DATA ---
        const EXAM_DATA = [
            {
                id: 'math_12_hk1',
                title: 'Toán 12 - Cuối Kỳ 1',
                time: 90,
                xp: 200,
                difficulty: 'Khó',
                questions: [
                    { q: "Cho f(x) = 2x^2 - 3x + 1. Giá trị của f(2) là:", opts: ["3", "5", "7", "9"], ans: 0 },
                    { q: "Tìm giá trị của biểu thức √16 + 2√9 - 3", opts: ["7", "10", "12", "14"], ans: 0 },
                    { q: "Tìm đạo hàm của hàm số f(x) = x^3 - 4x + 2", opts: ["3x^2 - 4", "3x^2 + 4", "3x^2 - 2", "2x^2 - 4"], ans: 0 },
                    { q: "Đạo hàm của hàm số f(x) = sin(x) là:", opts: ["cos(x)", "-cos(x)", "sin(x)", "-sin(x)"], ans: 0 },
                    { q: "Phương trình bậc hai ax^2 + bx + c = 0 có hai nghiệm phân biệt khi:", opts: ["b^2 - 4ac > 0", "b^2 - 4ac = 0", "b^2 - 4ac < 0", "a ≠ 0"], ans: 0 },
                    { q: "Tìm x: 2x - 3 = 5x + 6", opts: ["x = -3", "x = 3", "x = -5", "x = 5"], ans: 0 },
                    { q: "Độ dài đoạn thẳng AB với A(1,2) và B(3,4) là:", opts: ["2", "2√2", "√8", "10√10"], ans: 1 },
                    { q: "Cho tan(θ) = 1. Giá trị của θ là:", opts: ["π/4", "π/2", "π/3", "π/6"], ans: 0 },
                    { q: "Tính ∫x^2 dx", opts: ["1/3 x^3 + C", "1/2 x^3 + C", "1/3 x^3", "1/2 x^3"], ans: 0 },
                    { q: "Giá trị của sin(30°)", opts: ["√3/2", "1/2", "1", "√2/2"], ans: 1 },
                    { q: "GTLN của hàm số f(x) = -x^2 + 4x - 3", opts: ["0", "1", "3", "5"], ans: 1 },
                    { q: "Biểu thức nào sau đây đúng?", opts: ["√(a+b) = √a + √b", "√(a+b) = √ab", "√(ab) = √a√b", "Không có biểu thức nào đúng"], ans: 3 },
                    { q: "Diện tích hình vuông cạnh 4 cm", opts: ["16 cm²", "8 cm²", "4 cm²", "2 cm²"], ans: 0 },
                    { q: "Cho log₂16 = x. Tìm x", opts: ["4", "2", "8", "5"], ans: 0 },
                    { q: "Tính ∫[0,1] x^2 dx", opts: ["1/3", "1/4", "1/2", "1"], ans: 0 },
                    { q: "Giải cos(x) = 0 trong [0, 2π]", opts: ["π/2, 3π/2", "0, π", "π/3, 2π/3", "π/4, 3π/4"], ans: 0 },
                    { q: "Cực trị của f(x) = x^3 - 6x + 2", opts: ["x=1, x=-2", "x=-1, x=2", "x=1, x=-1", "x=2, x=-2"], ans: 3 },
                    { q: "2x + 5 = 15. Tìm x", opts: ["5", "10", "2", "0"], ans: 0 },
                    { q: "log₃9 = ?", opts: ["3", "2", "1", "4"], ans: 1 },
                    { q: "∫cos(x) dx", opts: ["sin(x) + C", "-sin(x) + C", "cos(x) + C", "-cos(x) + C"], ans: 0 },
                    // Phần II: Đúng Sai
                    { q: "Đạo hàm của f(x)=x^4-4x+3 tại x=2 là 0?", opts: ["Đúng", "Sai"], ans: 1 },
                    { q: "sin(45°) = √2/2?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "x^2 + 4x + 5 = 0 có 2 nghiệm thực?", opts: ["Đúng", "Sai"], ans: 1 },
                    { q: "Đạo hàm của cos(x) là -sin(x)?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "Số phức z=2+3i có phần thực 2, ảo 3?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "PT bậc 2: ax^2+bx+c=0 (a≠0)?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "tan(θ)=1 => θ=π/4?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "Diện tích tròn r=6 là 36π?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "x^2 - 2x + 2 = 0 có nghiệm phức?", opts: ["Đúng", "Sai"], ans: 0 },
                    { q: "∫[0,1] x^3 dx = 1/4?", opts: ["Đúng", "Sai"], ans: 0 }
                ]
            },
            {
                id: 'phy_12',
                title: 'Vật Lý 12 - Dao Động Cơ',
                time: 20,
                xp: 80,
                difficulty: 'Dễ',
                questions: [
                    { q: "Một vật dao động điều hòa với chu kì T. Động năng của vật biến thiên tuần hoàn với chu kì:", opts: ["T", "T/2", "2T", "T/4"], ans: 1 },
                    { q: "Công thức tính chu kì dao động của con lắc đơn là:", opts: ["T = 2π√(l/g)", "T = 2π√(g/l)", "T = √(l/g)", "T = 2π√(m/k)"], ans: 0 },
                    { q: "Trong dao động điều hòa, gia tốc biến đổi:", opts: ["Cùng pha với li độ", "Ngược pha với li độ", "Vuông pha với vận tốc", "Trễ pha π/2 so với li độ"], ans: 1 },
                    { q: "Biên độ dao động cưỡng bức KHÔNG phụ thuộc vào:", opts: ["Biên độ ngoại lực", "Tần số ngoại lực", "Pha ban đầu của ngoại lực", "Lực cản môi trường"], ans: 2 }
                ]
            },
            {
                id: 'eng_12',
                title: 'Tiếng Anh 12 - Tổng Hợp',
                time: 15,
                xp: 70,
                difficulty: 'Dễ',
                questions: [
                    { q: "Choose the correct answer: He _______ since he graduated.", opts: ["has been working", "works", "is working", "worked"], ans: 0 },
                    { q: "She asked me _______ I liked pop music.", opts: ["weather", "if", "did", "that"], ans: 1 },
                    { q: "The book _______ I bought yesterday is interesting.", opts: ["who", "whom", "which", "whose"], ans: 2 },
                    { q: "Synonym of 'Dangerous':", opts: ["Safe", "Risky", "Calm", "Secure"], ans: 1 }
                ]
            }
        ];

        // RENDER EXAM LIST
        const examList = document.getElementById('examListContainer');
        EXAM_DATA.forEach(exam => {
            const card = document.createElement('div');
            card.className = 'exam-card';
            const iconClass = exam.id.includes('math') ? 'fa-square-root-alt' : (exam.id.includes('phy') ? 'fa-atom' : 'fa-language');
            
            card.innerHTML = `
                <span class="exam-tag">${exam.difficulty}</span>
                <i class="fas ${iconClass} exam-icon"></i>
                <h3 style="font-size:1.1rem; font-weight:700;">${exam.title}</h3>
                <div class="exam-meta">
                    <span><i class="fas fa-clock"></i> ${exam.time} phút</span>
                    <span><i class="fas fa-star"></i> +${exam.xp} XP</span>
                </div>
                <button class="btn-start-exam" onclick="window.startExam('${exam.id}')">Làm Bài Ngay</button>
            `;
            examList.appendChild(card);
        });

        // --- EXAM LOGIC ---
        let currentExam = null;
        let timerInterval = null;
        let userAnswers = {};

        window.startExam = (examId) => {
            const exam = EXAM_DATA.find(e => e.id === examId) || EXAM_DATA[0]; // Default random fallback
            currentExam = exam;
            userAnswers = {};
            
            // UI Setup
            document.getElementById('examInterface').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Disable scroll
            document.getElementById('examSubjectName').innerText = exam.title;
            
            // Render Questions
            const qContainer = document.getElementById('questionsList');
            qContainer.innerHTML = '';
            
            exam.questions.forEach((q, idx) => {
                const qCard = document.createElement('div');
                qCard.className = 'question-card';
                qCard.innerHTML = `
                    <div class="q-title">Câu ${idx + 1}: ${q.q}</div>
                    <div class="q-options">
                        ${q.opts.map((opt, oid) => `
                            <label class="q-option" onclick="this.querySelector('input').click();">
                                <input type="radio" name="q${idx}" value="${oid}" onchange="window.selectAnswer(${idx}, ${oid})">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                qContainer.appendChild(qCard);
            });

            // Start Timer
            let timeLeft = exam.time * 60;
            updateTimerDisplay(timeLeft);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Hết giờ! Hệ thống sẽ tự động nộp bài.");
                    window.submitExam();
                }
            }, 1000);
        }

        window.selectAnswer = (qIdx, optIdx) => {
            userAnswers[qIdx] = optIdx;
            // Highlight selected visual logic can be added here
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('examTimer');
            timerEl.innerText = `${m}:${s}`;
            if(seconds < 60) timerEl.style.color = '#ff4757'; // Red alert
        }

        window.quitExam = () => {
            if(confirm("Bạn có chắc muốn thoát? Kết quả sẽ không được lưu.")) {
                clearInterval(timerInterval);
                document.getElementById('examInterface').style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        window.submitExam = async () => {
            clearInterval(timerInterval);
            
            // Calculate Score
            let correctCount = 0;
            currentExam.questions.forEach((q, idx) => {
                if(userAnswers[idx] === q.ans) correctCount++;
            });
            
            const score = (correctCount / currentExam.questions.length) * 10;
            const xpEarned = Math.floor((correctCount / currentExam.questions.length) * currentExam.xp);
            
            alert(`Kết quả: ${score.toFixed(1)} điểm\nBạn trả lời đúng ${correctCount}/${currentExam.questions.length} câu.\n+${xpEarned} XP!`);
            
            // Save to Firebase
            if(xpEarned > 0) {
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { 
                        xp: increment(xpEarned) 
                    });
                    loadUserData(currentUser.uid); // Refresh dashboard
                } catch(e) { console.error("Error saving score:", e); }
            }

            document.getElementById('examInterface').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // --- GLOBAL ACTIONS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            document.getElementById('pageTitle').innerText = 
                tabId === 'shop' ? 'Cửa Hàng' : (tabId === 'exam' ? 'Thi Thử' : 'Tổng Quan');
            
            // Update Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find nav item with onclick matching tabId
            // Simple workaround: just visual update
        }

        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>
