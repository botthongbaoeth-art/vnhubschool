<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HubSchool Pro | H·ªá Th·ªëng H·ªçc T·∫≠p</title>
    
    <!-- 1. TAILWIND CSS & CONFIG -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { main: '#0f0f1a', sidebar: '#151521', card: '#1e1e2d', hover: '#2a2a3c', border: '#323248' },
                        brand: { primary: '#3699ff', secondary: '#00d2ff', purple: '#8950fc', gold: '#ffa800', danger: '#f64e60', success: '#1bc5bd' }
                    },
                    boxShadow: {
                        'glow-blue': '0 0 15px rgba(54, 153, 255, 0.3)',
                        'glow-gold': '0 0 15px rgba(255, 168, 0, 0.3)',
                    },
                    fontFamily: { sans: ['Montserrat', 'ui-sans-serif', 'system-ui'] }
                }
            }
        }
    </script>

    <!-- 2. ICONS & FONTS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; overflow: hidden; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #323248; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3699ff; }

        /* Bamboo Loader Styles */
        #loadingOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .bamboo-container { width: 80px; height: 200px; position: relative; display: flex; flex-direction: column-reverse; align-items: center; margin-bottom: 20px; }
        .bamboo-joint { width: 30px; height: 0; opacity: 0; background: linear-gradient(90deg, #66BB6A 0%, #43A047 50%, #66BB6A 100%); border-radius: 4px; margin-bottom: 2px; animation: growJoint 0.4s ease-out forwards; }
        .bamboo-joint::before { content: ''; position: absolute; width: 34px; height: 4px; background: #1B5E20; border-radius: 5px; margin-left: -2px; margin-top: -2px; }
        .bamboo-leaf { position: absolute; width: 0; height: 0; background: #66BB6A; border-radius: 0 50% 50% 50%; opacity: 0; animation: growLeaf 0.4s ease-out forwards; }
        .j1 { animation-delay: 0.2s; height: 40px; } .j2 { animation-delay: 0.6s; height: 40px; } .j3 { animation-delay: 1.0s; height: 40px; } .j4 { animation-delay: 1.4s; height: 40px; }
        .l1 { top: 140px; left: 40px; transform: rotate(-20deg); animation-delay: 0.7s; } .l2 { top: 100px; right: 40px; transform: rotate(200deg); animation-delay: 1.1s; }
        @keyframes growJoint { to { height: 45px; opacity: 1; } } @keyframes growLeaf { to { width: 35px; height: 12px; opacity: 1; } }
        .loading-text { color: #66BB6A; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Glassmorphism */
        .glass-panel { background: rgba(30, 30, 45, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .active-nav { background: rgba(54, 153, 255, 0.1); color: #3699ff; border: 1px solid rgba(54, 153, 255, 0.2); }
        
        /* Shimmer Effect cho XP Bar */
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .shimmer-effect { position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 2s infinite; }

        /* Animation cho Modal */
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="bg-dark-main text-gray-300 h-screen flex overflow-hidden selection:bg-brand-primary selection:text-white">

    <!-- BAMBOO LOADING SCREEN -->
    <div id="loadingOverlay">
        <div class="bamboo-container">
            <div class="bamboo-leaf l1"></div> <div class="bamboo-leaf l2"></div>
            <div class="bamboo-joint j4"></div> <div class="bamboo-joint j3"></div> <div class="bamboo-joint j2"></div> <div class="bamboo-joint j1"></div>
        </div>
        <p class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- MOBILE OVERLAY (NEW) -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity xl:hidden" onclick="toggleMobileNav()"></div>

    <!-- ==================== LEFT SIDEBAR (260px) ==================== -->
    <!-- S·ª≠a ƒë·ªïi: Th√™m ID, thay ƒë·ªïi class hidden th√†nh fixed/transform ƒë·ªÉ h·ªó tr·ª£ mobile -->
    <aside id="mainSidebar" class="w-[260px] bg-dark-sidebar flex flex-col border-r border-dark-border z-50 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 xl:translate-x-0 xl:static xl:z-20">
        
        <div class="h-20 flex items-center justify-between px-6 border-b border-dark-border/50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-brand-primary to-brand-purple flex items-center justify-center text-white shadow-glow-blue">
                    <i class="fas fa-graduation-cap text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight">Hub<span class="text-brand-primary">School</span></h1>
            </div>
            <!-- Close Button for Mobile -->
            <button class="xl:hidden text-gray-400 hover:text-white" onclick="toggleMobileNav()">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Menu Ch√≠nh</p>
            <div class="nav-item active-nav flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer transition-all hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('dashboard'); toggleMobileNav()">
                <i class="fas fa-home w-6"></i> <span>T·ªïng Quan</span>
            </div>
            <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('library'); toggleMobileNav()">
                <i class="fas fa-folder-open w-6"></i> <span>Kho T√†i Li·ªáu</span>
            </div>
            <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('exam'); toggleMobileNav()">
                <i class="fas fa-file-signature w-6"></i> <span>Thi Th·ª≠</span>
            </div>
            <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('leaderboard'); toggleMobileNav()">
                <i class="fas fa-trophy w-6"></i> <span>B·∫£ng X·∫øp H·∫°ng</span>
            </div>
            <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('friends'); toggleMobileNav()">
                <i class="fas fa-users w-6"></i> <span>T√¨m B·∫°n</span>
            </div>
            <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('shop'); toggleMobileNav()">
                <i class="fas fa-store w-6"></i> <span>C·ª≠a H√†ng</span>
            </div>
            
            <div class="mt-auto border-t border-dark-border/50 pt-4 mt-4">
                <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-brand-danger hover:bg-brand-danger/10" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-6"></i> <span>ƒêƒÉng Xu·∫•t</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-dark-main">
        
        <!-- Header Sticky -->
        <header class="h-20 glass-panel flex items-center justify-between px-6 sticky top-0 z-30 shrink-0">
            <div class="flex items-center gap-4">
                <!-- Mobile Toggle Button (ƒê√£ s·ª≠a onclick) -->
                <button class="xl:hidden text-white text-xl p-2 hover:bg-white/10 rounded-lg transition" onclick="toggleMobileNav()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="pageTitle" class="text-xl font-bold text-white hidden md:block">T·ªïng Quan</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Coin Display -->
                <div class="flex items-center bg-dark-sidebar border border-brand-gold/30 px-3 py-1.5 rounded-full shadow-glow-gold cursor-pointer hover:scale-105 transition" onclick="openRechargeModal()">
                    <img src="https://cdn-icons-png.flaticon.com/512/11559/11559400.png" class="w-5 h-5 mr-2 animate-bounce">
                    <span id="userXu" class="text-brand-gold font-bold text-sm tracking-wide mr-2">0</span>
                    <i class="fas fa-plus-circle text-brand-gold text-xs"></i>
                </div>

                <!-- Noti Bell -->
                <button class="relative w-10 h-10 rounded-full bg-dark-hover flex items-center justify-center hover:bg-brand-primary hover:text-white transition-colors text-gray-400" onclick="toggleNotifPanel()">
                    <i class="fas fa-bell"></i>
                    <div id="notifCount" class="absolute top-0 right-0 w-4 h-4 bg-brand-danger text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</div>
                </button>
            </div>
        </header>

        <!-- Notification Panel Dropdown -->
        <div id="notifPanel" class="absolute top-20 right-6 w-80 bg-dark-card border border-dark-border rounded-xl shadow-2xl z-50 hidden flex-col max-h-96 overflow-y-auto transform origin-top-right transition-all">
            <div class="p-3 border-b border-dark-border font-bold text-white flex justify-between">
                <span>Th√¥ng B√°o</span> <span class="text-xs text-brand-primary cursor-pointer">ƒê√£ ƒë·ªçc</span>
            </div>
            <div id="notifList" class="flex flex-col">
                <div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT AREA -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            
            <!-- TAB: DASHBOARD -->
            <div id="tab-dashboard" class="tab-content block max-w-5xl mx-auto space-y-8">
                
                <!-- Hero Profile Card -->
                <div id="profileCard" class="bg-gradient-to-r from-dark-card to-[#232336] rounded-3xl p-6 md:p-8 border border-dark-border relative overflow-hidden shadow-2xl cursor-pointer group" onclick="window.location.href='profile.html'">
                    <div class="absolute right-0 top-0 w-96 h-96 bg-brand-primary/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>
                    
                    <div class="flex flex-col md:flex-row gap-6 relative z-10 items-center md:items-start">
                        <!-- Avatar -->
                        <div class="relative">
                            <div class="w-24 h-24 md:w-32 md:h-32 rounded-full p-1 bg-gradient-to-tr from-brand-gold to-brand-primary shadow-lg">
                                <div id="userAvatar" class="w-full h-full rounded-full bg-dark-card flex items-center justify-center text-4xl font-bold text-white overflow-hidden">U</div>
                            </div>
                            <div class="vip-crown absolute -top-2 -right-2 bg-brand-gold text-black w-8 h-8 rounded-full flex items-center justify-center border-2 border-dark-main hidden shadow-lg"><i class="fas fa-crown"></i></div>
                        </div>

                        <!-- Info -->
                        <div class="flex-1 text-center md:text-left space-y-2 w-full">
                            <div class="flex flex-col md:flex-row items-center gap-3">
                                <h2 id="userName" class="text-2xl md:text-3xl font-bold text-white">H·ªçc Vi√™n</h2>
                                <span id="userRankTitle" class="px-3 py-0.5 bg-brand-purple/20 text-brand-purple text-xs font-bold rounded-full border border-brand-purple/20">T·∫≠p S·ª±</span>
                            </div>
                            <p id="userBio" class="text-gray-400 text-sm italic">Ch∆∞a c√≥ ti·ªÉu s·ª≠</p>
                            
                            <!-- XP Bar -->
                            <div class="bg-dark-main p-3 rounded-xl border border-dark-border mt-4 w-full">
                                <div class="flex justify-between text-xs font-bold mb-1.5">
                                    <span class="text-brand-secondary">Level <span id="userLv">1</span></span>
                                    <span class="text-gray-400"><span id="userXp">0</span> XP</span>
                                </div>
                                <div class="h-2.5 bg-dark-sidebar rounded-full overflow-hidden relative">
                                    <div id="xpBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-brand-primary via-brand-secondary to-brand-purple w-[0%] rounded-full">
                                        <div class="shimmer-effect"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-primary/50 transition">
                        <i class="fas fa-fire text-brand-danger text-2xl mb-2"></i>
                        <span class="text-xl font-bold text-white">12</span>
                        <span class="text-xs text-gray-500">Ng√†y li√™n ti·∫øp</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-success/50 transition">
                        <i class="fas fa-check-circle text-brand-success text-2xl mb-2"></i>
                        <span class="text-xl font-bold text-white">85</span>
                        <span class="text-xs text-gray-500">B√†i ƒë√£ l√†m</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-gold/50 transition">
                        <i class="fas fa-star text-brand-gold text-2xl mb-2"></i>
                        <span class="text-xl font-bold text-white">Top 5%</span>
                        <span class="text-xs text-gray-500">H·∫°ng tu·∫ßn</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-purple/50 transition">
                        <i class="fas fa-clock text-brand-purple text-2xl mb-2"></i>
                        <span class="text-xl font-bold text-white">42h</span>
                        <span class="text-xs text-gray-500">Gi·ªù h·ªçc</span>
                     </div>
                </div>

                <!-- Recommendations -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span class="w-1 h-5 bg-brand-primary rounded-full"></span> ƒê·ªÅ xu·∫•t h√¥m nay</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Card 1 -->
                        <div class="bg-dark-card p-5 rounded-2xl border border-brand-gold/30 relative group hover:shadow-glow-gold hover:-translate-y-1 transition-all">
                            <span class="absolute top-3 right-3 bg-brand-gold text-black text-[10px] font-black px-2 py-0.5 rounded">HOT</span>
                            <div class="flex gap-4 mb-4">
                                <div class="w-14 h-14 rounded-xl bg-brand-gold/10 text-brand-gold flex items-center justify-center text-2xl"><i class="fas fa-graduation-cap"></i></div>
                                <div>
                                    <h4 class="text-lg font-bold text-white">To√°n 12 - Cu·ªëi K·ª≥ 1</h4>
                                    <div class="text-xs text-gray-400 mt-1 flex gap-3">
                                        <span><i class="far fa-file-alt"></i> 40 C√¢u</span> <span><i class="far fa-clock"></i> 90p</span>
                                    </div>
                                </div>
                            </div>
                            <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-brand-gold to-yellow-600 text-black font-bold shadow-lg text-sm" onclick="startExam('math_12_hk1')">L√†m B√†i Ngay</button>
                        </div>
                        <!-- Card 2 -->
                        <div class="bg-dark-card p-5 rounded-2xl border border-dark-border relative group hover:border-brand-primary/50 hover:shadow-glow-blue hover:-translate-y-1 transition-all">
                            <div class="flex gap-4 mb-4">
                                <div class="w-14 h-14 rounded-xl bg-brand-secondary/10 text-brand-secondary flex items-center justify-center text-2xl"><i class="fas fa-bolt"></i></div>
                                <div>
                                    <h4 class="text-lg font-bold text-white">Thi Th·ª≠ Nhanh</h4>
                                    <div class="text-xs text-gray-400 mt-1 flex gap-3">
                                        <span><i class="far fa-file-alt"></i> 10 C√¢u</span> <span><i class="far fa-clock"></i> 15p</span>
                                    </div>
                                </div>
                            </div>
                            <button class="w-full py-2.5 rounded-xl bg-brand-primary text-white font-bold shadow-lg shadow-brand-primary/30 text-sm" onclick="startExam('random')">B·∫Øt ƒê·∫ßu</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: LIBRARY -->
            <div id="tab-library" class="tab-content hidden max-w-5xl mx-auto">
                <div class="relative mb-6">
                    <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                    <input type="text" class="w-full bg-dark-card border border-dark-border rounded-full py-3 pl-12 pr-4 text-white focus:border-brand-primary outline-none" placeholder="T√¨m ki·∫øm t√†i li·ªáu..." oninput="filterDocs(this.value)">
                </div>
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 filter-tags">
                    <button class="filter-tag active px-4 py-2 bg-brand-primary text-white rounded-xl text-sm font-bold whitespace-nowrap" onclick="filterByTag('all', this)">T·∫•t c·∫£</button>
                    <button class="filter-tag px-4 py-2 bg-dark-card text-gray-400 rounded-xl text-sm font-bold whitespace-nowrap border border-dark-border hover:bg-dark-hover" onclick="filterByTag('To√°n', this)">To√°n</button>
                    <button class="filter-tag px-4 py-2 bg-dark-card text-gray-400 rounded-xl text-sm font-bold whitespace-nowrap border border-dark-border hover:bg-dark-hover" onclick="filterByTag('L√Ω', this)">V·∫≠t L√Ω</button>
                    <button class="filter-tag px-4 py-2 bg-dark-card text-gray-400 rounded-xl text-sm font-bold whitespace-nowrap border border-dark-border hover:bg-dark-hover" onclick="filterByTag('Anh', this)">Ti·∫øng Anh</button>
                </div>
                <div id="libraryContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- TAB: EXAM -->
            <div id="tab-exam" class="tab-content hidden max-w-5xl mx-auto">
                <div id="examListContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Exams injected by JS -->
                </div>
            </div>

            <!-- TAB: LEADERBOARD -->
            <div id="tab-leaderboard" class="tab-content hidden max-w-4xl mx-auto">
                <div class="bg-dark-card border border-dark-border rounded-2xl p-4">
                    <h3 class="text-xl font-bold text-white mb-4 text-center text-brand-gold"><i class="fas fa-trophy mr-2"></i> B·∫£ng X·∫øp H·∫°ng Top 50</h3>
                    <ul id="lbList" class="space-y-2">
                        <!-- LB Items injected by JS -->
                    </ul>
                </div>
            </div>

            <!-- TAB: FRIENDS -->
            <div id="tab-friends" class="tab-content hidden max-w-4xl mx-auto">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="friendSearchInput" class="flex-1 bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white outline-none focus:border-brand-primary" placeholder="Nh·∫≠p username (vd: nhan_cute)..." onkeypress="if(event.key==='Enter') searchFriend()">
                    <button class="bg-brand-primary text-white px-6 rounded-xl font-bold hover:bg-blue-600" onclick="searchFriend()">T√¨m</button>
                </div>
                <div id="friendResult" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- TAB: SHOP -->
            <div id="tab-shop" class="tab-content hidden max-w-5xl mx-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Static Items -->
                     <div class="bg-dark-card p-5 rounded-2xl border border-brand-gold flex flex-col items-center text-center relative overflow-hidden group">
                        <div class="absolute inset-0 bg-brand-gold/5"></div>
                        <span class="bg-brand-gold text-black text-xs font-bold px-2 py-1 rounded absolute top-3 right-3">VIP TU·∫¶N</span>
                        <div class="w-16 h-16 bg-brand-gold/20 text-brand-gold rounded-full flex items-center justify-center text-3xl mb-4"><i class="fas fa-star"></i></div>
                        <h3 class="text-lg font-bold text-white">H·ªôi Vi√™n (1 Tu·∫ßn)</h3>
                        <p class="text-xs text-gray-400 mb-4">M·ªü kh√≥a full ƒë·ªÅ thi, X2 XP</p>
                        <div class="mt-auto w-full">
                            <div class="text-brand-gold font-bold text-xl mb-3"><i class="fas fa-coins"></i> 150</div>
                            <button class="w-full py-2 bg-brand-gold text-black font-bold rounded-xl hover:bg-yellow-500" onclick="buyItem(150, 'G√≥i VIP 1 Tu·∫ßn', 'vip')">Mua Ngay</button>
                        </div>
                     </div>

                     <!-- Dynamic Items Container -->
                     <div id="dynamic-shop-items" class="contents"></div> 

                     <!-- More Static -->
                     <div class="bg-dark-card p-5 rounded-2xl border border-dark-border flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-brand-purple/20 text-brand-purple rounded-full flex items-center justify-center text-3xl mb-4"><i class="fas fa-palette"></i></div>
                        <h3 class="text-lg font-bold text-white">ƒê·ªïi M√†u T√™n</h3>
                        <p class="text-xs text-gray-400 mb-4">N·ªïi b·∫≠t tr√™n BXH</p>
                        <div class="mt-auto w-full">
                            <div class="text-brand-gold font-bold text-xl mb-3"><i class="fas fa-coins"></i> 300</div>
                            <button class="w-full py-2 bg-brand-purple text-white font-bold rounded-xl hover:bg-purple-600" onclick="buyItem(300, 'ƒê·ªïi M√†u T√™n')">Mua Ngay</button>
                        </div>
                     </div>
                </div>
            </div>

        </div>
    </main>

    <!-- ==================== RIGHT SIDEBAR (300px) ==================== -->
    <aside class="w-[300px] bg-dark-sidebar border-l border-dark-border hidden 2xl:flex flex-col z-20 shrink-0 p-6">
        <!-- Calendar -->
        <div class="mb-8">
            <h4 class="font-bold text-white mb-4">L·ªãch H·ªçc</h4>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-bold mb-2"><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span>CN</span></div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-400">
                <span class="opacity-30 p-1">29</span><span class="opacity-30 p-1">30</span>
                <span class="hover:bg-dark-hover rounded p-1 cursor-pointer">1</span>
                <span class="bg-brand-primary text-white rounded-lg shadow-glow-blue p-1">2</span>
                <span class="hover:bg-dark-hover rounded p-1 cursor-pointer">3</span>
                <span class="hover:bg-dark-hover rounded p-1 cursor-pointer">4</span>
                <span class="hover:bg-dark-hover rounded p-1 cursor-pointer">5</span>
            </div>
            <div class="mt-4 bg-dark-card p-3 rounded-xl border border-dark-border flex gap-3 items-center">
                <div class="bg-brand-danger/20 text-brand-danger p-2 rounded-lg text-center min-w-[40px]">
                    <span class="block text-[10px] font-bold uppercase">Dec</span><span class="block text-lg font-bold">07</span>
                </div>
                <div><h5 class="text-sm font-bold text-white">Thi th·ª≠ Ti·∫øng Anh</h5><p class="text-[10px] text-gray-500">20:00 - 21:00</p></div>
            </div>
        </div>

        <!-- Mini Leaderboard -->
        <div class="flex-1 overflow-y-auto">
            <h4 class="font-bold text-white mb-4 flex justify-between">Top H·ªçc Sinh <span class="text-brand-primary text-xs cursor-pointer hover:underline" onclick="switchTab('leaderboard')">Xem t·∫•t c·∫£</span></h4>
            <div class="space-y-3">
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-hover">
                    <span class="text-brand-gold font-bold">1</span>
                    <div class="w-8 h-8 rounded-full bg-brand-gold text-black flex items-center justify-center font-bold">A</div>
                    <div class="flex-1"><p class="text-sm text-white font-bold">Anh Th∆∞</p><p class="text-xs text-gray-500">12k XP</p></div>
                </div>
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-hover">
                    <span class="text-gray-400 font-bold">2</span>
                    <div class="w-8 h-8 rounded-full bg-gray-500 text-white flex items-center justify-center font-bold">M</div>
                    <div class="flex-1"><p class="text-sm text-white font-bold">Minh Tu·∫•n</p><p class="text-xs text-gray-500">10k XP</p></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- ==================== MOBILE NAV BOTTOM ==================== -->
    <div class="fixed bottom-0 left-0 w-full bg-dark-sidebar/95 backdrop-blur border-t border-dark-border p-2 flex justify-around xl:hidden z-40 pb-safe">
        <button class="m-nav-item flex flex-col items-center text-brand-primary p-2" onclick="switchTab('dashboard')"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">Home</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('library')"><i class="fas fa-folder-open text-xl mb-1"></i><span class="text-[10px]">T√†i li·ªáu</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('exam')"><i class="fas fa-file-signature text-xl mb-1"></i><span class="text-[10px]">Thi th·ª≠</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('friends')"><i class="fas fa-search text-xl mb-1"></i><span class="text-[10px]">T√¨m b·∫°n</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('shop')"><i class="fas fa-store text-xl mb-1"></i><span class="text-[10px]">Shop</span></button>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- User Profile Modal -->
    <div id="userProfileModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-dark-card w-full max-w-sm rounded-3xl p-6 border border-dark-border relative modal-animate shadow-2xl">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="closeUserProfile()"><i class="fas fa-times text-xl"></i></button>
            <div class="flex flex-col items-center">
                <div id="upAvatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-brand-primary to-brand-purple flex items-center justify-center text-4xl font-bold text-white mb-4 border-4 border-dark-card shadow-lg">U</div>
                <h2 id="upName" class="text-2xl font-bold text-white">User Name</h2>
                <p id="upUsername" class="text-brand-primary text-sm mb-4">@username</p>
                <p id="upBio" class="text-gray-400 text-center text-sm mb-6 bg-dark-main/50 p-3 rounded-xl w-full">...</p>
                <div class="flex gap-4 w-full mb-6">
                    <div class="flex-1 bg-dark-main p-3 rounded-xl text-center border border-dark-border">
                        <div id="upLvl" class="text-xl font-bold text-white">1</div><div class="text-xs text-gray-500">Level</div>
                    </div>
                    <div class="flex-1 bg-dark-main p-3 rounded-xl text-center border border-dark-border">
                        <div id="upXp" class="text-xl font-bold text-white">0</div><div class="text-xs text-gray-500">XP</div>
                    </div>
                </div>
                <button id="btnAddFriend" class="w-full py-3 bg-brand-primary text-white rounded-xl font-bold hover:bg-blue-600 transition" onclick="sendFriendRequest()"><i class="fas fa-user-plus mr-2"></i> K·∫øt B·∫°n</button>
            </div>
        </div>
    </div>

    <!-- Recharge Modal -->
    <div id="rechargeModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-dark-card w-full max-w-md rounded-3xl p-6 border border-dark-border relative modal-animate shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">N·∫°p Xu</h3>
                <button class="text-gray-400 hover:text-white" onclick="closeRechargeModal()"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex bg-dark-main p-1 rounded-xl mb-6">
                <button class="flex-1 py-2 rounded-lg text-sm font-bold bg-dark-card text-white shadow" onclick="switchRechargeTab('quick')">G√≥i Nhanh</button>
                <button class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-400 hover:text-white" onclick="switchRechargeTab('ticket')">Nh·∫≠p M√£</button>
            </div>

            <div id="recharge-quick" class="recharge-option active block">
                <div id="admin-banks"></div> <!-- Dynamic Bank Info -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="p-4 bg-dark-main border border-dark-border rounded-xl hover:border-brand-primary transition text-left" onclick="recharge(100)">
                        <div class="text-brand-primary font-bold">100 Xu</div><div class="text-xs text-gray-500">10,000ƒë</div>
                    </button>
                    <button class="p-4 bg-dark-main border border-dark-border rounded-xl hover:border-brand-primary transition text-left" onclick="recharge(500)">
                        <div class="text-brand-primary font-bold">500 Xu</div><div class="text-xs text-gray-500">50,000ƒë</div>
                    </button>
                    <button class="p-4 bg-dark-main border border-dark-border rounded-xl hover:border-brand-primary transition text-left" onclick="recharge(1000)">
                        <div class="text-brand-primary font-bold">1,000 Xu</div><div class="text-xs text-gray-500">100,000ƒë</div>
                    </button>
                    <button class="p-4 bg-gradient-to-r from-brand-gold to-yellow-600 rounded-xl text-black font-bold text-left" onclick="recharge(5000)">
                        <div>5,000 Xu</div><div class="text-xs opacity-75">500,000ƒë</div>
                    </button>
                </div>
            </div>

            <div id="recharge-ticket" class="recharge-option hidden">
                <input type="text" id="ticketCode" class="w-full bg-dark-main border border-dark-border rounded-xl p-4 text-white outline-none focus:border-brand-primary mb-4" placeholder="Nh·∫≠p m√£ qu√† t·∫∑ng...">
                <button class="w-full py-3 bg-brand-primary text-white rounded-xl font-bold" onclick="submitTicket()">X√°c Nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Exam Interface (Full Screen) -->
    <div id="examInterface" class="fixed inset-0 z-[100] bg-dark-main hidden flex flex-col">
        <div class="h-16 bg-dark-card border-b border-dark-border flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="quitExam()" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-xl"></i></button>
                <span id="examSubjectName" class="font-bold text-white text-lg truncate max-w-[200px]">T√™n b√†i thi</span>
            </div>
            <div class="bg-brand-danger/10 text-brand-danger px-3 py-1 rounded-full border border-brand-danger/20 font-mono font-bold flex items-center gap-2">
                <i class="far fa-clock"></i> <span id="examTimer">00:00</span>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 pb-24">
            <div id="questionsList" class="max-w-3xl mx-auto space-y-6"></div>
        </div>

        <div class="absolute bottom-6 right-6">
            <button class="bg-brand-success text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-brand-success/30 hover:scale-105 transition" onclick="submitExam()">
                <i class="fas fa-paper-plane mr-2"></i> N·ªôp B√†i
            </button>
        </div>
    </div>


    <!-- ==================== JAVASCRIPT LOGIC ==================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, orderBy, limit, getDocs, where, addDoc, onSnapshot, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentViewedUser = null;

        // --- NEW: TOGGLE MOBILE NAV FUNCTION ---
        window.toggleMobileNav = () => {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            // Toggle translate class to show/hide sidebar
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                listenToUserData(user.uid);
                initShopListener();
                initPaymentListener();
                initSystemNotiListener();
                initNotificationListener(user.uid);
            } else {
                window.location.replace('login.html');
            }
        });

        // 1. DATA LISTENER
        function listenToUserData(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('userName').innerText = data.fullname || "H·ªçc vi√™n";
                    
                    const avtEl = document.getElementById('userAvatar');
                    avtEl.innerText = (data.avatarEmoji || (data.fullname ? data.fullname.charAt(0) : "U"));
                    
                    document.getElementById('userXu').innerText = data.xu || 0;
                    
                    const crowns = document.querySelectorAll('.vip-crown');
                    if (data.isVIP) {
                        crowns.forEach(el => el.classList.remove('hidden'));
                        crowns.forEach(el => el.style.display = 'flex'); 
                    }

                    const nextLevel = (data.level || 1) * 1000;
                    const percent = Math.min(((data.xp || 0) / nextLevel) * 100, 100);
                    if(document.getElementById('xpBar')) document.getElementById('xpBar').style.width = percent + "%";
                    
                    if(document.getElementById('userLv')) document.getElementById('userLv').innerText = data.level || 1;
                    if(document.getElementById('userXp')) document.getElementById('userXp').innerText = data.xp || 0;

                    let rankName = "T·∫≠p S·ª±";
                    const lvl = data.level || 1;
                    if (lvl >= 5) rankName = "H·ªçc Gi·∫£";
                    if (lvl >= 10) rankName = "Chuy√™n Gia";
                    if (lvl >= 50) rankName = "Ti·∫øn Sƒ©";
                    document.getElementById('userRankTitle').innerText = rankName;

                    const loading = document.getElementById('loadingOverlay');
                    if(loading) { 
                        loading.style.opacity = '0'; 
                        setTimeout(() => loading.style.display = 'none', 500); 
                    }
                }
            });
        }

        // 2. SHOP LISTENER
        function initShopListener() {
            onSnapshot(collection(db, "items"), (snapshot) => {
                let dynContainer = document.getElementById('dynamic-shop-items');
                if(!dynContainer) return;

                let html = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    html += `
                        <div class="bg-dark-card p-5 rounded-2xl border border-dark-border flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-brand-primary/10 text-brand-primary rounded-full flex items-center justify-center text-3xl mb-4">${item.emoji || 'üì¶'}</div>
                            <h3 class="text-lg font-bold text-white">${item.name}</h3>
                            <p class="text-xs text-gray-400 mb-4">Kho: ${item.stock}</p>
                            <div class="mt-auto w-full">
                                <div class="text-brand-gold font-bold text-xl mb-3">
                                    ${item.salePrice ? `<span class="line-through text-gray-500 text-sm mr-2">${item.price}</span> <span class="text-brand-danger">${item.salePrice}</span>` : item.price} <i class="fas fa-coins"></i>
                                </div>
                                <button class="w-full py-2 bg-dark-main border border-dark-border text-white font-bold rounded-xl hover:bg-white hover:text-black transition" onclick="buyDynamicItem('${doc.id}', ${item.salePrice || item.price}, '${item.name}')">Mua</button>
                            </div>
                        </div>
                    `;
                });
                dynContainer.innerHTML = html;
            });
        }

        window.buyDynamicItem = async (id, price, name) => {
            const curXu = parseInt(document.getElementById('userXu').innerText);
            if(curXu < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm("Mua " + name + " v·ªõi gi√° " + price + " Xu?")) {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(-price) });
                alert("Mua th√†nh c√¥ng!");
            }
        }

        // 3. PAYMENT LISTENER
        function initPaymentListener() {
            onSnapshot(collection(db, "payment_info"), (snapshot) => {
                const adminBanks = document.getElementById('admin-banks');
                if(!adminBanks) return;
                
                let html = '<p class="text-sm text-brand-secondary font-bold mb-3">Th√¥ng tin chuy·ªÉn kho·∫£n:</p>';
                if(snapshot.empty) html = '';

                snapshot.forEach(doc => {
                    const p = doc.data();
                    html += `
                        <div class="bg-white/5 p-3 rounded-xl mb-3 flex items-center gap-3 border border-white/10">
                            <img src="${p.qrUrl}" class="w-14 h-14 object-cover bg-white rounded-lg" onclick="window.open(this.src)">
                            <div>
                                <div class="text-green-400 font-bold text-sm">${p.bankName}</div>
                                <div class="text-white font-mono font-bold text-lg tracking-wide">${p.number}</div>
                                <div class="text-gray-400 text-xs">${p.owner}</div>
                            </div>
                        </div>
                    `;
                });
                adminBanks.innerHTML = html;
            });
        }

        // 4. SYSTEM NOTI LISTENER
        function initSystemNotiListener() {
            const q = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                const notifList = document.getElementById('notifList');
                if(!notifList) return;

                let sysContainer = document.getElementById('sys-notifs');
                if(!sysContainer) {
                    sysContainer = document.createElement('div');
                    sysContainer.id = 'sys-notifs';
                    notifList.prepend(sysContainer); 
                }

                let sysHtml = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    sysHtml += `
                        <div class="p-3 border-l-4 border-brand-primary bg-brand-primary/10 mb-1">
                            <div class="flex gap-3">
                                <div class="w-8 h-8 rounded-full bg-brand-primary text-white flex items-center justify-center shrink-0"><i class="fas fa-bullhorn text-xs"></i></div>
                                <div>
                                    <strong class="text-white text-sm block">${n.title}</strong>
                                    <p class="text-gray-400 text-xs">${n.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                sysContainer.innerHTML = sysHtml;

                if(!snapshot.empty) {
                    const badge = document.getElementById('notifCount');
                    badge.classList.remove('hidden');
                    badge.innerText = '!';
                }
            });
        }

        // FRIEND NOTIFICATIONS
        window.toggleNotifPanel = () => {
            const panel = document.getElementById('notifPanel');
            panel.classList.toggle('hidden');
            panel.classList.toggle('flex');
        };

        function initNotificationListener(uid) {
            onSnapshot(collection(db, "users", uid, "notifications"), (snapshot) => {
                const list = document.getElementById('notifList');
                let friendHtml = "";
                let count = 0;
                snapshot.forEach(doc => {
                    const n = doc.data();
                    count++;
                    if(n.type === 'friend_request') {
                        friendHtml += `
                        <div class="p-3 border-b border-dark-border flex gap-3 items-start">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-400 to-purple-500 text-white flex items-center justify-center font-bold shrink-0 text-sm">${n.fromAvatar}</div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-300"><strong>${n.fromName}</strong> g·ª≠i k·∫øt b·∫°n.</p>
                                <div class="flex gap-2 mt-2">
                                    <button class="px-3 py-1 bg-brand-primary text-white text-xs rounded hover:bg-blue-600" onclick="handleRequest('${doc.id}', '${n.fromUid}', true)">Ch·∫•p nh·∫≠n</button>
                                    <button class="px-3 py-1 border border-gray-600 text-gray-400 text-xs rounded hover:bg-white hover:text-black" onclick="handleRequest('${doc.id}', '${n.fromUid}', false)">X√≥a</button>
                                </div>
                            </div>
                        </div>`;
                    }
                });
                
                let friendContainer = document.getElementById('friend-reqs');
                if(!friendContainer) {
                    friendContainer = document.createElement('div');
                    friendContainer.id = 'friend-reqs';
                    list.appendChild(friendContainer);
                }
                friendContainer.innerHTML = friendHtml;

                const badge = document.getElementById('notifCount');
                if(count > 0) {
                    badge.innerText = count;
                    badge.classList.remove('hidden');
                }
            });
        }

        window.handleRequest = async (id, fromUid, accept) => {
            if(accept) alert("ƒê√£ k·∫øt b·∫°n!");
            await deleteDoc(doc(db, "users", currentUser.uid, "notifications", id));
        }

        // FRIENDS SEARCH
        window.searchFriend = async () => {
            const input = document.getElementById('friendSearchInput').value.trim();
            const container = document.getElementById('friendResult');
            container.innerHTML = '<p class="text-center text-gray-500 w-full col-span-2">ƒêang t√¨m...</p>';
            if(!input) return;
            const q = query(collection(db, "users"), where("username", "==", input));
            const snapshot = await getDocs(q);
            container.innerHTML = "";
            if(snapshot.empty) container.innerHTML = '<p class="text-center text-brand-danger w-full col-span-2">Kh√¥ng t√¨m th·∫•y!</p>';
            else {
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const div = document.createElement('div');
                    div.className = 'bg-dark-card p-4 rounded-xl border border-dark-border cursor-pointer hover:border-brand-primary transition flex items-center gap-4';
                    div.onclick = () => openUserProfile(doc.id, u);
                    div.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-dark-main border border-dark-border flex items-center justify-center text-xl font-bold text-white">${u.avatarEmoji || u.fullname.charAt(0)}</div>
                        <div>
                            <h4 class="font-bold text-white">${u.fullname}</h4>
                            <p class="text-xs text-gray-500">@${u.username}</p>
                            <div class="text-xs text-brand-primary mt-1">Lv.${u.level || 1} ‚Ä¢ ${u.xp || 0} XP</div>
                        </div>`;
                    container.appendChild(div);
                });
            }
        }

        window.openUserProfile = (uid, data) => {
            if(uid === currentUser.uid) return;
            currentViewedUser = uid;
            document.getElementById('upAvatar').innerText = data.avatarEmoji || data.fullname.charAt(0);
            document.getElementById('upName').innerText = data.fullname;
            document.getElementById('upUsername').innerText = "@" + data.username;
            document.getElementById('upBio').innerText = data.bio || "Ch∆∞a c√≥ ti·ªÉu s·ª≠";
            document.getElementById('upLvl').innerText = data.level || 1;
            document.getElementById('upXp').innerText = data.xp || 0;
            
            const modal = document.getElementById('userProfileModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeUserProfile = () => {
            const modal = document.getElementById('userProfileModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.sendFriendRequest = async () => {
            if(!currentViewedUser) return;
            const btn = document.getElementById('btnAddFriend');
            btn.innerText = "ƒêang g·ª≠i...";
            try {
                const mySnap = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(collection(db, "users", currentViewedUser, "notifications"), {
                    type: 'friend_request', fromUid: currentUser.uid, fromName: mySnap.data().fullname,
                    fromAvatar: mySnap.data().avatarEmoji || mySnap.data().fullname.charAt(0),
                    timestamp: new Date().toISOString()
                });
                alert("ƒê√£ g·ª≠i l·ªùi m·ªùi!");
                btn.innerText = "ƒê√£ G·ª≠i"; btn.disabled = true;
            } catch(e) { alert("L·ªói g·ª≠i!"); btn.innerText = "K·∫øt B·∫°n"; }
        }

        // EXAM DATA
        const EXAM_DATA = [
            { id: 'math_12_hk1', title: 'To√°n 12 - Cu·ªëi K·ª≥ 1', time: 90, xp: 200, difficulty: 'Kh√≥', questions: [
                {q:"H√†m s·ªë y = x^3 - 3x^2 + 1 ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o?", opts:["(-‚àû; 0) v√† (2; +‚àû)", "(0; 2)", "(-‚àû; 2)", "(2; +‚àû)"], ans:0},
                {q:"Th·ªÉ t√≠ch kh·ªëi lƒÉng tr·ª• c√≥ di·ªán t√≠ch ƒë√°y B v√† chi·ªÅu cao h l√†:", opts:["V = Bh", "V = 1/3 Bh", "V = 3Bh", "V = 1/2 Bh"], ans:0},
                {q:"Nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh 2^x = 8 l√†:", opts:["x = 3", "x = 2", "x = 4", "x = 1"], ans:0},
                {q:"T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë y = log(x-1) l√†:", opts:["(1; +‚àû)", "[1; +‚àû)", "(-‚àû; 1)", "R\\{1}"], ans:0},
                {q:"Cho kh·ªëi n√≥n c√≥ b√°n k√≠nh ƒë√°y r=3, chi·ªÅu cao h=4. Th·ªÉ t√≠ch kh·ªëi n√≥n l√†:", opts:["12œÄ", "36œÄ", "4œÄ", "16œÄ"], ans:0}
            ]},
            { id: 'math_11_trig', title: 'To√°n 11 - L∆∞·ª£ng Gi√°c', time: 45, xp: 120, difficulty: 'TB', questions: [
                {q:"Ph∆∞∆°ng tr√¨nh sin(x) = 1 c√≥ nghi·ªám l√†:", opts:["x = œÄ/2 + k2œÄ", "x = kœÄ", "x = œÄ + k2œÄ", "x = -œÄ/2 + k2œÄ"], ans:0},
                {q:"H√†m s·ªë n√†o sau ƒë√¢y l√† h√†m s·ªë ch·∫µn?", opts:["y = cos(x)", "y = sin(x)", "y = tan(x)", "y = cot(x)"], ans:0},
                {q:"Gi√° tr·ªã l·ªõn nh·∫•t c·ªßa h√†m s·ªë y = 2sin(x) + 1 l√†:", opts:["3", "1", "2", "0"], ans:0}
            ]},
            { id: 'phy_12_osc', title: 'V·∫≠t L√Ω 12 - Dao ƒê·ªông', time: 45, xp: 120, difficulty: 'TB', questions: [
                {q:"M·ªôt v·∫≠t dao ƒë·ªông ƒëi·ªÅu h√≤a v·ªõi ph∆∞∆°ng tr√¨nh x = 4cos(2œÄt + œÄ/3) cm. Bi√™n ƒë·ªô dao ƒë·ªông l√†:", opts:["4 cm", "2 cm", "8 cm", "4œÄ cm"], ans:0},
                {q:"C√¥ng th·ª©c t√≠nh chu k·ª≥ con l·∫Øc ƒë∆°n l√†:", opts:["T = 2œÄ‚àö(l/g)", "T = 2œÄ‚àö(g/l)", "T = ‚àö(l/g)", "T = 2œÄ‚àö(m/k)"], ans:0},
                {q:"Khi x·∫£y ra hi·ªán t∆∞·ª£ng c·ªông h∆∞·ªüng c∆° th√¨:", opts:["Bi√™n ƒë·ªô dao ƒë·ªông ƒë·∫°t gi√° tr·ªã c·ª±c ƒë·∫°i", "T·∫ßn s·ªë dao ƒë·ªông b·∫±ng t·∫ßn s·ªë ri√™ng", "C·∫£ A v√† B ƒë·ªÅu ƒë√∫ng", "NƒÉng l∆∞·ª£ng dao ƒë·ªông kh√¥ng ƒë·ªïi"], ans:2}
            ]},
            { id: 'phy_11_elec', title: 'V·∫≠t L√Ω 11 - ƒêi·ªán Tr∆∞·ªùng', time: 30, xp: 80, difficulty: 'D·ªÖ', questions: [
                {q:"ƒê∆°n v·ªã c·ªßa ƒëi·ªán t√≠ch l√†:", opts:["Coulomb (C)", "V√¥n (V)", "Ampe (A)", "Jun (J)"], ans:0},
                {q:"Hai ƒëi·ªán t√≠ch c√πng d·∫•u th√¨:", opts:["ƒê·∫©y nhau", "H√∫t nhau", "Kh√¥ng t√°c d·ª•ng l·ª±c", "H√∫t ho·∫∑c ƒë·∫©y t√πy kho·∫£ng c√°ch"], ans:0}
            ]},
            { id: 'chem_12_est', title: 'H√≥a 12 - Este & Lipit', time: 45, xp: 130, difficulty: 'TB', questions: [
                {q:"Ch·∫•t n√†o sau ƒë√¢y l√† este?", opts:["CH3COOC2H5", "CH3COOH", "C2H5OH", "CH3CHO"], ans:0},
                {q:"Th·ªßy ph√¢n este trong m√¥i tr∆∞·ªùng ki·ªÅm ƒë∆∞·ª£c g·ªçi l√† ph·∫£n ·ª©ng:", opts:["X√† ph√≤ng h√≥a", "Tr√°ng g∆∞∆°ng", "Este h√≥a", "Tr√πng ng∆∞ng"], ans:0},
                {q:"C√¥ng th·ª©c t·ªïng qu√°t c·ªßa este no, ƒë∆°n ch·ª©c, m·∫°ch h·ªü l√†:", opts:["CnH2nO2 (n‚â•2)", "CnH2n+2O", "CnH2nO", "CnH2n-2O2"], ans:0}
            ]},
            { id: 'bio_12_gen', title: 'Sinh 12 - Di Truy·ªÅn', time: 40, xp: 110, difficulty: 'TB', questions: [
                {q:"M√£ di truy·ªÅn c√≥ t√≠nh ch·∫•t n√†o sau ƒë√¢y?", opts:["T√≠nh ph·ªï bi·∫øn", "T√≠nh tho√°i h√≥a", "T√≠nh ƒë·∫∑c hi·ªáu", "C·∫£ 3 √Ω tr√™n"], ans:3},
                {q:"ƒê∆°n ph√¢n c·∫•u t·∫°o n√™n ADN l√†:", opts:["Nucleotit", "Axit amin", "Glucoz∆°", "Axit b√©o"], ans:0},
                {q:"Qu√° tr√¨nh nh√¢n ƒë√¥i ADN di·ªÖn ra theo nguy√™n t·∫Øc:", opts:["B·ªï sung v√† b√°n b·∫£o to√†n", "B·ªï sung v√† b·∫£o to√†n", "Khu√¥n m·∫´u", "Ng·∫´u nhi√™n"], ans:0}
            ]},
            { id: 'eng_12_gen', title: 'Ti·∫øng Anh 12 - T·ªïng H·ª£p', time: 60, xp: 150, difficulty: 'Kh√≥', questions: [
                {q:"She _______ to school every day.", opts:["goes", "go", "going", "went"], ans:0},
                {q:"If I _______ you, I would study harder.", opts:["were", "am", "was", "have been"], ans:0},
                {q:"Synonym of 'Happy':", opts:["Joyful", "Sad", "Angry", "Bored"], ans:0},
                {q:"I haven't seen him _______ 2010.", opts:["since", "for", "in", "at"], ans:0},
                {q:"He is interested _______ learning English.", opts:["in", "on", "at", "of"], ans:0}
            ]},
            { id: 'it_11_py', title: 'Tin H·ªçc 11 - Python', time: 45, xp: 140, difficulty: 'Kh√≥', questions: [
                {q:"Trong Python, h√†m d√πng ƒë·ªÉ in ra m√†n h√¨nh l√†:", opts:["print()", "cout <<", "System.out.println", "printf"], ans:0},
                {q:"K·∫øt qu·∫£ c·ªßa 10 // 3 trong Python l√†:", opts:["3", "3.333", "1", "3.0"], ans:0},                {q:"Ki·ªÉu d·ªØ li·ªáu danh s√°ch trong Python g·ªçi l√†:", opts:["List", "Array", "Dictionary", "Tuple"], ans:0}
            ]},
            { id: 'tech_agri', title: 'CN N√¥ng Nghi·ªáp', time: 30, xp: 90, difficulty: 'D·ªÖ', questions: [
                {q:"Vai tr√≤ c·ªßa r·ª´ng l√†:", opts:["ƒêi·ªÅu h√≤a kh√≠ h·∫≠u", "Cung c·∫•p g·ªó", "Gi·ªØ ƒë·∫•t, gi·ªØ n∆∞·ªõc", "C·∫£ 3 √Ω tr√™n"], ans:3},
                {q:"Ph√¢n b√≥n h·ªØu c∆° c√≥ ƒë·∫∑c ƒëi·ªÉm:", opts:["Hi·ªáu qu·∫£ ch·∫≠m nh∆∞ng b·ªÅn", "Hi·ªáu qu·∫£ nhanh", "D·ªÖ tan", "G√¢y √¥ nhi·ªÖm"], ans:0}
            ]},
            { id: 'tech_ind', title: 'CN C√¥ng Nghi·ªáp', time: 30, xp: 90, difficulty: 'D·ªÖ', questions: [
                {q:"Trong b·∫£n v·∫Ω kƒ© thu·∫≠t, n√©t li·ªÅn ƒë·∫≠m d√πng ƒë·ªÉ v·∫Ω:", opts:["ƒê∆∞·ªùng bao th·∫•y", "ƒê∆∞·ªùng t√¢m", "ƒê∆∞·ªùng k√≠ch th∆∞·ªõc", "ƒê∆∞·ªùng gi√≥ng"], ans:0},
                {q:"V·∫≠t li·ªáu c∆° kh√≠ ph·ªï bi·∫øn nh·∫•t l√†:", opts:["Kim lo·∫°i ƒëen (th√©p, gang)", "Nh·ª±a", "G·ªó", "Cao su"], ans:0}
            ]},
            { id: 'civic_12', title: 'GDCD/KTPL 12', time: 40, xp: 100, difficulty: 'TB', questions: [
                {q:"C∆° quan quy·ªÅn l·ª±c nh√† n∆∞·ªõc cao nh·∫•t l√†:", opts:["Qu·ªëc h·ªôi", "Ch√≠nh ph·ªß", "T√≤a √°n", "Vi·ªán ki·ªÉm s√°t"], ans:0},
                {q:"C√¥ng d√¢n c√≥ quy·ªÅn b·∫ßu c·ª≠ khi ƒë·ªß:", opts:["18 tu·ªïi", "21 tu·ªïi", "16 tu·ªïi", "20 tu·ªïi"], ans:0},
                {q:"Nghƒ©a v·ª• qu√¢n s·ª± √°p d·ª•ng cho c√¥ng d√¢n nam t·ª´:", opts:["18 ƒë·∫øn 25 tu·ªïi (ho·∫∑c 27)", "20 ƒë·∫øn 30 tu·ªïi", "17 ƒë·∫øn 25 tu·ªïi", "18 ƒë·∫øn 40 tu·ªïi"], ans:0}
            ]},
            { id: 'civic_10', title: 'Kinh T·∫ø Ph√°p Lu·∫≠t 10', time: 30, xp: 80, difficulty: 'D·ªÖ', questions: [
                {q:"Th·ªã tr∆∞·ªùng l√† n∆°i di·ªÖn ra ho·∫°t ƒë·ªông:", opts:["Mua v√† b√°n", "S·∫£n xu·∫•t", "Ti√™u d√πng", "Qu·∫£n l√Ω"], ans:0},
                {q:"Thu·∫ø l√† ngu·ªìn thu ch·ªß y·∫øu c·ªßa:", opts:["Ng√¢n s√°ch nh√† n∆∞·ªõc", "Doanh nghi·ªáp", "H·ªô gia ƒë√¨nh", "T·ªï ch·ª©c t·ª´ thi·ªán"], ans:0}
            ]}
        ];

        // INIT EXAM LIST (Tailwind Styled)
        const examList = document.getElementById('examListContainer');
        EXAM_DATA.forEach(exam => {
            const div = document.createElement('div');
            // Tailwind Classes for Card
            div.className = 'bg-dark-card p-5 rounded-2xl border border-dark-border relative group hover:-translate-y-1 transition-all hover:border-brand-primary/30';
            
            let iconClass = 'fa-book';
            let iconColor = 'text-gray-400';
            let bgIcon = 'bg-gray-800';
            
            if(exam.id.includes('math')) { iconClass = 'fa-square-root-alt'; iconColor = 'text-brand-gold'; bgIcon = 'bg-brand-gold/10'; }
            else if(exam.id.includes('phy')) { iconClass = 'fa-atom'; iconColor = 'text-brand-primary'; bgIcon = 'bg-brand-primary/10'; }
            else if(exam.id.includes('chem')) { iconClass = 'fa-flask'; iconColor = 'text-brand-purple'; bgIcon = 'bg-brand-purple/10'; }
            else if(exam.id.includes('bio')) { iconClass = 'fa-dna'; iconColor = 'text-brand-success'; bgIcon = 'bg-brand-success/10'; }
            else if(exam.id.includes('eng')) { iconClass = 'fa-language'; iconColor = 'text-pink-500'; bgIcon = 'bg-pink-500/10'; }
            
            div.innerHTML = `
                <span class="absolute top-3 right-3 text-[10px] font-bold px-2 py-0.5 rounded bg-gray-700 text-gray-300">${exam.difficulty}</span>
                <div class="w-12 h-12 rounded-xl ${bgIcon} ${iconColor} flex items-center justify-center text-xl mb-3"><i class="fas ${iconClass}"></i></div>
                <h3 class="font-bold text-white text-lg mb-1">${exam.title}</h3>
                <div class="flex gap-3 text-xs text-gray-500 mb-4">
                    <span><i class="fas fa-clock mr-1"></i> ${exam.time}p</span> 
                    <span><i class="fas fa-star mr-1"></i> +${exam.xp} XP</span>
                </div>
                <button class="w-full py-2 rounded-lg bg-dark-main border border-dark-border text-white font-bold hover:bg-brand-primary hover:border-brand-primary transition text-sm" onclick="window.startExam('${exam.id}')">L√†m B√†i</button>`;
            examList.appendChild(div);
        });

        // EXAM LOGIC
        let currentExam = null;
        let timerInterval = null;
        let userAnswers = {};

        window.startExam = (id) => {
            if (id === 'random') {
                 // Logic ch·ªçn ƒë·ªÅ ng·∫´u nhi√™n t·ª´ EXAM_DATA
                 const randIndex = Math.floor(Math.random() * EXAM_DATA.length);
                 window.startExam(EXAM_DATA[randIndex].id);
                 return;
            }

            const exam = EXAM_DATA.find(e => e.id === id);
            currentExam = exam;
            userAnswers = {};
            document.getElementById('examSubjectName').innerText = exam.title;
            const list = document.getElementById('questionsList');
            list.innerHTML = "";
            
            exam.questions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'bg-dark-card p-6 rounded-2xl border border-dark-border';
                card.innerHTML = `
                    <div class="font-bold text-white text-lg mb-4">C√¢u ${i+1}: ${q.q}</div>
                    <div class="grid gap-3">
                        ${q.opts.map((o, idx) => `
                        <label class="flex items-center p-3 rounded-xl bg-dark-main border border-dark-border cursor-pointer hover:bg-dark-hover transition">
                            <input type="radio" name="q${i}" value="${idx}" onchange="window.selectAnswer(${i}, ${idx})" class="w-5 h-5 accent-brand-primary mr-3"> 
                            <span class="text-gray-300">${o}</span>
                        </label>`).join('')}
                    </div>`;
                list.appendChild(card);
            });

            document.getElementById('examInterface').classList.remove('hidden');
            document.getElementById('examInterface').classList.add('flex');
            
            let timeLeft = exam.time * 60;
            const timerEl = document.getElementById('examTimer');
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.innerText = `${m}:${s}`;
                if(timeLeft <= 0) window.submitExam();
            }, 1000);
        }

        window.selectAnswer = (qIdx, ansIdx) => { userAnswers[qIdx] = ansIdx; }

        window.quitExam = () => { 
            if(confirm("Tho√°t b√†i thi? K·∫øt qu·∫£ s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.")) { 
                clearInterval(timerInterval); 
                document.getElementById('examInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.remove('flex');
            } 
        }

        window.submitExam = async () => {
            clearInterval(timerInterval);
            let correct = 0;
            currentExam.questions.forEach((q, i) => { if(userAnswers[i] === q.ans) correct++; });
            const xpEarned = Math.floor((correct / currentExam.questions.length) * currentExam.xp);
            
            if(xpEarned > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(xpEarned) });
            }
            
            alert(`K·∫øt qu·∫£: ${correct}/${currentExam.questions.length} c√¢u ƒë√∫ng.\nB·∫°n nh·∫≠n ƒë∆∞·ª£c +${xpEarned} XP!`);
            document.getElementById('examInterface').classList.add('hidden');
            document.getElementById('examInterface').classList.remove('flex');
        }

        // LIBRARY LOGIC
        const DOCUMENTS = [
            { title: "ƒê·ªÅ thi To√°n 2024", subject: "To√°n", type: "PDF", filename: "toan.pdf" },
            { title: "C√¥ng th·ª©c V·∫≠t L√Ω", subject: "L√Ω", type: "PDF", filename: "ly.pdf" }
        ];

        function renderDocs(data) {
            const container = document.getElementById('libraryContainer');
            container.innerHTML = "";
            data.forEach(d => {
                const div = document.createElement('div');
                div.className = 'bg-dark-card p-5 rounded-2xl border border-dark-border group hover:border-brand-secondary/50 transition';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="w-10 h-10 bg-brand-secondary/10 text-brand-secondary rounded-lg flex items-center justify-center text-xl"><i class="fas fa-book"></i></div>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-brand-secondary/20 text-brand-secondary">${d.type}</span>
                    </div>
                    <h3 class="font-bold text-white mb-1">${d.title}</h3>
                    <p class="text-xs text-gray-500 mb-4">${d.subject}</p>
                    <button class="w-full py-2 bg-dark-main text-gray-300 rounded-lg text-sm font-bold border border-dark-border hover:bg-brand-secondary hover:text-white hover:border-brand-secondary transition" onclick="alert('T·∫£i ${d.filename}')">T·∫£i Xu·ªëng</button>`;
                container.appendChild(div);
            });
        }
        renderDocs(DOCUMENTS);
        window.filterDocs = (val) => renderDocs(DOCUMENTS.filter(d => d.title.toLowerCase().includes(val.toLowerCase())));
        window.filterByTag = (tag, btn) => {
            document.querySelectorAll('.filter-tag').forEach(b => {
                b.classList.remove('bg-brand-primary', 'text-white');
                b.classList.add('bg-dark-card', 'text-gray-400');
            });
            btn.classList.remove('bg-dark-card', 'text-gray-400');
            btn.classList.add('bg-brand-primary', 'text-white');
            if(tag==='all') renderDocs(DOCUMENTS); else renderDocs(DOCUMENTS.filter(d => d.subject === tag));
        }

        // LEADERBOARD LOGIC
        async function loadLeaderboard() {
            const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(50));
            const snap = await getDocs(q);
            const list = document.getElementById('lbList');
            list.innerHTML = "";
            let rank = 1;
            snap.forEach(doc => {
                const u = doc.data();
                let colorClass = 'text-gray-500';
                if(rank===1) colorClass = 'text-brand-gold';
                if(rank===2) colorClass = 'text-gray-300';
                if(rank===3) colorClass = 'text-orange-600';

                list.insertAdjacentHTML('beforeend', `
                    <li class="flex items-center p-3 rounded-xl bg-dark-main border border-dark-border gap-4">
                        <div class="font-black text-xl w-6 text-center ${colorClass}">${rank}</div>
                        <div class="w-10 h-10 rounded-full bg-dark-card flex items-center justify-center font-bold text-white border border-dark-border">${u.avatarEmoji||u.fullname.charAt(0)}</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-white truncate">${u.fullname}</div>
                            <div class="text-xs text-gray-500 truncate">@${u.username}</div>
                        </div>
                        <div class="font-bold text-brand-secondary">${u.xp} XP</div>
                    </li>`);
                rank++;
            });
        }

        // SHOP & RECHARGE MODALS
        window.openRechargeModal = () => {
            const modal = document.getElementById('rechargeModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        window.closeRechargeModal = () => {
            const modal = document.getElementById('rechargeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        window.switchRechargeTab = (tab) => {
            if(tab === 'quick') {
                document.getElementById('recharge-quick').classList.remove('hidden');
                document.getElementById('recharge-ticket').classList.add('hidden');
            } else {
                document.getElementById('recharge-quick').classList.add('hidden');
                document.getElementById('recharge-ticket').classList.remove('hidden');
            }
        }
        window.recharge = async (amount) => {
            if(confirm(`N·∫°p ${amount} Xu?`)) {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(amount) });
                alert("Th√†nh c√¥ng!"); 
                closeRechargeModal();
            }
        }
        window.submitTicket = async () => {
            if(document.getElementById('ticketCode').value === "ONLYADMIN") {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(500) });
                alert("Nh·∫≠n 500 Xu!"); 
                closeRechargeModal();
            } else alert("M√£ sai!");
        }
        window.buyItem = async (price, name, type) => {
            const cur = parseInt(document.getElementById('userXu').innerText);
            if(cur < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm(`Mua ${name}?`)) {
                const updates = { xu: increment(-price) };
                if(type==='vip') updates.isVIP = true;
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                alert("ƒê√£ mua!");
            }
        }

        // NAVIGATION
        window.switchTab = (tab) => {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('block');
            });
            // Show selected tab
            const target = document.getElementById('tab-' + tab);
            if(target) {
                target.classList.remove('hidden');
                target.classList.add('block');
            }

            // Update Active State Sidebar
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active-nav');
                el.classList.add('text-gray-400', 'hover:bg-dark-hover', 'hover:text-white');
            });
            // Reset mobile nav
            document.querySelectorAll('.m-nav-item').forEach(el => el.classList.remove('text-brand-primary'));

            const titles = { 'dashboard': 'T·ªïng Quan', 'library': 'Kho T√†i Li·ªáu', 'exam': 'Thi Th·ª≠', 'friends': 'T√¨m B·∫°n', 'leaderboard': 'BXH', 'shop': 'C·ª≠a H√†ng' };
            const titleEl = document.getElementById('pageTitle');
            if(titleEl) titleEl.innerText = titles[tab];
            
            if(tab === 'leaderboard') loadLeaderboard();
        }

        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>
