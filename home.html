<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard | HighSchool Hub</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2997/2997320.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6C63FF; --secondary: #00D2FF; --accent: #FF2E63;
            --gold: #FFD700; --dark: #0f172a; --dark-lighter: #1e293b;
            --text: #f8fafc; --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-gold: linear-gradient(135deg, #FFD700, #FFA500);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark); color: var(--text); overflow-x: hidden; padding-bottom: 90px; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--dark); }
        ::-webkit-scrollbar-thumb { background: var(--dark-lighter); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- BAMBOO LOADING SCREEN --- */
        #loadingOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; 
            background: var(--dark); z-index: 10000; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; 
            transition: opacity 0.4s ease-out, visibility 0.4s;
        }
        
        .bamboo-container {
            width: 80px; height: 200px; position: relative;
            display: flex; flex-direction: column-reverse; align-items: center;
            margin-bottom: 20px;
        }
        /* ƒê·ªët tre */
        .bamboo-joint {
            width: 30px; height: 0; opacity: 0;
            background: linear-gradient(90deg, #66BB6A 0%, #43A047 50%, #66BB6A 100%);
            border: 1px solid #2E7D32; border-radius: 4px;
            margin-bottom: 2px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            animation: growJoint 0.4s ease-out forwards;
        }
        .bamboo-joint::before { /* M·∫Øt tre */
            content: ''; position: absolute; top: -3px; left: -2px;
            width: 34px; height: 4px; background: #1B5E20; border-radius: 5px; z-index: 2;
        }
        /* L√° tre */
        .bamboo-leaf {
            position: absolute; width: 0; height: 0; 
            background: #66BB6A; border-radius: 0 50% 50% 50%;
            opacity: 0; z-index: 1;
            animation: growLeaf 0.4s ease-out forwards;
        }

        /* Animation Delays */
        .j1 { animation-delay: 0.2s; height: 40px; }
        .j2 { animation-delay: 0.6s; height: 40px; }
        .j3 { animation-delay: 1.0s; height: 40px; }
        .j4 { animation-delay: 1.4s; height: 40px; }
        .j5 { animation-delay: 1.8s; height: 30px; border-radius: 4px 4px 20px 20px; } /* Ng·ªçn */

        .l1 { top: 140px; left: 40px; transform: rotate(-20deg); animation-delay: 0.7s; }
        .l2 { top: 100px; right: 40px; transform: rotate(200deg); animation-delay: 1.1s; }
        .l3 { top: 60px; left: 40px; transform: rotate(-30deg); animation-delay: 1.5s; }
        .l4 { top: 20px; right: 35px; transform: rotate(210deg); animation-delay: 1.9s; }

        @keyframes growJoint { from { height: 0; opacity: 0; transform: translateY(10px); } to { height: 45px; opacity: 1; transform: translateY(0); } }
        @keyframes growLeaf { from { width: 0; height: 0; opacity: 0; } to { width: 35px; height: 12px; opacity: 1; } }

        .loading-text { margin-top: 10px; color: #66BB6A; font-size: 1rem; letter-spacing: 2px; font-weight: 700; text-transform: uppercase; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- LAYOUT --- */
        .wrapper { display: flex; min-height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 260px; height: 100vh; background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); border-right: var(--glass-border);
            padding: 30px 20px; position: fixed; top: 0; left: 0;
            display: flex; flex-direction: column; z-index: 100; transition: 0.3s;
        }
        .brand { 
            font-size: 1.6rem; font-weight: 800; background: var(--gradient); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 40px; display: flex; gap: 12px; align-items: center; cursor: pointer; 
        }
        .nav-links { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .nav-item { 
            padding: 14px 18px; border-radius: 14px; cursor: pointer; 
            color: var(--text-muted); transition: 0.2s; font-weight: 600; 
            display: flex; align-items: center; gap: 15px; font-size: 0.95rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(108,99,255,0.15); color: var(--primary); border: 1px solid rgba(108,99,255,0.3); }
        .nav-item i { font-size: 1.2rem; width: 24px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { 
            margin-left: 260px; padding: 30px 40px; flex: 1; 
            padding-top: calc(30px + var(--safe-top)); width: 100%;
        }

        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
        #pageTitle { font-size: 1.8rem; font-weight: 700; margin: 0; letter-spacing: -0.5px; }
        
        .action-group { display: flex; align-items: center; gap: 15px; }
        .currency-badge { 
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--gold); 
            color: var(--gold); padding: 8px 16px; border-radius: 50px; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; 
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.1);
        }
        .currency-badge:hover { transform: scale(1.05); box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2); }
        
        .notif-btn { 
            position: relative; width: 45px; height: 45px; border-radius: 50%; 
            background: var(--glass-bg); border: var(--glass-border);
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; color: var(--text); cursor: pointer; transition: 0.3s; 
        }
        .notif-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .notif-badge { 
            position: absolute; top: -2px; right: -2px; background: var(--accent); 
            color: white; font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; 
            border: 2px solid var(--dark); 
        }

        /* --- PROFILE WIDGET (Dashboard) --- */
        .profile-widget { 
            background: linear-gradient(145deg, rgba(30,41,59,0.9), rgba(15,23,42,0.95));
            border: var(--glass-border); border-radius: 24px; padding: 30px; 
            display: flex; align-items: center; gap: 30px; margin-bottom: 40px; 
            cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; 
            box-shadow: var(--shadow);
        }
        .profile-widget::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
            pointer-events: none;
        }
        .profile-widget:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 15px 40px -10px rgba(108,99,255,0.3); }
        
        .avatar-wrapper { position: relative; width: 90px; height: 90px; flex-shrink: 0; }
        .avatar { 
            width: 100%; height: 100%; border-radius: 50%; 
            background: var(--gradient); display: flex; justify-content: center; align-items: center; 
            font-size: 2.5rem; color: white; border: 3px solid var(--dark); font-weight: 700; 
        }
        .vip-crown { 
            position: absolute; top: -10px; right: -10px; background: var(--gold); 
            width: 32px; height: 32px; border-radius: 50%; display: none; 
            align-items: center; justify-content: center; color: black; font-size: 0.9rem; 
            z-index: 10; border: 2px solid var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .is-vip .vip-crown { display: flex; animation: bounce 2s infinite; }
        .is-vip .avatar { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .user-details h2 { margin-bottom: 5px; font-size: 1.6rem; }
        .rank-badge { 
            display: inline-block; padding: 4px 12px; background: rgba(108,99,255,0.2); 
            color: var(--primary); border-radius: 20px; font-size: 0.8rem; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px;
        }
        
        .xp-progress { width: 100%; max-width: 400px; }
        .xp-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-muted); font-weight: 600; }
        .xp-track { width: 100%; height: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
        .xp-fill { height: 100%; background: var(--gradient); width: 0%; border-radius: 10px; transition: 1s ease cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* --- GRID SYSTEM --- */
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
        
        .content-card { 
            background: var(--glass-bg); border-radius: 20px; padding: 24px; 
            border: var(--glass-border); transition: 0.3s; 
            display: flex; flex-direction: column; position: relative; overflow: hidden; 
        }
        .content-card:hover { 
            transform: translateY(-6px); border-color: var(--secondary); 
            box-shadow: 0 15px 30px -5px rgba(0,0,0,0.3); background: rgba(30, 41, 59, 0.9);
        }
        
        .card-badge { 
            position: absolute; top: 15px; right: 15px; 
            background: rgba(255,46,99,0.15); color: var(--accent); 
            padding: 5px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 800; 
        }
        .card-icon-box {
            width: 60px; height: 60px; border-radius: 16px; 
            background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; font-size: 1.8rem; color: var(--secondary); transition: 0.3s;
        }
        .content-card:hover .card-icon-box { background: var(--secondary); color: white; transform: rotate(5deg); }
        
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; line-height: 1.4; }
        .card-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; }
        .card-meta span { display: flex; align-items: center; gap: 5px; }
        
        .btn-action { 
            width: 100%; padding: 12px; background: var(--gradient); 
            border: none; border-radius: 12px; color: white; font-weight: 700; 
            cursor: pointer; margin-top: auto; font-size: 0.95rem; 
            transition: 0.2s; box-shadow: 0 4px 15px rgba(108,99,255,0.3);
        }
        .btn-action:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(108,99,255,0.5); }
        .btn-action:active { transform: scale(0.98); }
        
        .btn-action.secondary { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); box-shadow: none; }
        .btn-action.secondary:hover { border-color: white; color: white; }

        /* --- TABS UI COMPONENTS --- */
        
        /* Search & Filter */
        .search-container { position: relative; margin-bottom: 25px; }
        .search-container i { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .search-bar { 
            width: 100%; padding: 14px 20px 14px 50px; background: var(--dark-lighter); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; 
            color: white; font-size: 1rem; outline: none; transition: 0.3s;
        }
        .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(108,99,255,0.1); }
        
        .filter-tags { display: flex; gap: 10px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 5px; }
        .filter-tag { 
            padding: 8px 18px; background: rgba(255,255,255,0.05); border-radius: 20px; 
            cursor: pointer; white-space: nowrap; font-size: 0.9rem; font-weight: 600; 
            border: 1px solid transparent; transition: 0.2s;
        }
        .filter-tag:hover { background: rgba(255,255,255,0.1); }
        .filter-tag.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Leaderboard */
        .lb-container { background: var(--dark-lighter); border-radius: 20px; padding: 10px; border: var(--glass-border); }
        .lb-item { 
            display: flex; align-items: center; padding: 16px 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; 
            border-radius: 15px; margin-bottom: 5px;
        }
        .lb-item:hover { background: rgba(255,255,255,0.03); transform: translateX(5px); }
        .lb-rank { width: 40px; font-weight: 800; font-size: 1.2rem; color: var(--text-muted); text-align: center; }
        .lb-rank.top-1 { color: var(--gold); font-size: 1.6rem; text-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .lb-rank.top-2 { color: #E0E0E0; font-size: 1.4rem; }
        .lb-rank.top-3 { color: #CD7F32; font-size: 1.3rem; }
        .lb-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--dark); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; border: 2px solid var(--text-muted); margin: 0 15px;
        }
        .lb-info { flex: 1; }
        .lb-name { font-weight: 600; font-size: 1rem; display: block; }
        .lb-username { font-size: 0.8rem; color: var(--text-muted); }
        .lb-score { font-weight: 800; color: var(--secondary); font-size: 1.1rem; }

        /* Shop Special Cards */
        .content-card.vip-pack { 
            border: 2px solid var(--gold); 
            background: linear-gradient(180deg, rgba(255,215,0,0.05) 0%, rgba(15,23,42,0.8) 100%); 
        }
        .content-card.vip-pack .card-icon-box { background: var(--gold); color: black; box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .price-tag { font-size: 1.2rem; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 6px; margin: 10px 0; }
        .price-tag i { color: var(--gold); }
        .sale-badge { background: #ff4757; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; margin-left: auto; vertical-align: middle; }

        /* --- MODALS & OVERLAYS --- */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px); padding: 20px; 
        }
        .modal.active { display: flex; animation: fadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-content { 
            background: #1e293b; padding: 30px; border-radius: 24px; 
            width: 100%; max-width: 450px; border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative;
            max-height: 80vh; overflow-y: auto;
        }
        .close-modal-btn { position: absolute; top: 20px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .close-modal-btn:hover { color: white; transform: rotate(90deg); }

        /* Notification Panel */
        .notif-panel {
            position: absolute; top: 75px; right: 0; width: 360px; 
            background: #1e293b; border-radius: 16px; 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            z-index: 900; display: none; overflow: hidden; max-height: 450px; overflow-y: auto;
            transform-origin: top right;
        }
        .notif-panel.active { display: block; animation: scaleIn 0.2s ease-out; }
        .notif-header { padding: 15px 20px; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; }
        .notif-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 12px; transition: 0.2s; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .notif-content { font-size: 0.9rem; flex: 1; }
        .notif-time { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; display: block; }

        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Exam Interface */
        #examInterface { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark); z-index: 2000; overflow-y: auto; padding-bottom: 100px; }
        .exam-header { 
            position: sticky; top: 0; left: 0; width: 100%; background: rgba(15,23,42,0.95); 
            backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 2001; 
        }
        .timer-box { font-size: 1.3rem; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 10px; background: rgba(255,46,99,0.1); padding: 8px 20px; border-radius: 50px; border: 1px solid rgba(255,46,99,0.2); }
        .question-container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        .question-card { background: var(--dark-light); padding: 25px; border-radius: 20px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .q-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
        .q-options { display: grid; gap: 10px; }
        .q-option { 
            display: flex; align-items: center; padding: 15px; border-radius: 12px; 
            background: rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .q-option:hover { background: rgba(255,255,255,0.08); }
        .q-option input { margin-right: 15px; accent-color: var(--primary); transform: scale(1.2); }
        
        .btn-submit-exam { 
            position: fixed; bottom: 30px; right: 30px; padding: 15px 30px; 
            background: #00c853; color: white; border: none; border-radius: 50px; 
            font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 20px rgba(0,200,83,0.4); 
            z-index: 2002;
        }

        /* Tabs inside Modal */
        .tab-buttons { display: flex; margin-bottom: 25px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; }
        .tab-btn { 
            flex: 1; padding: 10px; background: none; border: none; color: var(--text-muted); 
            cursor: pointer; font-weight: 600; border-radius: 10px; transition: 0.3s; 
        }
        .tab-btn.active { background: var(--primary); color: white; shadow: 0 2px 10px rgba(108,99,255,0.3); }
        
        .recharge-option { display: none; }
        .recharge-option.active { display: block; animation: fadeIn 0.3s; }
        .input-ticket { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; margin-bottom: 15px; outline: none; }
        .input-ticket:focus { border-color: var(--primary); }

        /* --- MOBILE NAVIGATION --- */
        .mobile-nav { 
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding: 10px 0 calc(10px + var(--safe-bottom)) 0; 
            justify-content: space-around; z-index: 999; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .m-nav-item { 
            background: none; border: none; color: #64748b; 
            font-size: 1.4rem; padding: 8px; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            flex: 1; transition: 0.3s;
        }
        .m-nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .m-nav-item.active i { filter: drop-shadow(0 0 10px var(--primary)); }
        .m-nav-item span { font-size: 0.7rem; font-weight: 600; }

        /* --- RESPONSIVE TWEAKS --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; padding-bottom: 120px; }
            .mobile-nav { display: flex; }
            
            .top-bar { margin-bottom: 25px; }
            #pageTitle { font-size: 1.5rem; }
            .currency-badge { padding: 6px 12px; font-size: 0.9rem; }
            
            .profile-widget { flex-direction: column; text-align: center; padding: 25px; gap: 20px; }
            .avatar-wrapper { width: 80px; height: 80px; }
            .xp-progress { margin: 0 auto; }
            
            .grid-layout { grid-template-columns: 1fr; gap: 20px; }
            .content-card { flex-direction: row; align-items: center; padding: 15px; gap: 15px; }
            .card-icon-box { width: 50px; height: 50px; margin-bottom: 0; flex-shrink: 0; font-size: 1.5rem; }
            .content-card > div:not(.card-icon-box) { flex: 1; }
            .card-meta { margin: 5px 0 10px 0; font-size: 0.8rem; }
            .btn-action { width: auto; padding: 8px 16px; font-size: 0.85rem; margin: 0; }
            .card-tag { top: 10px; right: 10px; font-size: 0.65rem; padding: 3px 8px; }
            
            /* Shop Tweaks Mobile */
            .shop-item .content-card { flex-direction: column; align-items: flex-start; }
            .shop-item .card-icon-box { margin-bottom: 15px; }
            .shop-item .btn-action { width: 100%; }

            .notif-panel { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); width: 92%; max-height: 60vh; }
        }
        
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="bamboo-container">
            <div class="bamboo-leaf l1"></div> <div class="bamboo-leaf l2"></div> <div class="bamboo-leaf l3"></div>
            <div class="bamboo-joint j4"></div> <div class="bamboo-joint j3"></div> <div class="bamboo-joint j2"></div> <div class="bamboo-joint j1"></div>
        </div>
        <p class="loading-text">ƒêang v∆∞∆°n cao...</p>
    </div>

    <div class="wrapper">
        <nav class="sidebar">
            <div class="brand" onclick="window.location.href='home.html'"><i class="fas fa-graduation-cap"></i> HubSchool</div>
            <div class="nav-links">
                <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> T·ªïng Quan</div>
                <div class="nav-item" onclick="switchTab('library')"><i class="fas fa-folder-open"></i> Kho T√†i Li·ªáu</div>
                <div class="nav-item" onclick="switchTab('exam')"><i class="fas fa-file-signature"></i> Thi Th·ª≠</div>
                <div class="nav-item" onclick="switchTab('leaderboard')"><i class="fas fa-trophy"></i> BXH Top 50</div>
                <div class="nav-item" onclick="switchTab('friends')"><i class="fas fa-search"></i> T√¨m B·∫°n</div>
                <div class="nav-item" onclick="switchTab('shop')"><i class="fas fa-store"></i> C·ª≠a H√†ng</div>
                <div class="nav-item" onclick="window.location.href='news.html'"><i class="fas fa-newspaper"></i> B·∫£ng Tin</div>
                <div class="nav-item" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i> H·ªì S∆°</div>
            </div>
            <div class="nav-item" onclick="logout()" style="margin-top: auto; color: var(--accent); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</div>
        </nav>

        <div class="main-content">
            <div class="top-bar">
                <h2 id="pageTitle">T·ªïng Quan</h2>
                <div class="action-group">
                    <div class="notif-btn" onclick="toggleNotifPanel()">
                        <i class="fas fa-bell"></i>
                        <div class="notif-badge" id="notifCount" style="display:none;">0</div>
                    </div>
                    <div class="currency-badge" onclick="openRechargeModal()">
                        <i class="fas fa-coins"></i> <span id="userXu">0</span> <i class="fas fa-plus-circle" style="margin-left:5px;"></i>
                    </div>
                </div>
            </div>

            <div class="notif-panel" id="notifPanel">
                <div class="notif-header">
                    <span>Th√¥ng B√°o</span>
                    <span style="font-size:0.8rem; color:var(--primary); cursor:pointer;">ƒê√£ ƒë·ªçc</span>
                </div>
                <div id="notifList">
                    <div style="padding:30px; text-align:center; color:var(--text-muted);">Kh√¥ng c√≥ th√¥ng b√°o n√†o.</div>
                </div>
            </div>

            <div id="tab-dashboard" class="tab-content">
                <div class="profile-widget" id="profileCard" onclick="window.location.href='profile.html'">
                    <div class="avatar-wrapper">
                        <div class="avatar" id="userAvatar">U</div>
                        <div class="vip-crown"><i class="fas fa-crown"></i></div>
                    </div>
                    <div class="user-details" style="flex:1;">
                        <h2 id="userName">H·ªçc vi√™n</h2>
                        <span class="rank-badge" id="userRankTitle">T·∫≠p S·ª±</span>
                        <p id="userBio" style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 15px;">Ch∆∞a c√≥ ti·ªÉu s·ª≠</p>
                        
                        <div class="xp-progress">
                            <div class="xp-header">
                                <span>LV.<span id="userLv">1</span></span>
                                <span><span id="userXp">0</span> XP</span>
                            </div>
                            <div class="xp-track"><div class="xp-fill" id="xpBar"></div></div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 20px; font-size: 1.3rem;">ƒê·ªÅ xu·∫•t h√¥m nay</h3>
                <div class="grid-layout">
                    <div class="content-card" style="border-color: var(--gold);">
                        <span class="card-badge" style="background: rgba(255, 215, 0, 0.2); color: var(--gold);">HOT</span>
                        <div class="card-icon-box" style="background: var(--gold); color: black;">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div>
                            <h3 class="card-title">To√°n 12 - Cu·ªëi K·ª≥ 1</h3>
                            <div class="card-meta"><span><i class="far fa-file-alt"></i> 40 C√¢u</span><span><i class="far fa-clock"></i> 90 Ph√∫t</span></div>
                        </div>
                        <button class="btn-action" onclick="startExam('math_12_hk1')">L√†m B√†i Ngay</button>
                    </div>
                    <div class="content-card">
                        <div class="card-icon-box">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div>
                            <h3 class="card-title">Thi Th·ª≠ Nhanh</h3>
                            <div class="card-meta"><span><i class="far fa-file-alt"></i> 10 C√¢u</span><span><i class="far fa-clock"></i> 15 Ph√∫t</span></div>
                        </div>
                        <button class="btn-action" onclick="startExam('random')">B·∫Øt ƒê·∫ßu</button>
                    </div>
                </div>
            </div>

            <div id="tab-library" class="tab-content" style="display:none;">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-bar" placeholder="T√¨m ki·∫øm t√†i li·ªáu..." oninput="filterDocs(this.value)">
                </div>
                <div class="filter-tags">
                    <div class="filter-tag active" onclick="filterByTag('all', this)">T·∫•t c·∫£</div>
                    <div class="filter-tag" onclick="filterByTag('To√°n', this)">To√°n</div>
                    <div class="filter-tag" onclick="filterByTag('L√Ω', this)">V·∫≠t L√Ω</div>
                    <div class="filter-tag" onclick="filterByTag('H√≥a', this)">H√≥a H·ªçc</div>
                    <div class="filter-tag" onclick="filterByTag('Anh', this)">Ti·∫øng Anh</div>
                </div>
                <div class="grid-layout" id="libraryContainer"></div>
            </div>

            <div id="tab-exam" class="tab-content" style="display:none;">
                <h3 style="margin-bottom: 20px;">Danh S√°ch ƒê·ªÅ Thi THPTQG</h3>
                <div class="grid-layout" id="examListContainer"></div>
            </div>

            <div id="tab-leaderboard" class="tab-content" style="display:none;">
                <div class="lb-container">
                    <ul class="lb-list" id="lbList"></ul>
                </div>
            </div>

            <div id="tab-friends" class="tab-content" style="display:none;">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-bar" id="friendSearchInput" placeholder="Nh·∫≠p username (vd: nhan_cute)..." onkeypress="if(event.key==='Enter') searchFriend()">
                </div>
                <button class="btn-action" style="width: 100px; margin-bottom: 30px;" onclick="searchFriend()">T√¨m Ki·∫øm</button>
                <div id="friendResult" class="grid-layout"></div>
            </div>

            <div id="tab-shop" class="tab-content" style="display:none;">
                <h3 style="margin-bottom: 20px;">C·ª≠a H√†ng V·∫≠t Ph·∫©m</h3>
                <div class="grid-layout">
                    <div class="content-card vip-pack shop-item">
                        <span class="card-badge" style="background: var(--gold); color: #000;">VIP TU·∫¶N</span>
                        <div class="card-icon-box" style="background: rgba(255,215,0,0.1); color: var(--gold);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h3 class="card-title">H·ªôi Vi√™n (1 Tu·∫ßn)</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted);">Tr·∫£i nghi·ªám ƒë·∫∑c quy·ªÅn VIP.</p>
                            <div class="price-tag"><i class="fas fa-coins"></i> 150</div>
                        </div>
                        <button class="btn-action" onclick="buyItem(150, 'G√≥i VIP 1 Tu·∫ßn', 'vip')">Mua Ngay</button>
                    </div>

                    <div class="content-card vip-pack shop-item">
                        <span class="card-badge" style="background: var(--gold); color: #000;">VIP TH√ÅNG</span>
                        <div class="card-icon-box" style="background: rgba(255,215,0,0.1); color: var(--gold);">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div>
                            <h3 class="card-title">H·ªôi Vi√™n (1 Th√°ng)</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted);">M·ªü kh√≥a m·ªçi ƒë·ªÅ thi, X2 XP.</p>
                            <div class="price-tag"><i class="fas fa-coins"></i> 500</div>
                        </div>
                        <button class="btn-action" onclick="buyItem(500, 'G√≥i VIP 1 Th√°ng', 'vip')">Mua Ngay</button>
                    </div>
                    
                    <div class="content-card vip-pack shop-item" style="border-color: var(--accent);">
                        <span class="card-badge" style="background: var(--accent); color: #fff;">SALE -50%</span>
                        <div class="card-icon-box" style="background: rgba(255,46,99,0.1); color: var(--accent);">
                            <i class="fas fa-gem"></i>
                        </div>
                        <div>
                            <h3 class="card-title">H·ªôi Vi√™n (1 NƒÉm)</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted);">ƒê·∫∑c quy·ªÅn VIP tr·ªçn nƒÉm.</p>
                            <div class="price-tag">
                                <span class="old-price">6000</span> 
                                <i class="fas fa-coins"></i> 3000 
                            </div>
                        </div>
                        <button class="btn-action" style="background: var(--accent);" onclick="buyItem(3000, 'G√≥i VIP 1 NƒÉm', 'vip')">Mua Ngay</button>
                    </div>

                    <div class="content-card shop-item">
                        <div class="card-icon-box"><i class="fas fa-bolt"></i></div>
                        <div>
                            <h3 class="card-title">H·ªìi Ph·ª•c NƒÉng L∆∞·ª£ng</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted);">ƒê·∫ßy l·∫°i thanh nƒÉng l∆∞·ª£ng.</p>
                            <div class="price-tag"><i class="fas fa-coins"></i> 100</div>
                        </div>
                        <button class="btn-action" onclick="buyItem(100, 'H·ªìi Ph·ª•c')">Mua</button>
                    </div>

                    <div class="content-card shop-item">
                        <div class="card-icon-box"><i class="fas fa-palette"></i></div>
                        <div>
                            <h3 class="card-title">ƒê·ªïi M√†u T√™n</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted);">N·ªïi b·∫≠t tr√™n BXH.</p>
                            <div class="price-tag"><i class="fas fa-coins"></i> 300</div>
                        </div>
                        <button class="btn-action" onclick="buyItem(300, 'ƒê·ªïi M√†u T√™n')">Mua</button>
                    </div>
                    </div>
            </div>

        </div>
    </div>

    <div class="mobile-nav">
        <button class="m-nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i><span>Home</span></button>
        <button class="m-nav-item" onclick="switchTab('library')"><i class="fas fa-folder-open"></i><span>T√†i li·ªáu</span></button>
        <button class="m-nav-item" onclick="switchTab('exam')"><i class="fas fa-file-signature"></i><span>Thi th·ª≠</span></button>
        <button class="m-nav-item" onclick="switchTab('friends')"><i class="fas fa-search"></i><span>T√¨m b·∫°n</span></button>
        <button class="m-nav-item" onclick="switchTab('shop')"><i class="fas fa-store"></i><span>Shop</span></button>
    </div>

    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <div class="close-modal-btn" onclick="closeUserProfile()"><i class="fas fa-times"></i></div>
            <div class="avatar" id="upAvatar" style="width:100px; height:100px; margin: 0 auto 20px; font-size:3rem;">U</div>
            <h2 style="text-align:center; font-size:1.5rem; margin-bottom:5px;" id="upName">User Name</h2>
            <p style="text-align:center; color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;" id="upUsername">@username</p>
            <p id="upBio" style="text-align:center; color: #ccc; margin-bottom: 25px; font-size: 0.95rem; line-height:1.5;">...</p>
            <div style="display:flex; justify-content:center; gap:30px; margin-bottom:30px; background:rgba(0,0,0,0.2); padding:15px; border-radius:15px;">
                <div style="text-align:center;"><b id="upLvl" style="display:block; font-size:1.2rem; color:var(--primary);">1</b><span style="font-size:0.8rem; color:var(--text-muted);">Level</span></div>
                <div style="text-align:center;"><b id="upXp" style="display:block; font-size:1.2rem; color:var(--primary);">0</b><span style="font-size:0.8rem; color:var(--text-muted);">XP</span></div>
            </div>
            <button class="btn-action" id="btnAddFriend" onclick="sendFriendRequest()"><i class="fas fa-user-plus"></i> K·∫øt B·∫°n</button>
        </div>
    </div>

    <div id="examInterface">
        <div class="exam-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="quitExam()" style="background:transparent; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <span id="examSubjectName" style="font-weight:700; font-size:1.1rem; margin-left:10px;">To√°n</span>
            </div>
            <div class="timer-box"><i class="fas fa-clock"></i> <span id="examTimer">00:00</span></div>
        </div>
        <div class="question-container" id="questionsList"></div>
        <button class="btn-submit-exam" onclick="submitExam()">N·ªôp B√†i</button>
    </div>

    <div class="modal" id="rechargeModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0;">N·∫°p Xu</h3>
                <i class="fas fa-times" onclick="closeRechargeModal()" style="cursor:pointer; font-size:1.2rem; color:var(--text-muted);"></i>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchRechargeTab('quick')">G√≥i Nhanh</button>
                <button class="tab-btn" onclick="switchRechargeTab('ticket')">Nh·∫≠p Ticket</button>
            </div>
            <div id="recharge-quick" class="recharge-option active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn-action secondary" onclick="recharge(100)">100 Xu <br><small style="font-size:0.7rem; opacity:0.7;">10k</small></button>
                    <button class="btn-action secondary" onclick="recharge(500)">500 Xu <br><small style="font-size:0.7rem; opacity:0.7;">50k</small></button>
                    <button class="btn-action secondary" onclick="recharge(1000)">1000 Xu <br><small style="font-size:0.7rem; opacity:0.7;">100k</small></button>
                    <button class="btn-action" style="background:var(--gold); color:black; border:none;" onclick="recharge(5000)">5000 Xu <br><small style="font-size:0.7rem; opacity:0.7;">500k</small></button>
                </div>
            </div>
            <div id="recharge-ticket" class="recharge-option">
                <input type="text" id="ticketCode" class="input-ticket" placeholder="Nh·∫≠p m√£ t·∫°i ƒë√¢y...">
                <button class="btn-action" onclick="submitTicket()">X√°c Nh·∫≠n</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, orderBy, limit, getDocs, where, addDoc, onSnapshot, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentViewedUser = null;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                
                // 1. K√çCH HO·∫†T L·∫ÆNG NGHE D·ªÆ LI·ªÜU USER REAL-TIME (Thay cho loadUserData c≈©)
                listenToUserData(user.uid); 
                
                // 2. K√çCH HO·∫†T C√ÅC MODULE M·ªöI (Shop, Payment, Noti h·ªá th·ªëng)
                initShopListener();
                initPaymentListener();
                initSystemNotiListener();

                // Gi·ªØ l·∫°i ch·ª©c nƒÉng Friend c≈©
                initNotificationListener(user.uid);
            } else {
                window.location.replace('login.html');
            }
        });

        // ============================================================
        // C√ÅC H√ÄM REAL-TIME M·ªöI
        // ============================================================

        // 1. H√†m nghe User thay ƒë·ªïi (Thay th·∫ø loadUserData c≈©)
        function listenToUserData(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // C·∫≠p nh·∫≠t giao di·ªán
                    document.getElementById('userName').innerText = data.fullname || "H·ªçc vi√™n";
                    if(document.getElementById('userAvatar').childNodes[0]) {
                         document.getElementById('userAvatar').childNodes[0].nodeValue = (data.avatarEmoji || (data.fullname ? data.fullname.charAt(0) : "U")) + " ";
                    }
                    
                    // C·∫¨P NH·∫¨T XU NGAY L·∫¨P T·ª®C
                    document.getElementById('userXu').innerText = data.xu || 0;
                    
                    if (data.isVIP) document.getElementById('profileCard').classList.add('is-vip');

                    // X·ª≠ l√Ω XP Bar
                    const nextLevel = (data.level || 1) * 1000;
                    const percent = Math.min(((data.xp || 0) / nextLevel) * 100, 100);
                    if(document.getElementById('xpBar')) document.getElementById('xpBar').style.width = percent + "%";
                    
                    if(document.getElementById('userLv')) document.getElementById('userLv').innerText = data.level || 1;
                    if(document.getElementById('userXp')) document.getElementById('userXp').innerText = data.xp || 0;

                    // Rank
                    let rankName = "T·∫≠p S·ª±";
                    const lvl = data.level || 1;
                    if (lvl >= 5) rankName = "H·ªçc Gi·∫£";
                    if (lvl >= 10) rankName = "Chuy√™n Gia";
                    if (lvl >= 50) rankName = "Ti·∫øn Sƒ©";
                    document.getElementById('userRankTitle').innerText = rankName;

                    // T·∫Øt m√†n h√¨nh ch·ªù Bamboo
                    const loading = document.getElementById('loadingOverlay');
                    if(loading) { 
                        loading.style.opacity = '0'; 
                        setTimeout(() => loading.style.display = 'none', 500); 
                    }
                }
            });
        }

        // 2. H√†m nghe Shop (Admin th√™m ƒë·ªì -> T·ª± hi·ªán ·ªü ƒë√¢y)
        function initShopListener() {
            const shopContainer = document.querySelector('#tab-shop .grid-layout');
            if(!shopContainer) return;

            onSnapshot(collection(db, "items"), (snapshot) => {
                // T·∫°o container ri√™ng cho ƒë·ªì admin ƒë·ªÉ ko ƒë√® l√™n ƒë·ªì c≈©
                let dynContainer = document.getElementById('dynamic-shop-items');
                if(!dynContainer) {
                    dynContainer = document.createElement('div');
                    dynContainer.id = 'dynamic-shop-items';
                    dynContainer.style.display = 'contents'; // Gi·ªØ grid layout
                    shopContainer.appendChild(dynContainer);
                }

                let html = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    html += `
                        <div class="content-card shop-item">
                            <div class="card-icon-box" style="font-size:2rem;">${item.emoji || 'üì¶'}</div>
                            <div>
                                <h3 class="card-title">${item.name}</h3>
                                <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:5px;">C√≤n l·∫°i: ${item.stock}</p>
                                <div class="price-tag">
                                    ${item.salePrice ? `<span style="text-decoration:line-through;color:grey;font-size:0.8rem;margin-right:5px">${item.price}</span> <span style="color:#FF2E63">${item.salePrice}</span>` : item.price} 
                                    <i class="fas fa-coins" style="color:gold"></i>
                                </div>
                            </div>
                            <button class="btn-action" onclick="buyDynamicItem('${doc.id}', ${item.salePrice || item.price}, '${item.name}')">Mua</button>
                        </div>
                    `;
                });
                dynContainer.innerHTML = html;
            });
        }

        window.buyDynamicItem = async (id, price, name) => {
            const curXu = parseInt(document.getElementById('userXu').innerText);
            if(curXu < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm("Mua " + name + " v·ªõi gi√° " + price + " Xu?")) {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(-price) });
                alert("Mua th√†nh c√¥ng!");
            }
        }

        // 3. H√†m nghe Ng√¢n h√†ng (Hi·ªán QR Code Admin up)
        function initPaymentListener() {
            onSnapshot(collection(db, "payment_info"), (snapshot) => {
                const rechargeTab = document.getElementById('recharge-quick');
                if(!rechargeTab) return;
                
                let bankDiv = document.getElementById('admin-banks');
                if(!bankDiv) {
                    bankDiv = document.createElement('div');
                    bankDiv.id = 'admin-banks';
                    bankDiv.style.marginBottom = '20px';
                    rechargeTab.prepend(bankDiv);
                }

                let html = '<p style="margin-bottom:10px; color:var(--secondary); font-weight:bold;">Th√¥ng tin chuy·ªÉn kho·∫£n:</p>';
                if(snapshot.empty) html = '';

                snapshot.forEach(doc => {
                    const p = doc.data();
                    html += `
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; gap:10px; align-items:center; border:1px solid rgba(255,255,255,0.1);">
                            <img src="${p.qrUrl}" style="width:60px;height:60px;object-fit:cover;background:white;border-radius:5px;" onclick="window.open(this.src)">
                            <div>
                                <div style="font-weight:bold;color:#00e676">${p.bankName}</div>
                                <div style="font-weight:800; font-size:1.1rem; letter-spacing:1px;">${p.number}</div>
                                <div style="font-size:0.8rem;color:#aaa">${p.owner}</div>
                            </div>
                        </div>
                    `;
                });
                bankDiv.innerHTML = html;
            });
        }

        // 4. H√†m nghe Th√¥ng b√°o H·ªá th·ªëng
        function initSystemNotiListener() {
            const q = query(collection(db, "notifications"), orderBy("date", "desc"), limit(5));
            onSnapshot(q, (snapshot) => {
                const notifList = document.getElementById('notifList');
                if(!notifList) return;

                let sysContainer = document.getElementById('sys-notifs');
                if(!sysContainer) {
                    sysContainer = document.createElement('div');
                    sysContainer.id = 'sys-notifs';
                    notifList.prepend(sysContainer); 
                }

                let sysHtml = '';
                snapshot.forEach(doc => {
                    const n = doc.data();
                    sysHtml += `
                        <div class="notif-item" style="background:rgba(108,99,255,0.15); border-left: 3px solid var(--primary);">
                            <div class="notif-avatar" style="background:var(--primary);"><i class="fas fa-bullhorn"></i></div>
                            <div class="notif-content">
                                <strong style="color:white;">${n.title}</strong>
                                <div style="margin-top:2px; color:#ddd;">${n.content}</div>
                            </div>
                        </div>
                    `;
                });
                sysContainer.innerHTML = sysHtml;

                if(!snapshot.empty) {
                    const badge = document.getElementById('notifCount');
                    badge.style.display = 'flex';
                    badge.innerText = '!';
                }
            });
        }

        // ============================================================
        // C√ÅC CH·ª®C NƒÇNG C≈® (GI·ªÆ NGUY√äN)
        // ============================================================

        // NOTIFICATIONS (Friend)
        window.toggleNotifPanel = () => document.getElementById('notifPanel').classList.toggle('active');
        function initNotificationListener(uid) {
            onSnapshot(collection(db, "users", uid, "notifications"), (snapshot) => {
                const list = document.getElementById('notifList');
                // L∆∞u √Ω: Ch·ªâ update ph·∫ßn friend request, kh√¥ng ƒë√® l√™n sys noti
                let friendHtml = "";
                let count = 0;
                snapshot.forEach(doc => {
                    const n = doc.data();
                    count++;
                    if(n.type === 'friend_request') {
                        friendHtml += `<div class="notif-item">
                            <div class="notif-avatar">${n.fromAvatar}</div>
                            <div class="notif-content"><strong>${n.fromName}</strong> ƒë√£ g·ª≠i k·∫øt b·∫°n.
                            <div style="margin-top:8px;display:flex;gap:10px;">
                                <button class="btn-action" style="padding:5px 12px;font-size:0.75rem;border-radius:6px;" onclick="handleRequest('${doc.id}', '${n.fromUid}', true)">Ch·∫•p nh·∫≠n</button>
                                <button class="btn-action secondary" style="padding:5px 12px;font-size:0.75rem;border-radius:6px;" onclick="handleRequest('${doc.id}', '${n.fromUid}', false)">X√≥a</button>
                            </div></div></div>`;
                    }
                });
                
                // T·∫°o div ri√™ng cho friend requests
                let friendContainer = document.getElementById('friend-reqs');
                if(!friendContainer) {
                    friendContainer = document.createElement('div');
                    friendContainer.id = 'friend-reqs';
                    list.appendChild(friendContainer);
                }
                friendContainer.innerHTML = friendHtml;

                const badge = document.getElementById('notifCount');
                if(count > 0) {
                    badge.innerText = count;
                    badge.style.display = 'flex';
                }
            });
        }
        window.handleRequest = async (id, fromUid, accept) => {
            if(accept) alert("ƒê√£ k·∫øt b·∫°n!");
            await deleteDoc(doc(db, "users", currentUser.uid, "notifications", id));
        }

        // FRIENDS
        window.searchFriend = async () => {
            const input = document.getElementById('friendSearchInput').value.trim();
            const container = document.getElementById('friendResult');
            container.innerHTML = '<p style="text-align:center;color:white;">ƒêang t√¨m...</p>';
            if(!input) return;
            const q = query(collection(db, "users"), where("username", "==", input));
            const snapshot = await getDocs(q);
            container.innerHTML = "";
            if(snapshot.empty) container.innerHTML = '<p style="text-align:center;color:var(--accent);">Kh√¥ng t√¨m th·∫•y!</p>';
            else {
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const div = document.createElement('div');
                    div.className = 'content-card';
                    div.onclick = () => openUserProfile(doc.id, u);
                    div.style.cursor = "pointer";
                    div.innerHTML = `
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div class="avatar" style="width:60px;height:60px;font-size:1.5rem;">${u.avatarEmoji || u.fullname.charAt(0)}</div>
                            <div><h3 style="margin:0;font-size:1.1rem;">${u.fullname}</h3><p style="font-size:0.8rem;color:var(--text-muted);">@${u.username}</p></div>
                        </div>
                        <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:0.9rem;">
                            <span>Lv.${u.level || 1}</span>
                            <span>${u.xp || 0} XP</span>
                        </div>`;
                    container.appendChild(div);
                });
            }
        }
        window.openUserProfile = (uid, data) => {
            if(uid === currentUser.uid) return;
            currentViewedUser = uid;
            document.getElementById('upAvatar').innerText = data.avatarEmoji || data.fullname.charAt(0);
            document.getElementById('upName').innerText = data.fullname;
            document.getElementById('upUsername').innerText = "@" + data.username;
            document.getElementById('upBio').innerText = data.bio || "Ch∆∞a c√≥ ti·ªÉu s·ª≠";
            document.getElementById('upLvl').innerText = data.level || 1;
            document.getElementById('upXp').innerText = data.xp || 0;
            document.getElementById('userProfileModal').classList.add('active');
        }
        window.closeUserProfile = () => document.getElementById('userProfileModal').classList.remove('active');
        window.sendFriendRequest = async () => {
            if(!currentViewedUser) return;
            const btn = document.getElementById('btnAddFriend');
            btn.innerText = "ƒêang g·ª≠i...";
            try {
                const mySnap = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(collection(db, "users", currentViewedUser, "notifications"), {
                    type: 'friend_request', fromUid: currentUser.uid, fromName: mySnap.data().fullname,
                    fromAvatar: mySnap.data().avatarEmoji || mySnap.data().fullname.charAt(0),
                    timestamp: new Date().toISOString()
                });
                alert("ƒê√£ g·ª≠i l·ªùi m·ªùi!");
                btn.innerText = "ƒê√£ G·ª≠i"; btn.disabled = true;
            } catch(e) { alert("L·ªói g·ª≠i!"); btn.innerText = "K·∫øt B·∫°n"; }
        }

        // EXAM DATA (Expanded with 12 real exams)
        const EXAM_DATA = [
            // TO√ÅN
            { id: 'math_12_hk1', title: 'To√°n 12 - Cu·ªëi K·ª≥ 1', time: 90, xp: 200, difficulty: 'Kh√≥', questions: [
                {q:"H√†m s·ªë y = x^3 - 3x^2 + 1 ƒë·ªìng bi·∫øn tr√™n kho·∫£ng n√†o?", opts:["(-‚àû; 0) v√† (2; +‚àû)", "(0; 2)", "(-‚àû; 2)", "(2; +‚àû)"], ans:0},
                {q:"Th·ªÉ t√≠ch kh·ªëi lƒÉng tr·ª• c√≥ di·ªán t√≠ch ƒë√°y B v√† chi·ªÅu cao h l√†:", opts:["V = Bh", "V = 1/3 Bh", "V = 3Bh", "V = 1/2 Bh"], ans:0},
                {q:"Nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh 2^x = 8 l√†:", opts:["x = 3", "x = 2", "x = 4", "x = 1"], ans:0},
                {q:"T·∫≠p x√°c ƒë·ªãnh c·ªßa h√†m s·ªë y = log(x-1) l√†:", opts:["(1; +‚àû)", "[1; +‚àû)", "(-‚àû; 1)", "R\\{1}"], ans:0},
                {q:"Cho kh·ªëi n√≥n c√≥ b√°n k√≠nh ƒë√°y r=3, chi·ªÅu cao h=4. Th·ªÉ t√≠ch kh·ªëi n√≥n l√†:", opts:["12œÄ", "36œÄ", "4œÄ", "16œÄ"], ans:0}
            ]},
            { id: 'math_11_trig', title: 'To√°n 11 - L∆∞·ª£ng Gi√°c', time: 45, xp: 120, difficulty: 'TB', questions: [
                {q:"Ph∆∞∆°ng tr√¨nh sin(x) = 1 c√≥ nghi·ªám l√†:", opts:["x = œÄ/2 + k2œÄ", "x = kœÄ", "x = œÄ + k2œÄ", "x = -œÄ/2 + k2œÄ"], ans:0},
                {q:"H√†m s·ªë n√†o sau ƒë√¢y l√† h√†m s·ªë ch·∫µn?", opts:["y = cos(x)", "y = sin(x)", "y = tan(x)", "y = cot(x)"], ans:0},
                {q:"Gi√° tr·ªã l·ªõn nh·∫•t c·ªßa h√†m s·ªë y = 2sin(x) + 1 l√†:", opts:["3", "1", "2", "0"], ans:0}
            ]},

            // V·∫¨T L√ù
            { id: 'phy_12_osc', title: 'V·∫≠t L√Ω 12 - Dao ƒê·ªông', time: 45, xp: 120, difficulty: 'TB', questions: [
                {q:"M·ªôt v·∫≠t dao ƒë·ªông ƒëi·ªÅu h√≤a v·ªõi ph∆∞∆°ng tr√¨nh x = 4cos(2œÄt + œÄ/3) cm. Bi√™n ƒë·ªô dao ƒë·ªông l√†:", opts:["4 cm", "2 cm", "8 cm", "4œÄ cm"], ans:0},
                {q:"C√¥ng th·ª©c t√≠nh chu k·ª≥ con l·∫Øc ƒë∆°n l√†:", opts:["T = 2œÄ‚àö(l/g)", "T = 2œÄ‚àö(g/l)", "T = ‚àö(l/g)", "T = 2œÄ‚àö(m/k)"], ans:0},
                {q:"Khi x·∫£y ra hi·ªán t∆∞·ª£ng c·ªông h∆∞·ªüng c∆° th√¨:", opts:["Bi√™n ƒë·ªô dao ƒë·ªông ƒë·∫°t gi√° tr·ªã c·ª±c ƒë·∫°i", "T·∫ßn s·ªë dao ƒë·ªông b·∫±ng t·∫ßn s·ªë ri√™ng", "C·∫£ A v√† B ƒë·ªÅu ƒë√∫ng", "NƒÉng l∆∞·ª£ng dao ƒë·ªông kh√¥ng ƒë·ªïi"], ans:2}
            ]},
            { id: 'phy_11_elec', title: 'V·∫≠t L√Ω 11 - ƒêi·ªán Tr∆∞·ªùng', time: 30, xp: 80, difficulty: 'D·ªÖ', questions: [
                {q:"ƒê∆°n v·ªã c·ªßa ƒëi·ªán t√≠ch l√†:", opts:["Coulomb (C)", "V√¥n (V)", "Ampe (A)", "Jun (J)"], ans:0},
                {q:"Hai ƒëi·ªán t√≠ch c√πng d·∫•u th√¨:", opts:["ƒê·∫©y nhau", "H√∫t nhau", "Kh√¥ng t√°c d·ª•ng l·ª±c", "H√∫t ho·∫∑c ƒë·∫©y t√πy kho·∫£ng c√°ch"], ans:0}
            ]},

            // H√ìA H·ªåC
            { id: 'chem_12_est', title: 'H√≥a 12 - Este & Lipit', time: 45, xp: 130, difficulty: 'TB', questions: [
                {q:"Ch·∫•t n√†o sau ƒë√¢y l√† este?", opts:["CH3COOC2H5", "CH3COOH", "C2H5OH", "CH3CHO"], ans:0},
                {q:"Th·ªßy ph√¢n este trong m√¥i tr∆∞·ªùng ki·ªÅm ƒë∆∞·ª£c g·ªçi l√† ph·∫£n ·ª©ng:", opts:["X√† ph√≤ng h√≥a", "Tr√°ng g∆∞∆°ng", "Este h√≥a", "Tr√πng ng∆∞ng"], ans:0},
                {q:"C√¥ng th·ª©c t·ªïng qu√°t c·ªßa este no, ƒë∆°n ch·ª©c, m·∫°ch h·ªü l√†:", opts:["CnH2nO2 (n‚â•2)", "CnH2n+2O", "CnH2nO", "CnH2n-2O2"], ans:0}
            ]},

            // SINH H·ªåC
            { id: 'bio_12_gen', title: 'Sinh 12 - Di Truy·ªÅn', time: 40, xp: 110, difficulty: 'TB', questions: [
                {q:"M√£ di truy·ªÅn c√≥ t√≠nh ch·∫•t n√†o sau ƒë√¢y?", opts:["T√≠nh ph·ªï bi·∫øn", "T√≠nh tho√°i h√≥a", "T√≠nh ƒë·∫∑c hi·ªáu", "C·∫£ 3 √Ω tr√™n"], ans:3},
                {q:"ƒê∆°n ph√¢n c·∫•u t·∫°o n√™n ADN l√†:", opts:["Nucleotit", "Axit amin", "Glucoz∆°", "Axit b√©o"], ans:0},
                {q:"Qu√° tr√¨nh nh√¢n ƒë√¥i ADN di·ªÖn ra theo nguy√™n t·∫Øc:", opts:["B·ªï sung v√† b√°n b·∫£o to√†n", "B·ªï sung v√† b·∫£o to√†n", "Khu√¥n m·∫´u", "Ng·∫´u nhi√™n"], ans:0}
            ]},

            // TI·∫æNG ANH
            { id: 'eng_12_gen', title: 'Ti·∫øng Anh 12 - T·ªïng H·ª£p', time: 60, xp: 150, difficulty: 'Kh√≥', questions: [
                {q:"She _______ to school every day.", opts:["goes", "go", "going", "went"], ans:0},
                {q:"If I _______ you, I would study harder.", opts:["were", "am", "was", "have been"], ans:0},
                {q:"Synonym of 'Happy':", opts:["Joyful", "Sad", "Angry", "Bored"], ans:0},
                {q:"I haven't seen him _______ 2010.", opts:["since", "for", "in", "at"], ans:0},
                {q:"He is interested _______ learning English.", opts:["in", "on", "at", "of"], ans:0}
            ]},

            // TIN H·ªåC
            { id: 'it_11_py', title: 'Tin H·ªçc 11 - Python', time: 45, xp: 140, difficulty: 'Kh√≥', questions: [
                {q:"Trong Python, h√†m d√πng ƒë·ªÉ in ra m√†n h√¨nh l√†:", opts:["print()", "cout <<", "System.out.println", "printf"], ans:0},
                {q:"K·∫øt qu·∫£ c·ªßa 10 // 3 trong Python l√†:", opts:["3", "3.333", "1", "3.0"], ans:0},
                {q:"Ki·ªÉu d·ªØ li·ªáu danh s√°ch trong Python g·ªçi l√†:", opts:["List", "Array", "Dictionary", "Tuple"], ans:0}
            ]},
            
            // C√îNG NGH·ªÜ
            { id: 'tech_agri', title: 'CN N√¥ng Nghi·ªáp', time: 30, xp: 90, difficulty: 'D·ªÖ', questions: [
                {q:"Vai tr√≤ c·ªßa r·ª´ng l√†:", opts:["ƒêi·ªÅu h√≤a kh√≠ h·∫≠u", "Cung c·∫•p g·ªó", "Gi·ªØ ƒë·∫•t, gi·ªØ n∆∞·ªõc", "C·∫£ 3 √Ω tr√™n"], ans:3},
                {q:"Ph√¢n b√≥n h·ªØu c∆° c√≥ ƒë·∫∑c ƒëi·ªÉm:", opts:["Hi·ªáu qu·∫£ ch·∫≠m nh∆∞ng b·ªÅn", "Hi·ªáu qu·∫£ nhanh", "D·ªÖ tan", "G√¢y √¥ nhi·ªÖm"], ans:0}
            ]},
            { id: 'tech_ind', title: 'CN C√¥ng Nghi·ªáp', time: 30, xp: 90, difficulty: 'D·ªÖ', questions: [
                {q:"Trong b·∫£n v·∫Ω kƒ© thu·∫≠t, n√©t li·ªÅn ƒë·∫≠m d√πng ƒë·ªÉ v·∫Ω:", opts:["ƒê∆∞·ªùng bao th·∫•y", "ƒê∆∞·ªùng t√¢m", "ƒê∆∞·ªùng k√≠ch th∆∞·ªõc", "ƒê∆∞·ªùng gi√≥ng"], ans:0},
                {q:"V·∫≠t li·ªáu c∆° kh√≠ ph·ªï bi·∫øn nh·∫•t l√†:", opts:["Kim lo·∫°i ƒëen (th√©p, gang)", "Nh·ª±a", "G·ªó", "Cao su"], ans:0}
            ]},

            // GI√ÅO D·ª§C C√îNG D√ÇN / KTPL
            { id: 'civic_12', title: 'GDCD/KTPL 12', time: 40, xp: 100, difficulty: 'TB', questions: [
                {q:"C∆° quan quy·ªÅn l·ª±c nh√† n∆∞·ªõc cao nh·∫•t l√†:", opts:["Qu·ªëc h·ªôi", "Ch√≠nh ph·ªß", "T√≤a √°n", "Vi·ªán ki·ªÉm s√°t"], ans:0},
                {q:"C√¥ng d√¢n c√≥ quy·ªÅn b·∫ßu c·ª≠ khi ƒë·ªß:", opts:["18 tu·ªïi", "21 tu·ªïi", "16 tu·ªïi", "20 tu·ªïi"], ans:0},
                {q:"Nghƒ©a v·ª• qu√¢n s·ª± √°p d·ª•ng cho c√¥ng d√¢n nam t·ª´:", opts:["18 ƒë·∫øn 25 tu·ªïi (ho·∫∑c 27)", "20 ƒë·∫øn 30 tu·ªïi", "17 ƒë·∫øn 25 tu·ªïi", "18 ƒë·∫øn 40 tu·ªïi"], ans:0}
            ]},
            { id: 'civic_10', title: 'Kinh T·∫ø Ph√°p Lu·∫≠t 10', time: 30, xp: 80, difficulty: 'D·ªÖ', questions: [
                {q:"Th·ªã tr∆∞·ªùng l√† n∆°i di·ªÖn ra ho·∫°t ƒë·ªông:", opts:["Mua v√† b√°n", "S·∫£n xu·∫•t", "Ti√™u d√πng", "Qu·∫£n l√Ω"], ans:0},
                {q:"Thu·∫ø l√† ngu·ªìn thu ch·ªß y·∫øu c·ªßa:", opts:["Ng√¢n s√°ch nh√† n∆∞·ªõc", "Doanh nghi·ªáp", "H·ªô gia ƒë√¨nh", "T·ªï ch·ª©c t·ª´ thi·ªán"], ans:0}
            ]}
        ];

        // Init Exam List
        const examList = document.getElementById('examListContainer');
        EXAM_DATA.forEach(exam => {
            const div = document.createElement('div');
            div.className = 'content-card';
            
            // Ch·ªçn icon d·ª±a tr√™n ID m√¥n h·ªçc
            let iconClass = 'fa-book';
            if(exam.id.includes('math')) iconClass = 'fa-square-root-alt';
            else if(exam.id.includes('phy')) iconClass = 'fa-atom';
            else if(exam.id.includes('chem')) iconClass = 'fa-flask';
            else if(exam.id.includes('bio')) iconClass = 'fa-dna';
            else if(exam.id.includes('eng')) iconClass = 'fa-language';
            else if(exam.id.includes('it')) iconClass = 'fa-laptop-code';
            else if(exam.id.includes('tech')) iconClass = 'fa-cogs';
            else if(exam.id.includes('civic')) iconClass = 'fa-balance-scale';

            div.innerHTML = `
                <span class="card-badge">${exam.difficulty}</span>
                <div class="card-icon-box"><i class="fas ${iconClass}"></i></div>
                <h3>${exam.title}</h3>
                <div class="card-meta"><span><i class="fas fa-clock"></i> ${exam.time}p</span> <span><i class="fas fa-star"></i> +${exam.xp} XP</span></div>
                <button class="btn-action" onclick="window.startExam('${exam.id}')">L√†m B√†i</button>`;
            examList.appendChild(div);
        });
        
        // EXAM LOGIC
        let currentExam = null;
        let timerInterval = null;
        let userAnswers = {};

        window.startExam = (id) => {
            const exam = EXAM_DATA.find(e => e.id === id);
            currentExam = exam;
            userAnswers = {};
            document.getElementById('examSubjectName').innerText = exam.title;
            const list = document.getElementById('questionsList');
            list.innerHTML = ""; 
            
            exam.questions.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `<div class="q-title">C√¢u ${i+1}: ${q.q}</div><div class="q-options">${q.opts.map((o, idx) => `<label class="q-option"><input type="radio" name="q${i}" value="${idx}" onchange="window.selectAnswer(${i}, ${idx})"> <span>${o}</span></label>`).join('')}</div>`;
                list.appendChild(card);
            });
            
            document.getElementById('examInterface').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            let timeLeft = exam.time * 60;
            const timerEl = document.getElementById('examTimer');
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                timerEl.innerText = `${m}:${s}`;
                if(timeLeft <= 0) window.submitExam();
            }, 1000);
        }
        
        window.selectAnswer = (qIdx, ansIdx) => { userAnswers[qIdx] = ansIdx; }

        window.quitExam = () => { if(confirm("Tho√°t?")) { clearInterval(timerInterval); document.getElementById('examInterface').style.display='none'; document.body.style.overflow='auto'; } }
        
        window.submitExam = async () => {
            clearInterval(timerInterval);
            let correct = 0;
            currentExam.questions.forEach((q, i) => { if(userAnswers[i] === q.ans) correct++; });
            const xpEarned = Math.floor((correct / currentExam.questions.length) * currentExam.xp);
            
            if(xpEarned > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(xpEarned) });
            }
            
            alert(`K·∫øt qu·∫£: ${correct}/${currentExam.questions.length} c√¢u ƒë√∫ng.\nB·∫°n nh·∫≠n ƒë∆∞·ª£c +${xpEarned} XP!`);
            document.getElementById('examInterface').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // LIBRARY
        const DOCUMENTS = [
            { title: "ƒê·ªÅ thi To√°n 2024", subject: "To√°n", type: "PDF", filename: "toan.pdf" },
            { title: "C√¥ng th·ª©c V·∫≠t L√Ω", subject: "L√Ω", type: "PDF", filename: "ly.pdf" }
        ];
        function renderDocs(data) {
            const container = document.getElementById('libraryContainer');
            container.innerHTML = "";
            data.forEach(d => {
                const div = document.createElement('div');
                div.className = 'content-card';
                div.innerHTML = `
                    <span class="card-badge" style="background:rgba(108,99,255,0.15);color:var(--primary);">${d.type}</span>
                    <div class="card-icon-box"><i class="fas fa-book"></i></div>
                    <h3>${d.title}</h3>
                    <div class="card-meta"><span>${d.subject}</span></div>
                    <button class="btn-action" onclick="alert('T·∫£i ${d.filename}')">T·∫£i Xu·ªëng</button>`;
                container.appendChild(div);
            });
        }
        renderDocs(DOCUMENTS);
        window.filterDocs = (val) => renderDocs(DOCUMENTS.filter(d => d.title.toLowerCase().includes(val.toLowerCase())));
        window.filterByTag = (tag, btn) => {
            document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tag==='all') renderDocs(DOCUMENTS); else renderDocs(DOCUMENTS.filter(d => d.subject === tag));
        }

        // LEADERBOARD
        async function loadLeaderboard() {
            const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(50));
            const snap = await getDocs(q);
            const list = document.getElementById('lbList');
            list.innerHTML = "";
            let rank = 1;
            snap.forEach(doc => {
                const u = doc.data();
                let color = rank===1?'var(--gold)':(rank===2?'silver':(rank===3?'#cd7f32':'var(--text-muted)'));
                list.insertAdjacentHTML('beforeend', `
                    <li class="lb-item">
                        <div class="lb-rank" style="color:${color}">${rank}</div>
                        <div class="lb-user">
                            <div class="lb-avatar">${u.avatarEmoji||u.fullname.charAt(0)}</div>
                            <div>
                                <span class="lb-name">${u.fullname}</span>
                                <span class="lb-username" style="font-size:0.75rem;color:var(--text-muted);">@${u.username}</span>
                            </div>
                        </div>
                        <div class="lb-score">${u.xp} XP</div>
                    </li>`);
                rank++;
            });
        }

        // SHOP
        window.openRechargeModal = () => document.getElementById('rechargeModal').classList.add('active');
        window.closeRechargeModal = () => document.getElementById('rechargeModal').classList.remove('active');
        window.switchRechargeTab = (tab) => {
            document.querySelectorAll('.recharge-option').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`recharge-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }
        window.recharge = async (amount) => {
            if(confirm(`N·∫°p ${amount} Xu?`)) {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(amount) });
                alert("Th√†nh c√¥ng!"); 
                closeRechargeModal();
            }
        }
        window.submitTicket = async () => {
            if(document.getElementById('ticketCode').value === "ONLYADMIN") {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(500) });
                alert("Nh·∫≠n 500 Xu!"); 
                closeRechargeModal();
            } else alert("M√£ sai!");
        }
        window.buyItem = async (price, name, type) => {
            const cur = parseInt(document.getElementById('userXu').innerText);
            if(cur < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm(`Mua ${name}?`)) {
                const updates = { xu: increment(-price) };
                if(type==='vip') updates.isVIP = true;
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                alert("ƒê√£ mua!");
            }
        }

        // NAVIGATION
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tab).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.m-nav-item').forEach(el => el.classList.remove('active'));
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
            
            const titles = { 'dashboard': 'T·ªïng Quan', 'library': 'Kho T√†i Li·ªáu', 'exam': 'Thi Th·ª≠', 'friends': 'T√¨m B·∫°n', 'leaderboard': 'BXH', 'shop': 'C·ª≠a H√†ng' };
            document.getElementById('pageTitle').innerText = titles[tab];
            if(tab === 'leaderboard') loadLeaderboard();
        }
        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>
