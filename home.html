<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dashboard | HighSchool Hub</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2997/2997320.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6C63FF; --secondary: #00D2FF; --accent: #FF2E63;
            --gold: #FFD700; --dark: #0f172a; --dark-light: #1e293b;
            --text: #f1f5f9; --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --card-bg: rgba(30, 41, 59, 0.7);
            --safe-top: env(safe-area-inset-top);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--dark); color: var(--text); overflow-x: hidden; padding-bottom: 80px; }

        /* LOADING */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* LAYOUT */
        .wrapper { display: flex; }
        
        /* SIDEBAR */
        .sidebar {
            width: 260px; height: 100vh; background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid rgba(255,255,255,0.05); padding: 30px 20px;
            position: fixed; display: flex; flex-direction: column; z-index: 100;
        }
        .brand { font-size: 1.8rem; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 50px; display: flex; gap: 10px; align-items: center; }
        .nav-item {
            padding: 16px 20px; margin-bottom: 8px; border-radius: 15px; cursor: pointer;
            color: var(--text-muted); transition: 0.3s; font-weight: 600; display: flex; align-items: center; gap: 15px;
        }
        .nav-item:hover, .nav-item.active { background: rgba(108,99,255,0.15); color: var(--primary); border: 1px solid rgba(108,99,255,0.2); }
        .nav-item i { font-size: 1.2rem; width: 25px; }

        /* CONTENT */
        .main-content { margin-left: 260px; padding: 40px 5%; flex: 1; padding-top: calc(40px + var(--safe-top)); }
        
        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .currency-badge { background: rgba(255,215,0,0.1); border: 1px solid var(--gold); color: var(--gold); padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .currency-badge:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.3); }

        /* PROFILE CARD (Clickable) */
        .profile-card {
            background: linear-gradient(135deg, rgba(108,99,255,0.15), rgba(0,210,255,0.15));
            border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; padding: 30px;
            display: flex; align-items: center; gap: 30px; margin-bottom: 40px; cursor: pointer;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .profile-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 40px rgba(108,99,255,0.2); }
        .profile-card::after { content: 'Ch·ªânh s·ª≠a'; position: absolute; top: 20px; right: 20px; font-size: 0.8rem; color: var(--text-muted); opacity: 0.7; }
        
        .avatar { width: 90px; height: 90px; border-radius: 50%; background: var(--gradient); display: flex; justify-content: center; align-items: center; font-size: 2.5rem; color: white; border: 4px solid var(--dark); font-weight: 700; }
        
        .xp-bar-container { width: 100%; max-width: 400px; margin-top: 10px; }
        .xp-bar-bg { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: var(--gradient); width: 0%; border-radius: 10px; transition: 1s ease; }

        /* SHOP ITEMS (Duolingo Style) */
        .shop-category { font-size: 1.2rem; font-weight: 700; margin: 30px 0 15px 0; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .shop-item {
            background: var(--dark-light); border-radius: 20px; padding: 25px; text-align: center;
            border: 2px solid transparent; transition: 0.3s; position: relative;
        }
        .shop-item:hover { border-color: var(--secondary); background: rgba(0,210,255,0.05); }
        .shop-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); }
        .shop-btn {
            margin-top: 15px; width: 100%; padding: 12px; border-radius: 15px; border: none;
            background: var(--dark); color: var(--gold); font-weight: 700; cursor: pointer;
            box-shadow: 0 4px 0 rgba(255,215,0,0.2); transition: 0.2s; border: 1px solid var(--gold);
        }
        .shop-btn:active { transform: translateY(4px); box-shadow: none; }

        /* MOBILE NAV */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); padding: 10px 20px; justify-content: space-between; z-index: 999; padding-bottom: calc(10px + var(--safe-bottom)); }
        .m-nav-item { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; padding: 10px; cursor: pointer; }
        .m-nav-item.active { color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 20px; padding-bottom: 100px; }
            .profile-card { flex-direction: column; text-align: center; }
            .mobile-nav { display: flex; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner"></div><p style="margin-top:20px;">ƒêang t·∫£i d·ªØ li·ªáu...</p></div>

    <div class="wrapper">
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="brand"><i class="fas fa-rocket"></i> HubSchool</div>
            <div class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> T·ªïng Quan</div>
            <div class="nav-item" onclick="switchTab('shop')"><i class="fas fa-store"></i> C·ª≠a H√†ng</div>
            <div class="nav-item" onclick="window.location.href='news.html'"><i class="fas fa-newspaper"></i> B·∫£ng Tin</div>
            <div class="nav-item" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i> H·ªì S∆°</div>
            <div class="nav-item" onclick="logout()" style="margin-top: auto; color: var(--accent);"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</div>
        </nav>

        <!-- MAIN -->
        <div class="main-content">
            <div class="top-bar">
                <h2 id="pageTitle">T·ªïng Quan</h2>
                <div class="currency-badge">
                    <i class="fas fa-coins"></i> <span id="userXu">0</span>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content">
                <!-- Profile Card (Click to Edit) -->
                <div class="profile-card" onclick="window.location.href='profile.html'">
                    <div class="avatar" id="userAvatar">U</div>
                    <div style="flex:1;">
                        <h2 id="userName">ƒêang t·∫£i...</h2>
                        <p id="userBio" style="color:var(--text-muted); font-size:0.9rem;">Ch∆∞a c√≥ ti·ªÉu s·ª≠</p>
                        <div class="xp-bar-container">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px;">
                                <span>LV.<span id="userLv">1</span></span>
                                <span><span id="userXp">0</span> XP</span>
                            </div>
                            <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar"></div></div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom:20px;">Nhi·ªám V·ª• H√¥m Nay</h3>
                <div class="shop-grid">
                    <div class="shop-item" style="text-align:left; display:flex; align-items:center; gap:15px;">
                        <i class="fas fa-book-open" style="font-size:2rem; color:var(--primary);"></i>
                        <div>
                            <h4>H·ªçc 1 b√†i To√°n</h4>
                            <p style="font-size:0.8rem; color:var(--text-muted);">+50 XP</p>
                        </div>
                        <button onclick="learnTask('To√°n', 50)" style="margin-left:auto; padding:8px 15px; border-radius:10px; border:none; background:var(--primary); color:white; cursor:pointer;">H·ªçc</button>
                    </div>
                    <!-- Th√™m task n·∫øu c·∫ßn -->
                </div>
            </div>

            <!-- SHOP TAB -->
            <div id="tab-shop" class="tab-content" style="display:none;">
                <div class="shop-category">V·∫≠t Ph·∫©m B·ªï Tr·ª£</div>
                <div class="shop-grid">
                    <div class="shop-item">
                        <span class="shop-icon">üßä</span>
                        <h4>ƒê√≥ng BƒÉng Streak</h4>
                        <p style="font-size:0.8rem; color:var(--text-muted);">Gi·ªØ chu·ªói khi ngh·ªâ 1 ng√†y</p>
                        <button class="shop-btn" onclick="buyItem(200, 'Streak Freeze')">200 Xu</button>
                    </div>
                    <div class="shop-item">
                        <span class="shop-icon">‚ö°</span>
                        <h4>X2 Kinh Nghi·ªám</h4>
                        <p style="font-size:0.8rem; color:var(--text-muted);">Nh√¢n ƒë√¥i XP trong 30 ph√∫t</p>
                        <button class="shop-btn" onclick="buyItem(150, 'Double XP')">150 Xu</button>
                    </div>
                    <div class="shop-item">
                        <span class="shop-icon">‚ù§Ô∏è</span>
                        <h4>H·ªìi Ph·ª•c Tim</h4>
                        <p style="font-size:0.8rem; color:var(--text-muted);">ƒê·∫ßy l·∫°i thanh s·ª©c kh·ªèe</p>
                        <button class="shop-btn" onclick="buyItem(100, 'Health Refill')">100 Xu</button>
                    </div>
                </div>

                <div class="shop-category">Trang Ph·ª•c & Giao Di·ªán</div>
                <div class="shop-grid">
                    <div class="shop-item">
                        <span class="shop-icon">üé©</span>
                        <h4>M≈© Ph√π Th·ªßy</h4>
                        <button class="shop-btn" onclick="buyItem(500, 'Wizard Hat')">500 Xu</button>
                    </div>
                    <div class="shop-item">
                        <span class="shop-icon">üï∂Ô∏è</span>
                        <h4>K√≠nh Ng·∫ßu L√≤i</h4>
                        <button class="shop-btn" onclick="buyItem(300, 'Cool Glasses')">300 Xu</button>
                    </div>
                    <div class="shop-item">
                        <span class="shop-icon">üëë</span>
                        <h4>V∆∞∆°ng Mi·ªán V√†ng</h4>
                        <button class="shop-btn" onclick="buyItem(1000, 'Golden Crown')">1000 Xu</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MOBILE NAV -->
    <div class="mobile-nav">
        <button class="m-nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i></button>
        <button class="m-nav-item" onclick="switchTab('shop')"><i class="fas fa-store"></i></button>
        <button class="m-nav-item" onclick="window.location.href='news.html'"><i class="fas fa-newspaper"></i></button>
        <button class="m-nav-item" onclick="window.location.href='profile.html'"><i class="fas fa-user"></i></button>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                loadUserData(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadUserData(uid) {
            const docSnap = await getDoc(doc(db, "users", uid));
            if(docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('userName').innerText = data.fullname || "H·ªçc vi√™n";
                document.getElementById('userAvatar').innerText = (data.fullname || "U").charAt(0).toUpperCase();
                document.getElementById('userXu').innerText = data.xu || 0;
                document.getElementById('userLv').innerText = data.level || 1;
                document.getElementById('userXp').innerText = data.xp || 0;
                document.getElementById('userBio').innerText = data.bio || "Ch∆∞a c√≥ ti·ªÉu s·ª≠";
                
                // XP Bar Logic
                const nextLevel = (data.level || 1) * 1000;
                const percent = Math.min(((data.xp || 0) / nextLevel) * 100, 100);
                document.getElementById('xpBar').style.width = percent + "%";
            }
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(()=>document.getElementById('loadingOverlay').style.display='none', 500);
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            document.getElementById('pageTitle').innerText = tabId === 'shop' ? 'C·ª≠a H√†ng' : 'T·ªïng Quan';
        }

        window.buyItem = async (price, name) => {
            const xu = parseInt(document.getElementById('userXu').innerText);
            if(xu < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm(`Mua ${name} v·ªõi gi√° ${price} Xu?`)) {
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(-price) });
                loadUserData(currentUser.uid); // Reload UI
                alert("Mua th√†nh c√¥ng!");
            }
        }

        window.learnTask = async (subject, xp) => {
            alert(`ƒêang h·ªçc ${subject}...`);
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(xp) });
            loadUserData(currentUser.uid);
            alert(`Ho√†n th√†nh! +${xp} XP`);
        }

        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>
