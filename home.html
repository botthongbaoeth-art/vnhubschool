<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HubSchool Pro | H·ªá Th·ªëng H·ªçc T·∫≠p 2025</title>
    
    <!-- 1. TAILWIND CSS & CONFIG (Gi√∫p giao di·ªán ƒë·∫πp m√† code ng·∫Øn g·ªçn) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { main: '#0f0f1a', sidebar: '#151521', card: '#1e1e2d', hover: '#2a2a3c', border: '#323248' },
                        brand: { primary: '#3699ff', secondary: '#00d2ff', purple: '#8950fc', gold: '#ffa800', danger: '#f64e60', success: '#1bc5bd' }
                    },
                    boxShadow: {
                        'glow-blue': '0 0 15px rgba(54, 153, 255, 0.3)',
                        'glow-gold': '0 0 15px rgba(255, 168, 0, 0.3)',
                    },
                    fontFamily: { sans: ['Montserrat', 'ui-sans-serif', 'system-ui'] }
                }
            }
        }
    </script>

    <!-- 2. ICONS & FONTS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Montserrat', sans-serif; overflow: hidden; }
        
        /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #323248; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3699ff; }

        /* Loader Xoay */
        #loadingOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(54, 153, 255, 0.3); border-radius: 50%; border-top-color: #3699ff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hi·ªáu ·ª©ng k√≠nh m·ªù (Glassmorphism) */
        .glass-panel { background: rgba(30, 30, 45, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .active-nav { background: rgba(54, 153, 255, 0.1); color: #3699ff; border: 1px solid rgba(54, 153, 255, 0.2); }
        
        /* Hi·ªáu ·ª©ng √°nh s√°ng ch·∫°y qua thanh XP */
        .shimmer-effect { position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        
        /* Hi·ªáu ·ª©ng Modal hi·ªán ra */
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: modalIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

        /* CSS cho L·ªãch H·ªçc */
        .calendar-day { transition: all 0.2s; cursor: pointer; border-radius: 8px; position: relative; }
        .calendar-day:hover { background: #2a2a3c; }
        .calendar-day.active { background: #3699ff; color: white; box-shadow: 0 0 10px rgba(54, 153, 255, 0.5); }
        .calendar-day.today { border: 1px solid #3699ff; color: #3699ff; }
        .calendar-day.today.active { color: white; }
        .has-event::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #f64e60; border-radius: 50%; }
        
        /* CSS cho B√†i Thi */
        .question-part-header { color: #3699ff; font-weight: 800; font-size: 1.1rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(54, 153, 255, 0.2); padding-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-dark-main text-gray-300 h-screen flex overflow-hidden selection:bg-brand-primary selection:text-white">

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay">
        <div class="spinner mb-4"></div>
        <p class="text-brand-primary font-bold tracking-widest text-sm uppercase animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>

    <!-- MOBILE OVERLAY (N·ªÅn ƒëen khi m·ªü menu mobile) -->
    <div id="mobileOverlay" class="fixed inset-0 bg-black/60 z-40 hidden backdrop-blur-sm transition-opacity xl:hidden" onclick="toggleMobileNav()"></div>

    <!-- ==================== LEFT SIDEBAR (THANH B√äN TR√ÅI) ==================== -->
    <aside id="mainSidebar" class="w-[260px] bg-dark-sidebar flex flex-col border-r border-dark-border z-50 fixed inset-y-0 left-0 transform -translate-x-full transition-transform duration-300 xl:translate-x-0 xl:static xl:z-20">
        <!-- Logo -->
        <div class="h-20 flex items-center justify-between px-6 border-b border-dark-border/50">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-brand-primary to-brand-purple flex items-center justify-center text-white shadow-glow-blue">
                    <i class="fas fa-graduation-cap text-xl"></i>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight">Hub<span class="text-brand-primary">School</span></h1>
            </div>
            <!-- N√∫t ƒë√≥ng menu tr√™n mobile -->
            <button class="xl:hidden text-gray-400 hover:text-white" onclick="toggleMobileNav()"><i class="fas fa-times text-xl"></i></button>
        </div>

        <!-- Menu Links -->
        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <p class="px-4 text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Menu Ch√≠nh</p>
            <div id="nav-dashboard" class="nav-item active-nav flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer transition-all hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('dashboard')">
                <i class="fas fa-home w-6"></i> <span>T·ªïng Quan</span>
            </div>
            <div id="nav-library" class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('library')">
                <i class="fas fa-folder-open w-6"></i> <span>Kho T√†i Li·ªáu</span>
            </div>
            <div id="nav-exam" class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('exam')">
                <i class="fas fa-file-signature w-6"></i> <span>Thi Th·ª≠</span>
            </div>
            <div id="nav-leaderboard" class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('leaderboard')">
                <i class="fas fa-trophy w-6"></i> <span>B·∫£ng X·∫øp H·∫°ng</span>
            </div>
            <div id="nav-friends" class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('friends')">
                <i class="fas fa-users w-6"></i> <span>T√¨m B·∫°n</span>
            </div>
            <div id="nav-shop" class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-gray-400 hover:bg-dark-hover hover:text-white mb-1" onclick="switchTab('shop')">
                <i class="fas fa-store w-6"></i> <span>C·ª≠a H√†ng</span>
            </div>
            
            <div class="mt-auto border-t border-dark-border/50 pt-4 mt-4">
                <div class="nav-item flex items-center px-4 py-3 rounded-xl font-medium cursor-pointer text-brand-danger hover:bg-brand-danger/10" onclick="logout()">
                    <i class="fas fa-sign-out-alt w-6"></i> <span>ƒêƒÉng Xu·∫•t</span>
                </div>
            </div>
        </nav>
    </aside>

    <!-- ==================== MAIN CONTENT (KHU V·ª∞C CH√çNH) ==================== -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-dark-main">
        
        <!-- Header -->
        <header class="h-20 glass-panel flex items-center justify-between px-6 sticky top-0 z-30 shrink-0">
            <div class="flex items-center gap-4">
                <!-- N√∫t m·ªü menu mobile -->
                <button class="xl:hidden text-white text-xl p-2 hover:bg-white/10 rounded-lg transition" onclick="toggleMobileNav()"><i class="fas fa-bars"></i></button>
                <h2 id="pageTitle" class="text-xl font-bold text-white hidden md:block">T·ªïng Quan</h2>
            </div>
            
            <!-- Khu v·ª±c hi·ªÉn th·ªã Ti·ªÅn & Th√¥ng b√°o -->
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-dark-sidebar border border-brand-gold/30 px-3 py-1.5 rounded-full shadow-glow-gold cursor-pointer hover:scale-105 transition" onclick="openRechargeModal()">
                    <img src="https://cdn-icons-png.flaticon.com/512/11559/11559400.png" class="w-5 h-5 mr-2 animate-bounce">
                    <span id="userXu" class="text-brand-gold font-bold text-sm tracking-wide mr-2">0</span>
                    <i class="fas fa-plus-circle text-brand-gold text-xs"></i>
                </div>
                <button class="relative w-10 h-10 rounded-full bg-dark-hover flex items-center justify-center hover:bg-brand-primary hover:text-white transition-colors text-gray-400" onclick="toggleNotifPanel()">
                    <i class="fas fa-bell"></i>
                    <div id="notifCount" class="absolute top-0 right-0 w-4 h-4 bg-brand-danger text-white text-[10px] font-bold rounded-full flex items-center justify-center hidden">0</div>
                </button>
            </div>
        </header>

        <!-- Dropdown Th√¥ng b√°o -->
        <div id="notifPanel" class="absolute top-20 right-6 w-80 bg-dark-card border border-dark-border rounded-xl shadow-2xl z-50 hidden flex-col max-h-96 overflow-y-auto transform origin-top-right transition-all">
            <div class="p-3 border-b border-dark-border font-bold text-white flex justify-between">
                <span>Th√¥ng B√°o</span> <span class="text-xs text-brand-primary cursor-pointer">ƒê√£ ƒë·ªçc</span>
            </div>
            <div id="notifList" class="flex flex-col">
                <div class="p-4 text-center text-gray-500 text-sm">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>
            </div>
        </div>

        <!-- V√ôNG N·ªòI DUNG CU·ªòN (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth pb-24 md:pb-8">
            
            <!-- TAB: DASHBOARD (Trang ch·ªß) -->
            <div id="tab-dashboard" class="tab-content block max-w-6xl mx-auto space-y-8">
                
                <!-- Profile Banner (Th·∫ª th√¥ng tin c√° nh√¢n l·ªõn) -->
                <div id="profileCard" class="bg-gradient-to-r from-dark-card to-[#232336] rounded-3xl p-6 md:p-8 border border-dark-border relative overflow-hidden shadow-2xl cursor-pointer group" onclick="window.location.href='profile.html'">
                    <div class="absolute right-0 top-0 w-96 h-96 bg-brand-primary/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>
                    <div class="flex flex-col md:flex-row gap-6 relative z-10 items-center md:items-start">
                        <div class="relative">
                            <div class="w-24 h-24 md:w-32 md:h-32 rounded-full p-1 bg-gradient-to-tr from-brand-gold to-brand-primary shadow-lg">
                                <div id="userAvatar" class="w-full h-full rounded-full bg-dark-card flex items-center justify-center text-4xl font-bold text-white overflow-hidden">U</div>
                            </div>
                            <div class="vip-crown absolute -top-2 -right-2 bg-brand-gold text-black w-8 h-8 rounded-full flex items-center justify-center border-2 border-dark-main hidden shadow-lg"><i class="fas fa-crown"></i></div>
                        </div>
                        <div class="flex-1 text-center md:text-left space-y-2 w-full">
                            <div class="flex flex-col md:flex-row items-center gap-3 justify-center md:justify-start">
                                <h2 id="userName" class="text-2xl md:text-3xl font-bold text-white flex items-center gap-2">H·ªçc Vi√™n</h2>
                                <span id="userRankTitle" class="px-3 py-0.5 bg-brand-purple/20 text-brand-purple text-xs font-bold rounded-full border border-brand-purple/20">T·∫≠p S·ª±</span>
                            </div>
                            <p id="userBio" class="text-gray-400 text-sm italic">Ch∆∞a c√≥ ti·ªÉu s·ª≠</p>
                            <!-- Thanh XP -->
                            <div class="bg-dark-main p-3 rounded-xl border border-dark-border mt-4 w-full">
                                <div class="flex justify-between text-xs font-bold mb-1.5">
                                    <span class="text-brand-secondary">Level <span id="userLv">1</span></span>
                                    <span class="text-gray-400"><span id="userXp">0</span> XP</span>
                                </div>
                                <div class="h-2.5 bg-dark-sidebar rounded-full overflow-hidden relative">
                                    <div id="xpBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-brand-primary via-brand-secondary to-brand-purple w-[0%] rounded-full">
                                        <div class="shimmer-effect"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4 √î Th·ªëng K√™ (Sync Real-time) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-primary/50 transition">
                        <i class="fas fa-fire text-brand-danger text-2xl mb-2"></i>
                        <span id="statStreak" class="text-xl font-bold text-white">0</span>
                        <span class="text-xs text-gray-500">Ng√†y li√™n ti·∫øp</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-success/50 transition">
                        <i class="fas fa-check-circle text-brand-success text-2xl mb-2"></i>
                        <span id="statQuestions" class="text-xl font-bold text-white">0</span>
                        <span class="text-xs text-gray-500">B√†i ƒë√£ l√†m</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-gold/50 transition">
                        <i class="fas fa-star text-brand-gold text-2xl mb-2"></i>
                        <span id="statRank" class="text-xl font-bold text-white">--</span>
                        <span class="text-xs text-gray-500">H·∫°ng tu·∫ßn</span>
                     </div>
                     <div class="bg-dark-card p-4 rounded-2xl border border-dark-border flex flex-col items-center justify-center text-center hover:border-brand-purple/50 transition">
                        <i class="fas fa-clock text-brand-purple text-2xl mb-2"></i>
                        <span id="statHours" class="text-xl font-bold text-white">0h</span>
                        <span class="text-xs text-gray-500">Gi·ªù h·ªçc</span>
                     </div>
                </div>

                <!-- ƒê·ªÅ xu·∫•t b√†i h·ªçc -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span class="w-1 h-5 bg-brand-primary rounded-full"></span> ƒê·ªÅ xu·∫•t h√¥m nay</h3>
                    <div id="recommendationContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- JS s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn c√°c ƒë·ªÅ thi v√†o ƒë√¢y -->
                    </div>
                </div>
            </div>

            <!-- TAB: C√ÅC TRANG KH√ÅC (·∫®n m·∫∑c ƒë·ªãnh) -->
            <div id="tab-library" class="tab-content hidden max-w-6xl mx-auto"><h3 class="text-white mb-4">Kho T√†i Li·ªáu</h3><div id="libraryContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
            <div id="tab-exam" class="tab-content hidden max-w-6xl mx-auto"><h3 class="text-white mb-4">Danh S√°ch ƒê·ªÅ Thi</h3><div id="examListContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
            <div id="tab-leaderboard" class="tab-content hidden max-w-4xl mx-auto"><h3 class="text-center text-brand-gold font-bold text-xl mb-6">B·∫£ng X·∫øp H·∫°ng Top 50</h3><div class="bg-dark-card rounded-2xl border border-dark-border p-4"><ul id="lbList" class="space-y-2"></ul></div></div>
            <div id="tab-friends" class="tab-content hidden max-w-4xl mx-auto"><div class="flex gap-2 mb-6"><input type="text" id="friendSearchInput" class="flex-1 bg-dark-card border border-dark-border rounded-xl px-4 py-3 text-white outline-none focus:border-brand-primary" placeholder="T√¨m b·∫°n..."><button class="bg-brand-primary text-white px-6 rounded-xl font-bold" onclick="searchFriend()">T√¨m</button></div><div id="friendResult" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div></div>
            
            <!-- TAB: SHOP (C·ª≠a h√†ng v·∫≠t ph·∫©m) -->
            <div id="tab-shop" class="tab-content hidden max-w-6xl mx-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="shopContainer">
                    <!-- G√≥i VIP (Tƒ©nh) -->
                    <div class="bg-dark-card p-5 rounded-2xl border border-brand-gold flex flex-col items-center text-center relative overflow-hidden group">
                        <div class="absolute inset-0 bg-brand-gold/5"></div>
                        <span class="bg-brand-gold text-black text-xs font-bold px-2 py-1 rounded absolute top-3 right-3">VIP TU·∫¶N</span>
                        <div class="w-16 h-16 bg-brand-gold/20 text-brand-gold rounded-full flex items-center justify-center text-3xl mb-4"><i class="fas fa-star"></i></div>
                        <h3 class="text-lg font-bold text-white">H·ªôi Vi√™n (1 Tu·∫ßn)</h3>
                        <p class="text-xs text-gray-400 mb-4">M·ªü kh√≥a full ƒë·ªÅ thi, X2 XP</p>
                        <div class="mt-auto w-full">
                            <div class="text-brand-gold font-bold text-xl mb-3"><i class="fas fa-coins"></i> 150</div>
                            <button class="w-full py-2 bg-brand-gold text-black font-bold rounded-xl hover:bg-yellow-500" onclick="buyItem(150, 'G√≥i VIP 1 Tu·∫ßn', 'vip')">Mua Ngay</button>
                        </div>
                    </div>
                    <!-- C√°c v·∫≠t ph·∫©m kh√°c s·∫Ω ƒë∆∞·ª£c JS t·∫£i v√†o ƒë√¢y -->
                    <div id="dynamic-shop-items" class="contents"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- ==================== RIGHT SIDEBAR (C·ªòT B√äN PH·∫¢I) ==================== -->
    <aside class="w-[300px] bg-dark-sidebar border-l border-dark-border hidden 2xl:flex flex-col z-20 shrink-0 p-6">
        <!-- L·ªãch H·ªçc T∆∞∆°ng T√°c -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h4 id="calMonthYear" class="font-bold text-white">Th√°ng 12, 2025</h4>
                <div class="flex gap-1">
                    <button class="text-gray-500 hover:text-white p-1"><i class="fas fa-chevron-left"></i></button>
                    <button class="text-gray-500 hover:text-white p-1"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-bold mb-2"><span>CN</span><span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span></div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-400">
                <!-- JS s·∫Ω t·ª± ƒë·ªông t·∫°o ng√†y v√†o ƒë√¢y -->
            </div>
            <!-- Th√¥ng tin s·ª± ki·ªán khi b·∫•m v√†o ng√†y -->
            <div id="calEventInfo" class="mt-4 bg-dark-card p-3 rounded-xl border border-dark-border hidden">
                <h5 class="text-sm font-bold text-white mb-1" id="calSelectedDate">Ng√†y 12/12</h5>
                <div class="space-y-2" id="calEventContent">
                    <!-- N·ªôi dung s·ª± ki·ªán -->
                </div>
            </div>
        </div>

        <!-- BXH Nh·ªè (Sync d·ªØ li·ªáu th·∫≠t) -->
        <div class="flex-1 overflow-y-auto">
            <h4 class="font-bold text-white mb-4 flex justify-between">Top H·ªçc Sinh <span class="text-brand-primary text-xs cursor-pointer hover:underline" onclick="switchTab('leaderboard')">Xem t·∫•t c·∫£</span></h4>
            <div class="space-y-3" id="miniLeaderboardList">
                <p class="text-center text-xs text-gray-500">ƒêang t·∫£i...</p>
            </div>
        </div>
    </aside>

    <!-- ==================== MOBILE NAV BOTTOM (THANH MENU D∆Ø·ªöI CHO ƒêT) ==================== -->
    <div class="fixed bottom-0 left-0 w-full bg-dark-sidebar/95 backdrop-blur border-t border-dark-border p-2 flex justify-around xl:hidden z-40 pb-safe">
        <button class="m-nav-item flex flex-col items-center text-brand-primary p-2" onclick="switchTab('dashboard')"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">Home</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('library')"><i class="fas fa-folder-open text-xl mb-1"></i><span class="text-[10px]">T√†i li·ªáu</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('exam')"><i class="fas fa-file-signature text-xl mb-1"></i><span class="text-[10px]">Thi th·ª≠</span></button>
        <button class="m-nav-item flex flex-col items-center text-gray-500 p-2" onclick="switchTab('shop')"><i class="fas fa-store text-xl mb-1"></i><span class="text-[10px]">Shop</span></button>
    </div>

    <!-- ==================== MODAL (H·ªòP THO·∫†I) & GIAO DI·ªÜN THI ==================== -->
    
    <!-- Giao di·ªán l√†m b√†i thi (Full m√†n h√¨nh) -->
    <div id="examInterface" class="fixed inset-0 z-[100] bg-dark-main hidden flex-col">
        <div class="h-16 bg-dark-card border-b border-dark-border flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="quitExam()" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-xl"></i></button>
                <span id="examSubjectName" class="font-bold text-white text-lg truncate max-w-[200px]">B√†i thi</span>
            </div>
            <div class="bg-brand-danger/10 text-brand-danger px-3 py-1 rounded-full border border-brand-danger/20 font-mono font-bold flex items-center gap-2">
                <i class="far fa-clock"></i> <span id="examTimer">00:00</span>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 pb-24" id="examScrollArea">
            <div id="questionsList" class="max-w-3xl mx-auto space-y-6"></div>
        </div>
        <div class="absolute bottom-0 left-0 w-full p-4 bg-dark-card border-t border-dark-border flex justify-end">
            <button class="bg-brand-success text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-brand-success/30 hover:scale-105 transition" onclick="submitExam()">N·ªôp B√†i</button>
        </div>
    </div>

    <!-- Modal N·∫°p Xu -->
    <div id="rechargeModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-dark-card w-full max-w-md rounded-3xl p-6 border border-dark-border relative modal-animate shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">N·∫°p Xu</h3>
                <button class="text-gray-400 hover:text-white" onclick="closeRechargeModal()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button class="p-4 bg-dark-main border border-dark-border rounded-xl hover:border-brand-primary transition text-left" onclick="recharge(100)">
                    <div class="text-brand-primary font-bold">100 Xu</div><div class="text-xs text-gray-500">10,000ƒë</div>
                </button>
                <button class="p-4 bg-dark-main border border-dark-border rounded-xl hover:border-brand-primary transition text-left" onclick="recharge(500)">
                    <div class="text-brand-primary font-bold">500 Xu</div><div class="text-xs text-gray-500">50,000ƒë</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, orderBy, limit, getDocs, where, addDoc, onSnapshot, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // C·∫•u h√¨nh Firebase (Gi·ªØ nguy√™n)
        const firebaseConfig = {
            apiKey: "AIzaSyDFzSBZjJS5RvCL9Ax7xRrk6q_WsNGkh_s",
            authDomain: "hubschoolvn-db841.firebaseapp.com",
            projectId: "hubschoolvn-db841",
            storageBucket: "hubschoolvn-db841.firebasestorage.app",
            messagingSenderId: "526272140814",
            appId: "1:526272140814:web:ba337306b1d4b4d4af4e5f",
            measurementId: "G-4KD8Z1FGC7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- H√ÄM T·∫†O T√çCH XANH META VERIFIED ---
        const VERIFIED_USERS = ['lenhanzxc', 'lenhanismee'];
        function getVerifiedHtml(username) {
            if (VERIFIED_USERS.includes(username)) {
                // Icon rƒÉng c∆∞a xanh + d·∫•u t√≠ch tr·∫Øng ·ªü gi·ªØa
                return `<span class="relative inline-block ml-1 align-middle" title="Verified">
                    <div class="relative w-4 h-4 flex items-center justify-center">
                        <i class="fas fa-certificate text-blue-500 text-lg absolute"></i>
                        <i class="fas fa-check text-white text-[8px] font-bold relative z-10"></i>
                    </div>
                </span>`;
            }
            return '';
        }

        // --- KH·ªûI T·∫†O & L·∫ÆNG NGHE D·ªÆ LI·ªÜU ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                listenToUserData(user.uid);
                initShopListener();
                loadMiniLeaderboard();
                generateCalendar();
                renderRecommendations();
            } else {
                window.location.replace('login.html');
            }
        });

        // --- 1. ƒê·ªíNG B·ªò D·ªÆ LI·ªÜU USER (REAL-TIME) ---
        function listenToUserData(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Profile Info
                    document.getElementById('userName').innerHTML = (data.fullname || "H·ªçc vi√™n") + getVerifiedHtml(data.username);
                    document.getElementById('userAvatar').innerText = (data.avatarEmoji || (data.fullname ? data.fullname.charAt(0) : "U"));
                    document.getElementById('userXu').innerText = data.xu || 0;
                    
                    // Sync Stats (L·∫•y t·ª´ Firebase)
                    document.getElementById('statStreak').innerText = data.streak || 0;
                    document.getElementById('statQuestions').innerText = data.questionsDone || 0;
                    document.getElementById('statHours').innerText = (data.studyHours || 0).toFixed(1) + 'h';
                    document.getElementById('statRank').innerText = data.rankText || "T·∫≠p s·ª±"; 

                    // XP Bar Logic
                    const nextLevel = (data.level || 1) * 1000;
                    const percent = Math.min(((data.xp || 0) / nextLevel) * 100, 100);
                    if(document.getElementById('xpBar')) document.getElementById('xpBar').style.width = percent + "%";
                    if(document.getElementById('userLv')) document.getElementById('userLv').innerText = data.level || 1;
                    if(document.getElementById('userXp')) document.getElementById('userXp').innerText = data.xp || 0;

                    // K√≠ch ho·∫°t VIP n·∫øu c√≥
                    if (data.isVIP) {
                        document.querySelectorAll('.vip-crown').forEach(el => { el.classList.remove('hidden'); el.style.display = 'flex'; });
                    }

                    document.getElementById('loadingOverlay').style.display = 'none';
                }
            });
        }

        // --- 2. H·ªÜ TH·ªêNG ƒê·ªÄ XU·∫§T (L·ªöP 12 CHU·∫®N 2025) ---
        const EXAM_TYPES = [
            { id: 'math_12_quick', title: 'To√°n 12 - T·ªëc ƒë·ªô', type: 'quick', time: 15, xp: 45, icon: 'fa-square-root-alt', color: 'brand-gold' },
            { id: 'phys_12_mid', title: 'V·∫≠t L√Ω 12 - Gi·ªØa K·ª≥', type: 'midterm', time: 45, xp: 150, icon: 'fa-atom', color: 'brand-primary' },
            { id: 'chem_12_mid', title: 'H√≥a H·ªçc 12 - Gi·ªØa K·ª≥', type: 'midterm', time: 45, xp: 150, icon: 'fa-flask', color: 'brand-purple' },
            { id: 'lit_12_final', title: 'Ng·ªØ VƒÉn 12 - Cu·ªëi K·ª≥', type: 'literature', time: 120, xp: 300, icon: 'fa-feather-alt', color: 'brand-danger' }
        ];

        function renderRecommendations() {
            const container = document.getElementById('recommendationContainer');
            container.innerHTML = EXAM_TYPES.map(exam => `
                <div class="bg-dark-card p-5 rounded-2xl border border-dark-border relative group hover:border-${exam.color} hover:shadow-glow-${exam.color === 'brand-gold' ? 'gold' : 'blue'} transition-all cursor-pointer" onclick="startExam('${exam.id}')">
                    <span class="absolute top-3 right-3 text-[10px] font-bold px-2 py-0.5 rounded bg-gray-700 text-gray-300 uppercase">${exam.type === 'quick' ? 'Nhanh' : (exam.type === 'literature' ? 'T·ª± lu·∫≠n' : 'Gi·ªØa k·ª≥')}</span>
                    <div class="flex gap-4 mb-4">
                        <div class="w-14 h-14 rounded-xl bg-${exam.color}/10 text-${exam.color} flex items-center justify-center text-2xl"><i class="fas ${exam.icon}"></i></div>
                        <div>
                            <h4 class="text-lg font-bold text-white">${exam.title}</h4>
                            <div class="text-xs text-gray-400 mt-1 flex gap-3">
                                <span><i class="far fa-clock"></i> ${exam.time}p</span> 
                                <span><i class="fas fa-star"></i> +${exam.xp} XP</span>
                            </div>
                        </div>
                    </div>
                    <button class="w-full py-2.5 rounded-xl bg-${exam.color} text-white font-bold shadow-lg shadow-${exam.color}/30 text-sm">L√†m B√†i Ngay</button>
                </div>
            `).join('');
        }

        // --- 3. H·ªÜ TH·ªêNG THI C·ª¨ (ƒêA D·∫†NG C√ÇU H·ªéI) ---
        let currentExam = null;
        let timerInterval = null;

        // D·ªØ li·ªáu gi·∫£ l·∫≠p c√¢u h·ªèi (Mock Data)
        const MOCK_QUESTIONS = {
            'math_12_quick': Array.from({length: 20}, (_, i) => ({ type: 'mcq', q: `H√†m s·ªë y = f(x) c√≥ b·∫£ng bi·∫øn thi√™n nh∆∞ h√¨nh. S·ªë nghi·ªám c·ªßa f(x) = ${i}?`, opts: ['1', '2', '3', '4'], ans: 0 })),
            'phys_12_mid': [
                // Ph·∫ßn 1: 20 c√¢u tr·∫Øc nghi·ªám 4 l·ª±a ch·ªçn
                ...Array.from({length: 20}, (_, i) => ({ type: 'mcq', q: `[P1] M·ªôt v·∫≠t dao ƒë·ªông ƒëi·ªÅu h√≤a v·ªõi bi√™n ƒë·ªô A = ${i+2}cm. Qu·ªπ ƒë·∫°o l√†:`, opts: [`${(i+2)*2}cm`, `${i+2}cm`, '0cm', 'V√¥ c√πng'], ans: 0 })),
                // Ph·∫ßn 2: 6 c√¢u ƒê√∫ng Sai (M·ªói c√¢u 4 √Ω nh·ªè)
                ...Array.from({length: 6}, (_, i) => ({ type: 'tf_group', q: `[P2] C√¢u ${i+1}: Cho m·∫°ch ƒëi·ªán R,L,C n·ªëi ti·∫øp. Nh·∫≠n ƒë·ªãnh sau ƒë√¢y ƒë√∫ng hay sai?`, 
                    items: [
                        { text: "ƒêi·ªán √°p t·ª©c th·ªùi u s·ªõm pha h∆°n i", ans: true },
                        { text: "C√¥ng su·∫•t ti√™u th·ª• c·ª±c ƒë·∫°i khi c·ªông h∆∞·ªüng", ans: true },
                        { text: "T·ªïng tr·ªü Z lu√¥n l·ªõn h∆°n R", ans: false },
                        { text: "ƒêi·ªán √°p hi·ªáu d·ª•ng U = U_R + U_L + U_C", ans: false }
                    ]
                })),
                // Ph·∫ßn 3: 4 c√¢u tr·∫£ l·ªùi ng·∫Øn
                ...Array.from({length: 4}, (_, i) => ({ type: 'short', q: `[P3] C√¢u ${i+1}: T√≠nh chu k·ª≥ T (s) bi·∫øt f = ${50+i}Hz. (ƒêi·ªÅn s·ªë th·∫≠p ph√¢n)`, ans: (1/(50+i)).toFixed(2) }))
            ],
            'chem_12_mid': [
                ...Array.from({length: 20}, (_, i) => ({ type: 'mcq', q: `Este X c√≥ CTPT C4H8O2. S·ªë ƒë·ªìng ph√¢n l√†:`, opts: ['2', '3', '4', '5'], ans: 2 })),
                ...Array.from({length: 6}, (_, i) => ({ type: 'tf_group', q: `Ph√°t bi·ªÉu v·ªÅ Cacbohydrat:`, items: [{text:"Glucozo c√≥ tr√°ng b·∫°c", ans:true}, {text:"Saccarozo l√† ƒë∆∞·ªùng ƒë√¥i", ans:true}, {text:"Tinh b·ªôt tan t·ªët trong n∆∞·ªõc l·∫°nh", ans:false}, {text:"Xenlulozo c√≥ c·∫•u tr√∫c m·∫°ch ph√¢n nh√°nh", ans:false}] })),
                ...Array.from({length: 4}, (_, i) => ({ type: 'short', q: `S·ªë nguy√™n t·ª≠ Oxi trong ph√¢n t·ª≠ Glucoz∆° l√†:`, ans: '6' }))
            ],
            'lit_12_final': [
                { type: 'section_header', text: 'I. ƒê·ªåC HI·ªÇU (3.0 ƒëi·ªÉm)' },
                { type: 'mcq', q: 'C√¢u 1: Ph∆∞∆°ng th·ª©c bi·ªÉu ƒë·∫°t ch√≠nh c·ªßa ƒëo·∫°n tr√≠ch?', opts: ['Ngh·ªã lu·∫≠n', 'Bi·ªÉu c·∫£m', 'T·ª± s·ª±', 'Mi√™u t·∫£'], ans: 0 },
                { type: 'mcq', q: 'C√¢u 2: Phong c√°ch ng√¥n ng·ªØ c·ªßa vƒÉn b·∫£n?', opts: ['B√°o ch√≠', 'Ngh·ªá thu·∫≠t', 'Khoa h·ªçc', 'Ch√≠nh lu·∫≠n'], ans: 3 },
                { type: 'short', q: 'C√¢u 3: Ch·ªâ ra bi·ªán ph√°p tu t·ª´ trong c√¢u vƒÉn in ƒë·∫≠m.', ans: '' },
                { type: 'essay_short', q: 'C√¢u 4: Anh/ch·ªã c√≥ ƒë·ªìng t√¨nh v·ªõi √Ω ki·∫øn t√°c gi·∫£ kh√¥ng? V√¨ sao? (Vi·∫øt kho·∫£ng 5-7 d√≤ng)', height: 3 },
                { type: 'section_header', text: 'II. L√ÄM VƒÇN (7.0 ƒëi·ªÉm)' },
                { type: 'essay', q: 'C√¢u 1 (2.0ƒë): Vi·∫øt ƒëo·∫°n vƒÉn (200 ch·ªØ) tr√¨nh b√†y suy nghƒ© v·ªÅ √Ω nghƒ©a c·ªßa vi·ªác s·ªëng c·ªëng hi·∫øn.', height: 6 },
                { type: 'essay', q: 'C√¢u 2 (5.0ƒë): Ph√¢n t√≠ch h√¨nh t∆∞·ª£ng ng∆∞·ªùi l√°i ƒë√≤ trong t√πy b√∫t "Ng∆∞·ªùi l√°i ƒë√≤ S√¥ng ƒê√†" c·ªßa Nguy·ªÖn Tu√¢n.', height: 12 }
            ]
        };

        window.startExam = (id) => {
            const meta = EXAM_TYPES.find(e => e.id === id) || { title: 'B√†i Thi', time: 15, xp: 30 };
            const questions = MOCK_QUESTIONS[id] || MOCK_QUESTIONS['math_12_quick']; 
            currentExam = { ...meta, questions };

            document.getElementById('examSubjectName').innerText = meta.title;
            const list = document.getElementById('questionsList');
            list.innerHTML = "";

            questions.forEach((q, i) => {
                let html = '';
                
                if (q.type === 'section_header') {
                    html = `<div class="text-xl font-bold text-brand-gold mt-6 mb-4 border-b border-gray-700 pb-2">${q.text}</div>`;
                } else {
                    html = `<div class="bg-dark-card p-5 rounded-2xl border border-dark-border mb-4">`;
                    if(q.type !== 'section_header') html += `<div class="font-bold text-white text-md mb-3">${q.q}</div>`;

                    if (q.type === 'mcq') {
                        html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">${q.opts.map((o, idx) => `
                            <label class="flex items-center p-3 rounded-xl bg-dark-main border border-dark-border cursor-pointer hover:bg-dark-hover"><input type="radio" name="q${i}" class="w-5 h-5 accent-brand-primary mr-3"> <span class="text-gray-300 text-sm">${o}</span></label>
                        `).join('')}</div>`;
                    } else if (q.type === 'tf_group') {
                        // True/False Grouped (New Format 2025)
                        html += `<div class="space-y-2">`;
                        q.items.forEach((item, idx) => {
                            html += `
                            <div class="flex items-center justify-between p-3 bg-dark-main rounded-xl border border-dark-border">
                                <span class="text-sm text-gray-300 flex-1 mr-4">${String.fromCharCode(97+idx)}) ${item.text}</span>
                                <div class="flex gap-4 shrink-0">
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="q${i}_${idx}" value="T" class="w-4 h-4 accent-green-500"> <span class="text-xs font-bold text-green-500">ƒê√∫ng</span></label>
                                    <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="q${i}_${idx}" value="F" class="w-4 h-4 accent-red-500"> <span class="text-xs font-bold text-red-500">Sai</span></label>
                                </div>
                            </div>`;
                        });
                        html += `</div>`;
                    } else if (q.type === 'short') {
                        html += `<input type="text" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...">`;
                    } else if (q.type === 'essay' || q.type === 'essay_short') {
                        html += `<textarea rows="${q.height || 5}" class="w-full bg-dark-main border border-dark-border rounded-xl p-3 text-white outline-none focus:border-brand-primary text-sm" placeholder="L√†m b√†i t·∫°i ƒë√¢y..."></textarea>`;
                    }
                    html += `</div>`;
                }
                list.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('examInterface').classList.remove('hidden');
            document.getElementById('examInterface').classList.add('flex');
            startTimer(meta.time * 60);
        }

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            const display = document.getElementById('examTimer');
            clearInterval(timerInterval);
            timerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                display.textContent = minutes + ":" + seconds;
                if (--timer < 0) { window.submitExam(); }
            }, 1000);
        }

        window.submitExam = async () => {
            clearInterval(timerInterval);
            // Mock Grading: Random Score for demo
            const score = (Math.random() * (9.5 - 6.0) + 6.0).toFixed(1); 
            const earnedXP = Math.floor(currentExam.xp * (score/10));
            
            // Sync Stats Update Realtime
            if(currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    xp: increment(earnedXP),
                    questionsDone: increment(20), // Mock count
                    studyHours: increment(currentExam.time / 60) // Add fractions of hours
                });
            }

            alert(`N·ªôp b√†i th√†nh c√¥ng!\nƒêi·ªÉm gi·∫£ l·∫≠p: ${score}/10\nB·∫°n nh·∫≠n ƒë∆∞·ª£c +${earnedXP} XP`);
            document.getElementById('examInterface').classList.add('hidden');
            document.getElementById('examInterface').classList.remove('flex');
        }

        window.quitExam = () => { if(confirm("Tho√°t? K·∫øt qu·∫£ s·∫Ω kh√¥ng l∆∞u.")) { clearInterval(timerInterval); document.getElementById('examInterface').classList.add('hidden'); document.getElementById('examInterface').classList.remove('flex'); } }

        // --- 4. L·ªäCH H·ªåC T∆Ø∆†NG T√ÅC (INTERACTIVE CALENDAR) ---
        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const info = document.getElementById('calEventInfo');
            const dateTitle = document.getElementById('calSelectedDate');
            const eventContent = document.getElementById('calEventContent');
            grid.innerHTML = "";
            
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const startDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();

            // Empty slots
            for(let i=0; i<startDay; i++) grid.innerHTML += `<span></span>`;

            // Days
            for(let i=1; i<=daysInMonth; i++) {
                const isToday = i === today.getDate();
                const div = document.createElement('div');
                div.className = `calendar-day p-1 rounded text-center text-sm ${isToday ? 'today text-brand-primary border border-brand-primary' : 'text-gray-400'}`;
                div.innerText = i;
                
                // Mock events (Ch·∫µn l·∫ª)
                if(i % 2 !== 0 || i === today.getDate()) div.classList.add('has-event');

                div.onclick = () => {
                    document.querySelectorAll('.calendar-day').forEach(el => { el.classList.remove('active', 'bg-brand-primary', 'text-white'); });
                    div.classList.add('active', 'bg-brand-primary', 'text-white');
                    div.classList.remove('text-gray-400');
                    
                    info.classList.remove('hidden');
                    dateTitle.innerText = `L·ªãch h·ªçc ng√†y ${i}/${today.getMonth()+1}`;
                    
                    // Generate Mock Events based on date
                    let eventsHtml = '';
                    if (i % 2 !== 0) {
                        eventsHtml += `
                            <div class="flex items-center gap-2 text-xs text-gray-300"><span class="w-2 h-2 rounded-full bg-brand-danger"></span> 19:30 - Thi th·ª≠ To√°n 12</div>
                            <div class="flex items-center gap-2 text-xs text-gray-300"><span class="w-2 h-2 rounded-full bg-brand-success"></span> 21:00 - N·ªôp b√†i H√≥a</div>
                        `;
                    } else {
                        eventsHtml += `
                            <div class="flex items-center gap-2 text-xs text-gray-300"><span class="w-2 h-2 rounded-full bg-brand-purple"></span> 20:00 - Livestream L√Ω</div>
                        `;
                    }
                    eventContent.innerHTML = eventsHtml;
                };
                grid.appendChild(div);
            }
        }

        // --- 5. SHOP LOGIC (REAL) ---
        function initShopListener() {
            onSnapshot(collection(db, "items"), (snapshot) => {
                let dynContainer = document.getElementById('dynamic-shop-items');
                if(!dynContainer) return;
                let html = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    html += `<div class="bg-dark-card p-5 rounded-2xl border border-dark-border flex flex-col items-center text-center">
                        <div class="w-16 h-16 bg-brand-primary/10 text-brand-primary rounded-full flex items-center justify-center text-3xl mb-4">${item.emoji || 'üì¶'}</div>
                        <h3 class="text-lg font-bold text-white">${item.name}</h3>
                        <p class="text-xs text-gray-400 mb-4">Kho: ${item.stock}</p>
                        <div class="mt-auto w-full">
                            <div class="text-brand-gold font-bold text-xl mb-3">${item.price} <i class="fas fa-coins"></i></div>
                            <button class="w-full py-2 bg-dark-main border border-dark-border text-white font-bold rounded-xl hover:bg-white hover:text-black transition" onclick="buyItem(${item.price}, '${item.name}', 'item')">Mua</button>
                        </div></div>`;
                });
                dynContainer.innerHTML = html;
            });
        }

        window.buyItem = async (price, name, type) => {
            const curXu = parseInt(document.getElementById('userXu').innerText);
            if(curXu < price) return alert("Kh√¥ng ƒë·ªß Xu!");
            if(confirm(`Mua ${name} v·ªõi gi√° ${price} Xu?`)) {
                const updates = { xu: increment(-price) };
                if(type === 'vip') updates.isVIP = true;
                
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                alert("Giao d·ªãch th√†nh c√¥ng!");
            }
        }

        // --- 6. MINI LEADERBOARD SYNC ---
        async function loadMiniLeaderboard() {
            const container = document.getElementById('miniLeaderboardList');
            if(!container) return;
            const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(5));
            onSnapshot(q, (snap) => {
                container.innerHTML = "";
                let rank = 1;
                snap.forEach(doc => {
                    const u = doc.data();
                    let color = rank === 1 ? 'text-brand-gold' : (rank === 2 ? 'text-gray-300' : (rank === 3 ? 'text-orange-500' : 'text-gray-500'));
                    container.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-hover transition">
                            <span class="font-bold w-4 text-center ${color}">${rank}</span>
                            <div class="w-8 h-8 rounded-full bg-dark-main border border-dark-border text-white flex items-center justify-center font-bold text-xs">${u.avatarEmoji||u.fullname.charAt(0)}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-white font-bold truncate flex items-center gap-1">${u.fullname} ${getVerifiedHtml(u.username)}</p>
                                <p class="text-xs text-gray-500">${u.xp} XP</p>
                            </div>
                        </div>`);
                    rank++;
                });
            });
        }

        // --- HELPERS (UI) ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => { el.classList.remove('block'); el.classList.add('hidden'); });
            document.getElementById('tab-' + tab).classList.remove('hidden'); document.getElementById('tab-' + tab).classList.add('block');
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active-nav'); el.classList.add('text-gray-400'); });
            document.getElementById('nav-'+tab).classList.add('active-nav'); document.getElementById('nav-'+tab).classList.remove('text-gray-400');
            const titles = { 'dashboard': 'T·ªïng Quan', 'library': 'Kho T√†i Li·ªáu', 'exam': 'Thi Th·ª≠', 'friends': 'T√¨m B·∫°n', 'leaderboard': 'BXH', 'shop': 'C·ª≠a H√†ng' };
            document.getElementById('pageTitle').innerText = titles[tab];
        };
        window.openRechargeModal = () => { document.getElementById('rechargeModal').classList.remove('hidden'); document.getElementById('rechargeModal').classList.add('flex'); }
        window.closeRechargeModal = () => { document.getElementById('rechargeModal').classList.add('hidden'); document.getElementById('rechargeModal').classList.remove('flex'); }
        window.recharge = async (amount) => { 
            if(confirm(`N·∫°p ${amount} Xu?`)) { 
                await updateDoc(doc(db, "users", currentUser.uid), { xu: increment(amount) }); 
                alert("N·∫°p th√†nh c√¥ng!"); closeRechargeModal(); 
            } 
        }
        window.toggleMobileNav = () => {
            const sb = document.getElementById('mainSidebar'); const ov = document.getElementById('mobileOverlay');
            if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }
        window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');
    </script>
</body>
</html>
